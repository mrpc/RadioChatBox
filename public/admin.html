<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadioChatBox - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
        }

        #logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }

        #logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            margin-bottom: 20px;
            color: #374151;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .login-container h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }

        .error {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #f9fafb;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div id="login-screen" style="display: none;">
        <div class="login-container">
            <h2>üéôÔ∏è Admin Login</h2>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="admin-password" placeholder="Enter admin password">
            </div>
            <button class="btn btn-success" style="width: 100%;" onclick="login()">Login</button>
            <div id="login-error" class="error"></div>
        </div>
    </div>

    <div id="admin-panel" style="display: none;">
        <div class="header">
            <h1>üéôÔ∏è RadioChatBox Admin Panel</h1>
            <button id="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('messages')">Messages</button>
                <button class="tab" onclick="switchTab('users')">Active Users</button>
                <button class="tab" onclick="switchTab('inactive-users')">Inactive Users</button>
                <button class="tab" onclick="switchTab('ip-bans')">IP Bans</button>
                <button class="tab" onclick="switchTab('nickname-bans')">Nickname Bans</button>
                <button class="tab" onclick="switchTab('url-blacklist')">URL Blacklist</button>
                <button class="tab" onclick="switchTab('photos')">Photos</button>
                <button class="tab" onclick="switchTab('settings')">Settings</button>
            </div>

            <!-- Messages Tab -->
            <div id="messages-tab" class="tab-content active">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">Message History</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="flushRedisCache()" style="background: #f59e0b; color: white;">
                                üîÑ Flush Redis Cache
                            </button>
                            <button class="btn" onclick="clearPublicChat()" style="background: #ef4444; color: white;">
                                üóëÔ∏è Clear Public Chat
                            </button>
                        </div>
                    </div>
                    <div id="messages-table"></div>
                    <div class="pagination" id="messages-pagination"></div>
                </div>
            </div>

            <!-- Active Users Tab -->
            <div id="users-tab" class="tab-content">
                <div class="section">
                    <h2>Active Users</h2>
                    <div id="users-table"></div>
                </div>
                <div id="user-details" class="section" style="display: none;">
                    <h2>User Details: <span id="user-details-name"></span></h2>
                    <button class="btn" onclick="closeUserDetails()" style="margin-bottom: 15px;">‚Üê Back to Users</button>
                    <div id="user-details-content"></div>
                </div>
            </div>

            <!-- Inactive Users Tab -->
            <div id="inactive-users-tab" class="tab-content">
                <div class="section" id="inactive-users-section">
                    <h2>Inactive Users</h2>
                    <p style="color: #6b7280; margin-bottom: 15px;">Users who have left the chat or disconnected</p>
                    <div id="inactive-users-table"></div>
                </div>
                <div id="inactive-user-details" class="section" style="display: none;">
                    <h2>User Details: <span id="inactive-user-details-name"></span></h2>
                    <button class="btn" onclick="closeInactiveUserDetails()" style="margin-bottom: 15px;">‚Üê Back to Inactive Users</button>
                    <div id="inactive-user-details-content"></div>
                </div>
            </div>

            <!-- IP Bans Tab -->
            <div id="ip-bans-tab" class="tab-content">
                <div class="section">
                    <h2>Add IP Ban</h2>
                    <div class="form-group">
                        <label>IP Address</label>
                        <input type="text" id="ban-ip-address" placeholder="e.g., 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <input type="text" id="ban-ip-reason" placeholder="Reason for ban">
                    </div>
                    <div class="form-group">
                        <label>Duration (days, leave empty for permanent)</label>
                        <input type="number" id="ban-ip-duration" placeholder="e.g., 7">
                    </div>
                    <button class="btn btn-danger" onclick="banIP()">Ban IP</button>
                </div>

                <div class="section">
                    <h2>Current IP Bans</h2>
                    <div id="ip-bans-table"></div>
                </div>
            </div>

            <!-- Nickname Bans Tab -->
            <div id="nickname-bans-tab" class="tab-content">
                <div class="section">
                    <h2>Add Nickname Ban</h2>
                    <div class="form-group">
                        <label>Nickname</label>
                        <input type="text" id="ban-nickname-name" placeholder="Nickname to ban">
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <input type="text" id="ban-nickname-reason" placeholder="Reason for ban">
                    </div>
                    <button class="btn btn-danger" onclick="banNickname()">Ban Nickname</button>
                </div>

                <div class="section">
                    <h2>Current Nickname Bans</h2>
                    <div id="nickname-bans-table"></div>
                </div>
            </div>

            <!-- URL Blacklist Tab -->
            <div id="url-blacklist-tab" class="tab-content">
                <div class="section">
                    <h2>URL Blacklist Management</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        URLs matching these patterns will be replaced with *** even in private messages. 
                        Use * as a wildcard (e.g., *.badsite.com).
                    </p>
                    
                    <div class="form-group">
                        <label>Add New Pattern</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="new-url-pattern" placeholder="e.g., spam.com or *.badsite.*" style="flex: 1;">
                            <input type="text" id="new-url-description" placeholder="Description (optional)" style="flex: 1;">
                            <button class="btn" onclick="addUrlBlacklist()" style="white-space: nowrap;">Add Pattern</button>
                        </div>
                    </div>
                    
                    <div id="url-blacklist-table"></div>
                </div>
            </div>

            <!-- Photos Tab -->
            <div id="photos-tab" class="tab-content">
                <div class="section">
                    <h2>Uploaded Photos</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        Photos are automatically deleted after 48 hours. Click on username to view all photos by that user.
                    </p>
                    <div id="photos-table"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="section">
                    <h2>General Settings</h2>
                    <div class="form-group">
                        <label>Page Title</label>
                        <input type="text" id="setting-page-title" placeholder="RadioChatBox">
                    </div>
                    <div class="form-group">
                        <label>Color Scheme</label>
                        <select id="setting-color-scheme" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                            <option value="metal">Metal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Chat Mode</label>
                        <select id="setting-chat-mode" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                            <option value="public">Public Room Only</option>
                            <option value="private">Private Messaging Only</option>
                            <option value="both">Public & Private</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-require-profile" style="width: auto;">
                            Require Age & Location on Registration
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-allow-photo-uploads" style="width: auto;">
                            Allow Photo Uploads in Private Messages
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Max Photo Size (MB)</label>
                        <input type="number" id="setting-max-photo-size-mb" placeholder="5" min="1" max="50">
                        <small id="php-max-upload-hint" style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Server maximum: 50 MB
                        </small>
                    </div>
                </div>

                <div class="section">
                    <h2>SEO & Branding</h2>
                    <div class="form-group">
                        <label>Site Title (SEO)</label>
                        <input type="text" id="setting-site-title" placeholder="RadioChatBox - Real-time Chat">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Used in search results and browser tabs
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Meta Description</label>
                        <textarea id="setting-site-description" rows="2" placeholder="Connect with listeners in real-time during your radio show" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            150-160 characters recommended
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Keywords (comma-separated)</label>
                        <input type="text" id="setting-site-keywords" placeholder="radio, chat, live, real-time">
                    </div>
                    <div class="form-group">
                        <label>Brand Name</label>
                        <input type="text" id="setting-brand-name" placeholder="RadioChatBox">
                    </div>
                    <div class="form-group">
                        <label>Brand Color</label>
                        <input type="color" id="setting-brand-color" value="#007bff">
                    </div>
                    <div class="form-group">
                        <label>Logo URL (optional)</label>
                        <input type="url" id="setting-logo-url" placeholder="https://example.com/logo.png">
                        <div style="margin-top: 10px;">
                            <label for="logo-upload" class="btn btn-secondary" style="cursor: pointer; display: inline-block;">
                                üì§ Upload Logo
                            </label>
                            <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="uploadLogo('logo')">
                            <span id="logo-upload-status" style="margin-left: 10px; color: #666;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Favicon URL (optional)</label>
                        <input type="url" id="setting-favicon-url" placeholder="https://example.com/favicon.ico">
                        <div style="margin-top: 10px;">
                            <label for="favicon-upload" class="btn btn-secondary" style="cursor: pointer; display: inline-block;">
                                üì§ Upload Favicon
                            </label>
                            <input type="file" id="favicon-upload" accept="image/*,.ico" style="display: none;" onchange="uploadLogo('favicon')">
                            <span id="favicon-upload-status" style="margin-left: 10px; color: #666;"></span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Analytics Integration</h2>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-analytics-enabled" style="width: auto;">
                            Enable Analytics Tracking
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Analytics Provider</label>
                        <select id="setting-analytics-provider" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                            <option value="">None</option>
                            <option value="ga4">Google Analytics 4 (GA4)</option>
                            <option value="gtm">Google Tag Manager (GTM)</option>
                            <option value="matomo">Matomo / Piwik</option>
                            <option value="custom">Custom Endpoint</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tracking ID (optional)</label>
                        <input type="text" id="setting-analytics-tracking-id" placeholder="G-XXXXXXXXXX or GTM-XXXXXXX">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            For GA4: G-XXXXXXXXXX | For GTM: GTM-XXXXXXX
                        </small>
                    </div>
                    <details style="padding: 12px; background: #f0f9ff; border-radius: 6px; margin-top: 10px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #1e40af;">Tracked Events</summary>
                        <ul style="margin-top: 10px; padding-left: 20px; color: #3730a3; font-size: 13px; line-height: 1.6;">
                            <li>Private chat open/close (with duration)</li>
                            <li>Message sent (public/private)</li>
                            <li>Photo upload (success/failure)</li>
                            <li>User registration & profile updates</li>
                            <li>Session tracking</li>
                            <li>Ad views & clicks</li>
                        </ul>
                    </details>
                </div>

                <div class="section">
                    <h2>Advertisement System</h2>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-ads-enabled" style="width: auto;">
                            Enable Advertisements
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Main Top Ad (HTML/JS)</label>
                        <textarea id="setting-ads-main-top" rows="4" placeholder="<div>Your ad code here</div>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Displayed above chat messages
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Main Bottom Ad (HTML/JS)</label>
                        <textarea id="setting-ads-main-bottom" rows="4" placeholder="<div>Your ad code here</div>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Displayed below chat messages
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Chat Sidebar Ad (HTML/JS)</label>
                        <textarea id="setting-ads-chat-sidebar" rows="4" placeholder="<div>Your ad code here</div>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Displayed next to active users
                        </small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-ads-refresh-enabled" style="width: auto;">
                            Enable Auto-Refresh
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Refresh Interval (seconds)</label>
                        <input type="number" id="setting-ads-refresh-interval" placeholder="30" min="10" max="300">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            How often to reload ad content (10-300 seconds)
                        </small>
                    </div>
                </div>

                <div class="section">
                    <h2>Custom Scripts</h2>
                    <div class="form-group">
                        <label>Header Scripts (injected in &lt;head&gt;)</label>
                        <textarea id="setting-header-scripts" rows="6" placeholder="<script>// Analytics, tracking pixels, etc.</script>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Perfect for Google Analytics, Facebook Pixel, custom CSS
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Body Scripts (injected before &lt;/body&gt;)</label>
                        <textarea id="setting-body-scripts" rows="6" placeholder="<script>// Chatbots, widgets, etc.</script>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Perfect for Intercom, Drift, cookie consent banners
                        </small>
                    </div>
                    <div style="padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                        <strong style="color: #92400e;">‚ö†Ô∏è Warning:</strong>
                        <p style="color: #78350f; font-size: 13px; margin-top: 4px;">
                            Only inject scripts from trusted sources. Malicious code can compromise your chat security.
                        </p>
                    </div>
                </div>

                <div class="section">
                    <h2>Rate Limiting</h2>
                    <div class="form-group">
                        <label>Max Messages per Window</label>
                        <input type="number" id="setting-rate-limit-messages" placeholder="10" min="1">
                    </div>
                    <div class="form-group">
                        <label>Time Window (seconds)</label>
                        <input type="number" id="setting-rate-limit-window" placeholder="60" min="1">
                    </div>
                </div>

                <div class="section">
                    <h2>Admin Password</h2>
                    <div class="form-group">
                        <label>New Password (leave empty to keep current)</label>
                        <input type="password" id="setting-admin-password" placeholder="Enter new password">
                    </div>
                </div>

                <div class="section">
                    <button class="btn btn-success" onclick="saveSettings()" style="width: 100%; font-size: 16px; padding: 12px;">
                        üíæ Save All Settings
                    </button>
                </div>

                <div class="section">
                    <h2>Embed Code</h2>
                    <p style="margin-bottom: 10px; color: #6b7280;">Copy this code to embed the chat on your website:</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <input type="checkbox" id="embed-audio-enabled" checked>
                            <span>Enable audio notifications</span>
                        </label>
                        <button class="btn" onclick="updateEmbedCode()" style="font-size: 14px;">Update Code</button>
                    </div>
                    
                    <textarea id="embed-code" readonly style="width: 100%; height: 120px; font-family: monospace; resize: vertical; font-size: 12px;"></textarea>
                    <button class="btn btn-success" onclick="copyEmbedCode()" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    
                    <details style="margin-top: 15px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #374151;">URL Parameters</summary>
                        <ul style="margin-top: 10px; padding-left: 20px; color: #6b7280; font-size: 14px;">
                            <li><code>audio=true</code> - Enable audio notifications (default)</li>
                            <li><code>audio=false</code> - Disable audio notifications</li>
                        </ul>
                        <p style="margin-top: 10px; color: #6b7280; font-size: 13px;">
                            Example: <code style="background: white; padding: 2px 6px; border-radius: 3px;">https://yoursite.com/?audio=false</code>
                        </p>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('adminToken');

        // Pagination helper function
        function renderPagination(pagination, functionName) {
            if (!pagination || pagination.total_pages <= 1) return '';
            
            const { page, total_pages } = pagination;
            let pages = [];
            
            // Always show first page
            pages.push(1);
            
            // Show pages around current page
            for (let i = Math.max(2, page - 2); i <= Math.min(total_pages - 1, page + 2); i++) {
                if (!pages.includes(i)) pages.push(i);
            }
            
            // Always show last page
            if (!pages.includes(total_pages)) pages.push(total_pages);
            
            return `
                <div class="pagination" style="margin-top: 20px; display: flex; gap: 5px; justify-content: center; align-items: center;">
                    <button 
                        class="btn" 
                        ${page === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} 
                        onclick="${page === 1 ? 'return false' : functionName + '(' + (page - 1) + ')'}">
                        ‚Üê Prev
                    </button>
                    ${pages.map((p, i) => {
                        const prevPage = pages[i - 1];
                        const gap = prevPage && p - prevPage > 1 ? '<span style="padding: 0 5px;">...</span>' : '';
                        return `
                            ${gap}
                            <button 
                                class="btn ${p === page ? 'active' : ''}" 
                                onclick="${functionName}(${p})"
                                style="${p === page ? 'background: #667eea; color: white;' : ''}">
                                ${p}
                            </button>
                        `;
                    }).join('')}
                    <button 
                        class="btn" 
                        ${page === total_pages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} 
                        onclick="${page === total_pages ? 'return false' : functionName + '(' + (page + 1) + ')'}">
                        Next ‚Üí
                    </button>
                    <span style="margin-left: 15px; color: #6b7280; font-size: 14px;">
                        Page ${page} of ${total_pages} (${pagination.total} total)
                    </span>
                </div>
            `;
        }

        // Check authentication on load
        if (authToken) {
            showAdminPanel();
        } else {
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
        }

        function showAdminPanel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadAllData();
        }

        async function login() {
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');
            
            // Test authentication
            try {
                const response = await fetch('/api/admin/messages.php?limit=1', {
                    headers: {
                        'Authorization': `Bearer ${password}`
                    }
                });

                if (response.ok) {
                    authToken = password;
                    localStorage.setItem('adminToken', password);
                    errorDiv.textContent = '';
                    showAdminPanel();
                } else {
                    errorDiv.textContent = 'Invalid password';
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('adminToken');
            showLoginScreen();
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        async function loadAllData() {
            loadMessages();
            loadIPBans();
            loadNicknameBans();
            loadUsers();
            loadInactiveUsers();
            loadSettings();
            loadUrlBlacklist();
            loadPhotos();
        }

        async function clearPublicChat() {
            if (!confirm('Are you sure you want to clear all public chat messages?\n\nThis will hide all messages from users, but they will remain in the database logs for admin viewing.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/clear-chat.php', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Public chat cleared! ${data.deleted_count} messages hidden.`);
                    loadMessages(1); // Reload messages to show updated state
                } else {
                    alert('Failed to clear chat: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to clear chat:', error);
                alert('Failed to clear chat');
            }
        }

        async function flushRedisCache() {
            if (!confirm('Are you sure you want to flush the Redis cache?\n\nThis will:\n- Clear all cached messages (will reload from database)\n- Clear all cached settings\n- Clear all rate limit counters\n- Clear all active user sessions\n\nUsers will need to reconnect.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/flush-redis.php', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Redis cache flushed successfully!\n\nCleared: ${data.keys_cleared} keys`);
                    // Reload data since cache is now empty
                    loadMessages(1);
                    loadUsers();
                    loadSettings();
                } else {
                    alert('Failed to flush Redis: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to flush Redis:', error);
                alert('Failed to flush Redis cache');
            }
        }

        async function loadMessages(page = 1) {
            try {
                const response = await fetch(`/api/admin/messages.php?page=${page}&limit=20`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('messages-table');
                    const pagination = data.pagination;
                    
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Username</th>
                                    <th>Message</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.messages.map(msg => `
                                    <tr>
                                        <td>${new Date(msg.created_at).toLocaleString()}</td>
                                        <td>${escapeHtml(msg.username)}</td>
                                        <td>${escapeHtml(msg.message)}</td>
                                        <td>${msg.ip_address}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${renderPagination(pagination, 'loadMessages')}
                    `;
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        async function loadIPBans() {
            try {
                const response = await fetch('/api/admin/ban-ip.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('ip-bans-table');
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>Reason</th>
                                    <th>Banned At</th>
                                    <th>Expires</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.banned_ips.map(ban => `
                                    <tr>
                                        <td>${ban.ip_address}</td>
                                        <td>${escapeHtml(ban.reason || 'N/A')}</td>
                                        <td>${new Date(ban.banned_at).toLocaleString()}</td>
                                        <td>${ban.banned_until ? new Date(ban.banned_until).toLocaleString() : 'Permanent'}</td>
                                        <td>
                                            <button class="btn btn-success" onclick="unbanIP('${ban.ip_address}')">Unban</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load IP bans:', error);
            }
        }

        async function loadNicknameBans() {
            try {
                const response = await fetch('/api/admin/ban-nickname.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('nickname-bans-table');
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Nickname</th>
                                    <th>Reason</th>
                                    <th>Banned At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.banned_nicknames.map(ban => `
                                    <tr>
                                        <td>${escapeHtml(ban.nickname)}</td>
                                        <td>${escapeHtml(ban.reason || 'N/A')}</td>
                                        <td>${new Date(ban.banned_at).toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-success" onclick="unbanNickname('${escapeHtml(ban.nickname)}')">Unban</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load nickname bans:', error);
            }
        }

        async function banIP() {
            const ipAddress = document.getElementById('ban-ip-address').value;
            const reason = document.getElementById('ban-ip-reason').value;
            const duration = document.getElementById('ban-ip-duration').value;

            try {
                const response = await fetch('/api/admin/ban-ip.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        ip_address: ipAddress,
                        reason: reason,
                        duration_days: duration ? parseInt(duration) : null
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('IP banned successfully');
                    document.getElementById('ban-ip-address').value = '';
                    document.getElementById('ban-ip-reason').value = '';
                    document.getElementById('ban-ip-duration').value = '';
                    loadIPBans();
                } else {
                    alert('Failed to ban IP: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function unbanIP(ipAddress) {
            if (!confirm(`Unban IP ${ipAddress}?`)) return;

            try {
                const response = await fetch('/api/admin/ban-ip.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ ip_address: ipAddress })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('IP unbanned successfully');
                    loadIPBans();
                } else {
                    alert('Failed to unban IP');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function banNickname() {
            const nickname = document.getElementById('ban-nickname-name').value;
            const reason = document.getElementById('ban-nickname-reason').value;

            try {
                const response = await fetch('/api/admin/ban-nickname.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        nickname: nickname,
                        reason: reason
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Nickname banned successfully');
                    document.getElementById('ban-nickname-name').value = '';
                    document.getElementById('ban-nickname-reason').value = '';
                    loadNicknameBans();
                } else {
                    alert('Failed to ban nickname: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function unbanNickname(nickname) {
            if (!confirm(`Unban nickname "${nickname}"?`)) return;

            try {
                const response = await fetch('/api/admin/ban-nickname.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ nickname: nickname })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Nickname unbanned successfully');
                    loadNicknameBans();
                } else {
                    alert('Failed to unban nickname');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/active-users.php');
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('users-table');
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Joined At</th>
                                    <th>Last Heartbeat</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => `
                                    <tr>
                                        <td>${escapeHtml(user.username)}</td>
                                        <td>${new Date(user.joined_at).toLocaleString()}</td>
                                        <td>${new Date(user.last_heartbeat).toLocaleString()}</td>
                                        <td>
                                            <button class="btn" onclick="viewUserDetails(\`${user.username.replace(/`/g, '\\`')}\`)">View Details</button>
                                            <button class="btn btn-danger" onclick="kickUser(\`${user.username.replace(/`/g, '\\`')}\`)">Kick</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        async function viewUserDetails(username) {
            try {
                const response = await fetch(`/api/admin/user-details.php?username=${encodeURIComponent(username)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const user = data.user;
                    document.getElementById('user-details-name').textContent = username;
                    
                    let profileHtml = '';
                    if (user.profile) {
                        profileHtml = `
                            <h3>Profile</h3>
                            <p><strong>Age:</strong> ${escapeHtml(user.profile.age || 'N/A')}</p>
                            <p><strong>Sex:</strong> ${escapeHtml(user.profile.sex || 'N/A')}</p>
                            <p><strong>Location:</strong> ${escapeHtml(user.profile.location || 'N/A')}</p>
                        `;
                    }

                    let ipHtml = '<h3>IP Addresses</h3><ul>';
                    user.ip_addresses.forEach(ip => {
                        ipHtml += `<li>${ip.ip_address} - ${new Date(ip.first_seen).toLocaleString()}</li>`;
                    });
                    ipHtml += '</ul>';

                    let messagesHtml = `<h3>Recent Messages (${user.total_messages} total)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    user.messages.slice(0, 20).forEach(msg => {
                        messagesHtml += `
                            <tr>
                                <td>${new Date(msg.created_at).toLocaleString()}</td>
                                <td>${escapeHtml(msg.message)}</td>
                            </tr>
                        `;
                    });
                    messagesHtml += '</tbody></table>';
                    
                    // Private messages - show as conversation list
                    let privateMessagesHtml = '<h3>Private Conversations</h3>';
                    if (user.private_messages && user.private_messages.length > 0) {
                        // Group by conversation partner
                        const conversations = {};
                        user.private_messages.forEach(msg => {
                            const partner = msg.from_username === username ? msg.to_username : msg.from_username;
                            if (!conversations[partner]) {
                                conversations[partner] = [];
                            }
                            conversations[partner].push(msg);
                        });
                        
                        privateMessagesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
                        Object.keys(conversations).forEach(partner => {
                            const count = conversations[partner].length;
                            privateMessagesHtml += `
                                <button class="btn" onclick="viewConversation('${escapeHtml(username)}', '${escapeHtml(partner)}')">
                                    üí¨ ${escapeHtml(partner)} (${count})
                                </button>
                            `;
                        });
                        privateMessagesHtml += '</div>';
                        privateMessagesHtml += '<div id="conversation-thread" style="display: none;"></div>';
                    } else {
                        privateMessagesHtml += '<p>No private messages</p>';
                    }

                    document.getElementById('user-details-content').innerHTML = 
                        profileHtml + ipHtml + messagesHtml + privateMessagesHtml;
                    
                    // Store private messages data for conversation viewing
                    window.currentUserPrivateMessages = user.private_messages || [];
                    
                    // Hide active users table and show details
                    const usersTable = document.getElementById('users-table');
                    if (usersTable && usersTable.parentElement) {
                        usersTable.parentElement.style.display = 'none';
                    }
                    
                    document.getElementById('user-details').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load user details:', error);
                alert('Failed to load user details');
            }
        }

        function closeUserDetails() {
            document.getElementById('user-details').style.display = 'none';
            const usersTable = document.getElementById('users-table');
            if (usersTable && usersTable.parentElement) {
                usersTable.parentElement.style.display = 'block';
            }
        }

        async function viewInactiveUserDetails(username) {
            try {
                const response = await fetch(`/api/admin/user-details.php?username=${encodeURIComponent(username)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const user = data.user;
                    document.getElementById('inactive-user-details-name').textContent = username;
                    
                    let profileHtml = '';
                    if (user.profile) {
                        profileHtml = `
                            <h3>Profile</h3>
                            <p><strong>Age:</strong> ${escapeHtml(user.profile.age || 'N/A')}</p>
                            <p><strong>Sex:</strong> ${escapeHtml(user.profile.sex || 'N/A')}</p>
                            <p><strong>Location:</strong> ${escapeHtml(user.profile.location || 'N/A')}</p>
                        `;
                    }

                    let ipHtml = '<h3>IP Addresses</h3><ul>';
                    user.ip_addresses.forEach(ip => {
                        ipHtml += `<li>${ip.ip_address} - ${new Date(ip.first_seen).toLocaleString()}</li>`;
                    });
                    ipHtml += '</ul>';

                    let messagesHtml = `<h3>Recent Messages (${user.total_messages} total)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    user.messages.slice(0, 20).forEach(msg => {
                        messagesHtml += `
                            <tr>
                                <td>${new Date(msg.created_at).toLocaleString()}</td>
                                <td>${escapeHtml(msg.message)}</td>
                            </tr>
                        `;
                    });
                    messagesHtml += '</tbody></table>';
                    
                    // Private messages - show as conversation list
                    let privateMessagesHtml = '<h3>Private Conversations</h3>';
                    if (user.private_messages && user.private_messages.length > 0) {
                        // Group by conversation partner
                        const conversations = {};
                        user.private_messages.forEach(msg => {
                            const partner = msg.from_username === username ? msg.to_username : msg.from_username;
                            if (!conversations[partner]) {
                                conversations[partner] = [];
                            }
                            conversations[partner].push(msg);
                        });
                        
                        privateMessagesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
                        Object.keys(conversations).forEach(partner => {
                            const count = conversations[partner].length;
                            privateMessagesHtml += `
                                <button class="btn" onclick="viewConversation('${escapeHtml(username)}', '${escapeHtml(partner)}')">
                                    üí¨ ${escapeHtml(partner)} (${count})
                                </button>
                            `;
                        });
                        privateMessagesHtml += '</div>';
                        privateMessagesHtml += '<div id="conversation-thread" style="display: none;"></div>';
                    } else {
                        privateMessagesHtml += '<p>No private messages</p>';
                    }

                    document.getElementById('inactive-user-details-content').innerHTML = 
                        profileHtml + ipHtml + messagesHtml + privateMessagesHtml;
                    
                    // Store private messages data for conversation viewing
                    window.currentUserPrivateMessages = user.private_messages || [];
                    
                    document.getElementById('inactive-users-section').style.display = 'none';
                    document.getElementById('inactive-user-details').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load user details:', error);
                alert('Failed to load user details');
            }
        }

        function closeInactiveUserDetails() {
            document.getElementById('inactive-user-details').style.display = 'none';
            document.getElementById('inactive-users-section').style.display = 'block';
        }
        
        function viewConversation(user1, user2) {
            // Find the conversation thread in the currently visible section
            let thread = null;
            const activeDetails = document.getElementById('user-details');
            const inactiveDetails = document.getElementById('inactive-user-details');
            
            if (activeDetails && activeDetails.style.display !== 'none') {
                thread = activeDetails.querySelector('#conversation-thread');
            } else if (inactiveDetails && inactiveDetails.style.display !== 'none') {
                thread = inactiveDetails.querySelector('#conversation-thread');
            }
            
            if (!thread || !window.currentUserPrivateMessages) return;
            
            // Filter messages for this conversation
            const conversationMessages = window.currentUserPrivateMessages.filter(msg => 
                (msg.from_username === user1 && msg.to_username === user2) ||
                (msg.from_username === user2 && msg.to_username === user1)
            ).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            let html = `
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0;">üí¨ Conversation: ${escapeHtml(user1)} ‚Üî ${escapeHtml(user2)}</h4>
                        <button class="btn" onclick="closeConversation()">‚úï Close</button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 6px;">
            `;
            
            conversationMessages.forEach(msg => {
                const isSentByUser1 = msg.from_username === user1;
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: ${isSentByUser1 ? '#eff6ff' : '#f3f4f6'}; border-radius: 6px; border-left: 3px solid ${isSentByUser1 ? '#667eea' : '#9ca3af'};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong style="color: ${isSentByUser1 ? '#667eea' : '#1f2937'};">${escapeHtml(msg.from_username)}</strong>
                            <small style="color: #6b7280;">${new Date(msg.created_at).toLocaleString()}</small>
                        </div>
                        <div style="color: #374151;">${escapeHtml(msg.message)}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            thread.innerHTML = html;
            thread.style.display = 'block';
        }
        
        function closeConversation() {
            // Find and close the conversation thread in whichever section is visible
            const threads = document.querySelectorAll('#conversation-thread');
            threads.forEach(thread => {
                thread.style.display = 'none';
                thread.innerHTML = '';
            });
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/settings.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('setting-page-title').value = settings.page_title || 'RadioChatBox';
                    document.getElementById('setting-color-scheme').value = settings.color_scheme || 'dark';
                    document.getElementById('setting-chat-mode').value = settings.chat_mode || 'public';
                    document.getElementById('setting-require-profile').checked = settings.require_profile === 'true';
                    document.getElementById('setting-allow-photo-uploads').checked = settings.allow_photo_uploads === 'true';
                    
                    // Set photo size with PHP limit
                    const photoSizeInput = document.getElementById('setting-max-photo-size-mb');
                    const phpMaxUpload = settings.php_max_upload_mb || 50;
                    photoSizeInput.max = phpMaxUpload;
                    photoSizeInput.value = settings.max_photo_size_mb || '5';
                    
                    // Update hint text
                    const hintElement = document.getElementById('php-max-upload-hint');
                    if (hintElement) {
                        hintElement.textContent = `Server maximum: ${phpMaxUpload} MB`;
                    }
                    
                    document.getElementById('setting-rate-limit-messages').value = settings.rate_limit_messages || '10';
                    document.getElementById('setting-rate-limit-window').value = settings.rate_limit_window || '60';
                    
                    // Load SEO & Branding settings
                    document.getElementById('setting-site-title').value = settings.site_title || '';
                    document.getElementById('setting-site-description').value = settings.site_description || '';
                    document.getElementById('setting-site-keywords').value = settings.site_keywords || '';
                    document.getElementById('setting-brand-name').value = settings.brand_name || 'RadioChatBox';
                    document.getElementById('setting-brand-color').value = settings.brand_color || '#007bff';
                    document.getElementById('setting-logo-url').value = settings.logo_url || '';
                    document.getElementById('setting-favicon-url').value = settings.favicon_url || '';
                    
                    // Load Analytics settings
                    document.getElementById('setting-analytics-enabled').checked = settings.analytics_enabled === 'true';
                    document.getElementById('setting-analytics-provider').value = settings.analytics_provider || '';
                    document.getElementById('setting-analytics-tracking-id').value = settings.analytics_tracking_id || '';
                    
                    // Load Advertisement settings
                    document.getElementById('setting-ads-enabled').checked = settings.ads_enabled === 'true';
                    document.getElementById('setting-ads-main-top').value = settings.ads_main_top || '';
                    document.getElementById('setting-ads-main-bottom').value = settings.ads_main_bottom || '';
                    document.getElementById('setting-ads-chat-sidebar').value = settings.ads_chat_sidebar || '';
                    document.getElementById('setting-ads-refresh-enabled').checked = settings.ads_refresh_enabled === 'true';
                    document.getElementById('setting-ads-refresh-interval').value = settings.ads_refresh_interval || '30';
                    
                    // Load Custom Scripts
                    document.getElementById('setting-header-scripts').value = settings.header_scripts || '';
                    document.getElementById('setting-body-scripts').value = settings.body_scripts || '';
                    
                    // Generate embed code
                    updateEmbedCode();
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        async function uploadLogo(type) {
            const inputId = type === 'favicon' ? 'favicon-upload' : 'logo-upload';
            const statusId = type === 'favicon' ? 'favicon-upload-status' : 'logo-upload-status';
            const urlInputId = type === 'favicon' ? 'setting-favicon-url' : 'setting-logo-url';
            
            const fileInput = document.getElementById(inputId);
            const statusSpan = document.getElementById(statusId);
            const urlInput = document.getElementById(urlInputId);
            
            if (!fileInput.files || !fileInput.files[0]) {
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('File too large. Maximum size is 2MB.');
                fileInput.value = '';
                return;
            }
            
            statusSpan.textContent = 'Uploading...';
            statusSpan.style.color = '#666';
            
            try {
                const formData = new FormData();
                formData.append('logo', file);
                formData.append('type', type);
                
                const response = await fetch('/api/admin/upload-logo.php', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    urlInput.value = data.url;
                    statusSpan.textContent = '‚úì Uploaded';
                    statusSpan.style.color = '#10b981';
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    // Clear status after 3 seconds
                    setTimeout(() => {
                        statusSpan.textContent = '';
                    }, 3000);
                } else {
                    statusSpan.textContent = '‚úó Failed: ' + (data.error || 'Unknown error');
                    statusSpan.style.color = '#ef4444';
                }
            } catch (error) {
                statusSpan.textContent = '‚úó Error: ' + error.message;
                statusSpan.style.color = '#ef4444';
            }
        }

        async function saveSettings() {
            // Validate photo size before submitting
            const photoSizeInput = document.getElementById('setting-max-photo-size-mb');
            const photoSize = parseInt(photoSizeInput.value);
            const maxAllowed = parseInt(photoSizeInput.max);
            
            if (photoSize > maxAllowed) {
                alert(`Photo size cannot exceed ${maxAllowed}MB (PHP server limit)`);
                return;
            }
            
            if (photoSize < 1) {
                alert('Photo size must be at least 1MB');
                return;
            }
            
            const settings = {
                page_title: document.getElementById('setting-page-title').value,
                color_scheme: document.getElementById('setting-color-scheme').value,
                chat_mode: document.getElementById('setting-chat-mode').value,
                require_profile: document.getElementById('setting-require-profile').checked ? 'true' : 'false',
                allow_photo_uploads: document.getElementById('setting-allow-photo-uploads').checked ? 'true' : 'false',
                max_photo_size_mb: document.getElementById('setting-max-photo-size-mb').value,
                rate_limit_messages: document.getElementById('setting-rate-limit-messages').value,
                rate_limit_window: document.getElementById('setting-rate-limit-window').value,
                
                // SEO & Branding
                site_title: document.getElementById('setting-site-title').value,
                site_description: document.getElementById('setting-site-description').value,
                site_keywords: document.getElementById('setting-site-keywords').value,
                brand_name: document.getElementById('setting-brand-name').value,
                brand_color: document.getElementById('setting-brand-color').value,
                logo_url: document.getElementById('setting-logo-url').value,
                favicon_url: document.getElementById('setting-favicon-url').value,
                
                // Analytics
                analytics_enabled: document.getElementById('setting-analytics-enabled').checked ? 'true' : 'false',
                analytics_provider: document.getElementById('setting-analytics-provider').value,
                analytics_tracking_id: document.getElementById('setting-analytics-tracking-id').value,
                
                // Advertisements
                ads_enabled: document.getElementById('setting-ads-enabled').checked ? 'true' : 'false',
                ads_main_top: document.getElementById('setting-ads-main-top').value,
                ads_main_bottom: document.getElementById('setting-ads-main-bottom').value,
                ads_chat_sidebar: document.getElementById('setting-ads-chat-sidebar').value,
                ads_refresh_enabled: document.getElementById('setting-ads-refresh-enabled').checked ? 'true' : 'false',
                ads_refresh_interval: document.getElementById('setting-ads-refresh-interval').value,
                
                // Custom Scripts
                header_scripts: document.getElementById('setting-header-scripts').value,
                body_scripts: document.getElementById('setting-body-scripts').value,
            };

            const newPassword = document.getElementById('setting-admin-password').value;
            if (newPassword) {
                settings.admin_password = newPassword;
            }

            try {
                const response = await fetch('/api/admin/settings.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Settings saved successfully!');
                    if (newPassword) {
                        alert('Password changed! You will need to login again.');
                        logout();
                    } else {
                        document.getElementById('setting-admin-password').value = '';
                        loadSettings();
                    }
                } else {
                    alert('Failed to save settings: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function updateEmbedCode() {
            const audioEnabled = document.getElementById('embed-audio-enabled').checked;
            const currentUrl = window.location.origin;
            const audioParam = audioEnabled ? '' : '?audio=false';
            
            const embedCode = `<iframe 
    src="${currentUrl}${audioParam}" 
    width="100%" 
    height="600" 
    frameborder="0"
    allow="autoplay"
    style="border: 1px solid #e5e7eb; border-radius: 8px;">
</iframe>`;
            
            document.getElementById('embed-code').value = embedCode;
        }

        function copyEmbedCode() {
            const embedCode = document.getElementById('embed-code');
            embedCode.select();
            document.execCommand('copy');
            alert('Embed code copied to clipboard!');
        }
        
        async function kickUser(username) {
            if (!confirm(`Are you sure you want to kick "${username}" from the chat?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/kick-user.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ username: username })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('User kicked successfully!');
                    loadUsers();
                    loadInactiveUsers();
                } else {
                    alert('Failed to kick user: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function loadInactiveUsers(page = 1) {
            try {
                const response = await fetch(`/api/admin/inactive-users.php?page=${page}&limit=20`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('inactive-users-table');
                    const pagination = data.pagination;
                    
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Profile</th>
                                    <th>Last Message</th>
                                    <th>Message Count</th>
                                    <th>IP Address</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => {
                                    let profile = '';
                                    if (user.age) profile += `${user.age}y `;
                                    if (user.sex) profile += `${user.sex} `;
                                    if (user.location) profile += user.location;
                                    
                                    return `
                                    <tr>
                                        <td>${escapeHtml(user.username)}</td>
                                        <td>${escapeHtml(profile || 'N/A')}</td>
                                        <td>${user.last_message_at ? new Date(user.last_message_at).toLocaleString() : 'Never'}</td>
                                        <td>${user.message_count || 0}</td>
                                        <td>${user.ip_address}</td>
                                        <td>
                                            <button class="btn" onclick="viewInactiveUserDetails(\`${user.username.replace(/`/g, '\\`')}\`)">View Details</button>
                                        </td>
                                    </tr>
                                `;
                                }).join('')}
                            </tbody>
                        </table>
                        ${renderPagination(pagination, 'loadInactiveUsers')}
                    `;
                }
            } catch (error) {
                console.error('Failed to load inactive users:', error);
            }
        }
        
        async function loadUrlBlacklist() {
            try {
                const response = await fetch('/api/admin/url-blacklist.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('url-blacklist-table');
                    table.innerHTML = `
                        <p style="margin-bottom: 10px;"><strong>Total patterns:</strong> ${data.patterns.length}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Pattern</th>
                                    <th>Description</th>
                                    <th>Added By</th>
                                    <th>Added At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.patterns.length === 0 ? '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No patterns added yet</td></tr>' : 
                                data.patterns.map(item => `
                                    <tr>
                                        <td><code>${item.pattern}</code></td>
                                        <td>${item.description || '-'}</td>
                                        <td>${item.added_by || 'admin'}</td>
                                        <td>${new Date(item.added_at).toLocaleString()}</td>
                                        <td>
                                            <button class="btn-danger" onclick="deleteUrlPattern(${item.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load URL blacklist:', error);
            }
        }
        
        async function addUrlBlacklist() {
            const pattern = document.getElementById('new-url-pattern').value.trim();
            const description = document.getElementById('new-url-description').value.trim();
            
            if (!pattern) {
                alert('Please enter a URL pattern');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/url-blacklist.php', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pattern, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('new-url-pattern').value = '';
                    document.getElementById('new-url-description').value = '';
                    loadUrlBlacklist();
                } else {
                    alert(data.error || 'Failed to add pattern');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }
        
        async function deleteUrlPattern(id) {
            if (!confirm('Are you sure you want to delete this pattern?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/url-blacklist.php?id=${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadUrlBlacklist();
                } else {
                    alert(data.error || 'Failed to delete pattern');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        // Photos Management
        async function loadPhotos(page = 1) {
            try {
                const response = await fetch(`/api/admin/photos.php?action=list&page=${page}&limit=20`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('photos-table');
                    const photos = data.photos;
                    const pagination = data.pagination;
                    
                    if (photos.length === 0) {
                        table.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No photos uploaded yet</p>';
                        return;
                    }
                    
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Preview</th>
                                    <th>Filename</th>
                                    <th>Uploaded By</th>
                                    <th>Recipient</th>
                                    <th>Size</th>
                                    <th>Dimensions</th>
                                    <th>Uploaded</th>
                                    <th>Expires</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${photos.map(photo => `
                                    <tr>
                                        <td>
                                            <a href="${photo.file_path}" target="_blank">
                                                <img src="${photo.file_path}" style="max-width: 80px; max-height: 60px; border-radius: 4px;" alt="Preview">
                                            </a>
                                        </td>
                                        <td><code>${photo.filename}</code></td>
                                        <td>
                                            <a href="#" onclick="loadPhotosByUser('${photo.uploaded_by}'); return false;" style="color: #3b82f6;">
                                                ${photo.uploaded_by}
                                            </a>
                                        </td>
                                        <td>${photo.recipient || '-'}</td>
                                        <td>${formatFileSize(photo.file_size)}</td>
                                        <td>${photo.width}√ó${photo.height}</td>
                                        <td>${new Date(photo.uploaded_at).toLocaleString()}</td>
                                        <td>${new Date(photo.expires_at).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${renderPagination(pagination, 'loadPhotos')}
                    `;
                }
            } catch (error) {
                console.error('Error loading photos:', error);
            }
        }

        async function loadPhotosByUser(username) {
            try {
                const response = await fetch(`/api/admin/photos.php?action=by_user&username=${encodeURIComponent(username)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('photos-table');
                    const photos = data.photos;
                    
                    table.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <button class="btn" onclick="loadPhotos()">‚Üê Back to All Photos</button>
                            <h3 style="display: inline; margin-left: 20px;">Photos by ${username}</h3>
                        </div>
                        ${photos.length === 0 ? '<p style="color: #9ca3af;">No photos found</p>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Preview</th>
                                    <th>Filename</th>
                                    <th>Recipient</th>
                                    <th>Size</th>
                                    <th>Dimensions</th>
                                    <th>Uploaded</th>
                                    <th>Expires</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${photos.map(photo => `
                                    <tr>
                                        <td>
                                            <a href="${photo.file_path}" target="_blank">
                                                <img src="${photo.file_path}" style="max-width: 80px; max-height: 60px; border-radius: 4px;" alt="Preview">
                                            </a>
                                        </td>
                                        <td><code>${photo.filename}</code></td>
                                        <td>${photo.recipient || '-'}</td>
                                        <td>${formatFileSize(photo.file_size)}</td>
                                        <td>${photo.width}√ó${photo.height}</td>
                                        <td>${new Date(photo.uploaded_at).toLocaleString()}</td>
                                        <td>${new Date(photo.expires_at).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <p style="margin-top: 20px; color: #6b7280;">
                            Total: ${photos.length} photo${photos.length !== 1 ? 's' : ''}
                        </p>
                        `}
                    `;
                }
            } catch (error) {
                console.error('Error loading photos by user:', error);
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    </script>
</body>
</html>
