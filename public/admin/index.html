<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadioChatBox - Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --sidebar-width: 260px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-800);
            margin: 0;
            padding: 0;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 24px 20px;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            padding: 0 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--gray-400);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--gray-600);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--gray-50);
            color: var(--primary);
        }

        .nav-item.active {
            background: #f0f4ff;
            color: var(--primary);
            border-left-color: var(--primary);
            font-weight: 500;
        }

        .nav-item .icon {
            width: 20px;
            height: 20px;
            font-size: 18px;
            text-align: center;
        }

        .notification-badge {
            display: inline-block;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            min-width: 18px;
            text-align: center;
        }

        /* Main Content Area */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        /* Top Header */
        .top-header {
            background: white;
            padding: 16px 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left h2 {
            font-size: 24px;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .header-left p {
            font-size: 14px;
            color: var(--gray-500);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .user-role {
            font-size: 12px;
            color: var(--gray-500);
            text-transform: capitalize;
        }

        /* Content Container */
        .content-container {
            padding: 32px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .kpi-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .kpi-icon.primary { background: #e0e7ff; }
        .kpi-icon.success { background: #d1fae5; }
        .kpi-icon.warning { background: #fef3c7; }
        .kpi-icon.danger { background: #fee2e2; }
        .kpi-icon.info { background: #dbeafe; }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .kpi-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kpi-change.positive { color: var(--success); }
        .kpi-change.negative { color: var(--danger); }
        .kpi-change.neutral { color: var(--gray-400); }

        /* Section Cards */
        .section {
            background: white;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section h2 {
            font-size: 20px;
            color: var(--gray-900);
            font-weight: 600;
        }

        .section-header p {
            color: var(--gray-500);
            font-size: 14px;
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--gray-300);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-400);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .error {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #f9fafb;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .login-container {
            max-width: 420px;
            width: 90%;
            background: white;
            padding: 48px 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo h1 {
            font-size: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .login-logo p {
            color: var(--gray-500);
            font-size: 14px;
        }

        .error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 12px;
            padding: 12px;
            background: #fee2e2;
            border-radius: 6px;
            display: none;
        }

        .error:not(:empty) {
            display: block;
        }

        /* Admin Panel Container */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: flex !important;
            }

            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .content-container {
                padding: 20px 16px;
            }

            .top-header {
                padding: 16px;
            }

            .section {
                padding: 20px 16px;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                display: none;
            }
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: var(--gray-100);
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Logout Button in Sidebar */
        .sidebar-footer {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 1px solid var(--gray-200);
            padding: 16px 20px;
        }

        #sidebar-logout-btn {
            width: 100%;
            padding: 12px;
            background: var(--gray-100);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        #sidebar-logout-btn:hover {
            background: #fee2e2;
            color: var(--danger);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-4 {
            margin-top: 16px;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        /* Badge */
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-gray {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        #impersonate-emoji-picker {
            position: fixed !important;
            z-index: 10000 !important;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 380px;
            max-width: 90vw;
            max-height: 400px;
            display: none;
            flex-direction: column;
            box-sizing: border-box;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .impersonate-emoji-category {
            background: transparent;
            border: none;
            font-size: 20px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            flex-shrink: 0;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .impersonate-emoji-category:hover {
            background: #e5e7eb;
        }

        .impersonate-emoji-category.active {
            background: #667eea;
            color: white;
        }

        #impersonate-emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 40px);
            gap: 4px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        .emoji-item {
            background: transparent;
            border: none;
            font-size: 24px;
            padding: 0;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            min-width: 40px;
            max-width: 40px;
            min-height: 40px;
            max-height: 40px;
            box-sizing: border-box;
            overflow: hidden;
        }

        .emoji-item:hover {
            background: #f3f4f6;
            transform: scale(1.2);
        }

        .emoji-item:active {
            transform: scale(1.05);
        }

        #impersonate-gif-picker {
            position: fixed !important;
            z-index: 10000 !important;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 380px;
            max-width: 90vw;
            max-height: 400px;
            display: none;
            flex-direction: column;
            box-sizing: border-box;
            animation: slideUp 0.2s ease;
        }

        #impersonate-gif-search-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        #impersonate-gif-search-input:focus {
            border-color: #667eea;
        }

        #impersonate-gif-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .impersonate-gif-item {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: none;
            transition: transform 0.2s;
            background: #f3f4f6;
        }

        .impersonate-gif-item:hover {
            transform: scale(1.05);
        }

        .impersonate-gif-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--gray-900);
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body .form-group small {
            display: block;
            margin-top: 6px;
            font-size: 12px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            background: var(--gray-50);
            border-radius: 0 0 12px 12px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <h1>üìª RadioChatBox</h1>
                <p>Admin Dashboard</p>
            </div>
            <form onsubmit="event.preventDefault(); login();">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="admin-username" placeholder="Enter your username" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="admin-password" placeholder="Enter your password" autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">
                    üîê Sign In
                </button>
            </form>
            <button class="btn btn-secondary" style="width: 100%; padding: 14px; margin-top: 10px;" onclick="goBackToChat()">
                ‚Üê Back to Chat
            </button>
            <div class="error" id="login-error"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-panel">
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileSidebar()"></div>
        
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üìª RadioChatBox</h1>
                <p>Admin Dashboard</p>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item active" onclick="switchTab('dashboard')" data-tab="dashboard">
                        <span class="icon">üìä</span>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('statistics')" data-tab="statistics">
                        <span class="icon">üìà</span>
                        <span>Statistics</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Users</div>
                    <div class="nav-item" onclick="switchTab('users')" data-tab="users">
                        <span class="icon">üë•</span>
                        <span>Active Users</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('inactive-users')" data-tab="inactive-users">
                        <span class="icon">üò¥</span>
                        <span>Inactive Users</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('admin-users')" id="nav-admin-users" data-tab="admin-users">
                        <span class="icon">üëë</span>
                        <span>User Management</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('fake-users')" data-tab="fake-users">
                        <span class="icon">ü§ñ</span>
                        <span>Fake Users</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Messages</div>
                    <div class="nav-item" onclick="switchTab('messages')" data-tab="messages">
                        <span class="icon">üí¨</span>
                        <span>Message History</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('notifications')" id="nav-notifications" style="display:none;" data-tab="notifications">
                        <span class="icon">üîî</span>
                        <span>Notifications</span>
                        <span class="notification-badge" id="notification-badge" style="display:none;">0</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('impersonate')" id="nav-impersonate" style="display:none;" data-tab="impersonate">
                        <span class="icon">üë§</span>
                        <span>Impersonate</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Moderation</div>
                    <div class="nav-item" onclick="switchTab('ip-bans')" data-tab="ip-bans">
                        <span class="icon">üö´</span>
                        <span>IP Bans</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('nickname-bans')" data-tab="nickname-bans">
                        <span class="icon">üîá</span>
                        <span>Nickname Bans</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('url-whitelist')" data-tab="url-whitelist">
                        <span class="icon">‚úÖ</span>
                        <span>URL Whitelist</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('url-blacklist')" data-tab="url-blacklist">
                        <span class="icon">üîó</span>
                        <span>URL Blacklist</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Media & Settings</div>
                    <div class="nav-item" onclick="switchTab('photos')" data-tab="photos">
                        <span class="icon">üì∏</span>
                        <span>Photos</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('settings')" id="nav-settings" data-tab="settings">
                        <span class="icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </div>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <button id="sidebar-logout-btn" onclick="logout()">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">‚ò∞</button>
                <div class="header-left">
                    <h2 id="page-title">Dashboard</h2>
                    <p id="page-subtitle">Welcome to RadioChatBox Admin Panel</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-outline" onclick="window.open('/', '_blank')">
                        üöÄ Open Chat
                    </button>
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">A</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name">Admin</div>
                            <div class="user-role" id="user-role">Loading...</div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Container -->
            <div class="content-container">
                <!-- Dashboard Tab -->
                <div id="dashboard-tab" class="tab-content active">
                    <!-- KPI Cards -->
                    <div class="kpi-grid">
                        <div class="kpi-card" style="cursor: pointer;" onclick="switchTab('users')" title="Click to view all active users">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Active Users (Real)</div>
                                </div>
                                <div class="kpi-icon primary">üë•</div>
                            </div>
                            <div class="kpi-value" id="kpi-active-users">-</div>
                            <div class="kpi-change neutral">Currently online (real users)</div>
                        </div>
                        
                        <div class="kpi-card" style="cursor: pointer;" onclick="switchTab('messages')" title="Click to view all messages">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Messages Today</div>
                                </div>
                                <div class="kpi-icon success">üí¨</div>
                            </div>
                            <div class="kpi-value" id="kpi-messages-today">-</div>
                            <div class="kpi-change neutral">Last 24 hours</div>
                        </div>
                        
                        <div class="kpi-card" style="cursor: pointer;" onclick="switchTab('fake-users')" title="Click to manage fake users">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Fake Users Active</div>
                                </div>
                                <div class="kpi-icon info">ü§ñ</div>
                            </div>
                            <div class="kpi-value" id="kpi-fake-users">-</div>
                            <div class="kpi-change neutral">Currently online</div>
                        </div>
                        
                        <div class="kpi-card" style="cursor: pointer; display: none;" id="kpi-listeners-card" onclick="switchTab('statistics')" title="Click to view statistics">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Shoutcast Listeners</div>
                                </div>
                                <div class="kpi-icon info">üìª</div>
                            </div>
                            <div class="kpi-value" id="kpi-listeners">-</div>
                            <div class="kpi-change neutral" id="kpi-listeners-now">Now Playing</div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="section">
                        <div class="section-header">
                            <div>
                                <h2>Quick Actions</h2>
                                <p>Common administrative tasks</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <button class="btn btn-warning" onclick="flushRedisCache()" style="padding: 16px;">
                                <span>üîÑ</span>
                                <span>Flush Redis Cache</span>
                            </button>
                            <button class="btn btn-danger" onclick="clearPublicChat()" style="padding: 16px;">
                                <span>üóëÔ∏è</span>
                                <span>Clear Public Chat</span>
                            </button>
                            <button class="btn btn-primary" onclick="switchTab('fake-users')" style="padding: 16px;">
                                <span>ü§ñ</span>
                                <span>Manage Fake Users</span>
                            </button>
                            <button class="btn btn-success" onclick="switchTab('settings')" style="padding: 16px;">
                                <span>‚öôÔ∏è</span>
                                <span>System Settings</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="section" id="dashboard-recent-messages-section">
                        <div class="section-header">
                            <div>
                                <h2>Recent Messages</h2>
                                <p id="dashboard-messages-subtitle">Last 10 messages</p>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="dashboard-message-filter" onchange="filterDashboardMessages()" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; display: none;">
                                    <option value="all">All Messages</option>
                                    <option value="public">Public Only</option>
                                    <option value="private">Private Only</option>
                                </select>
                                <button class="btn btn-outline" onclick="switchTab('messages')">View All</button>
                            </div>
                        </div>
                        <div id="dashboard-recent-messages"></div>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="statistics-tab" class="tab-content">
                    <div class="section">
                        <h2>üìà Statistics Dashboard</h2>
                        <p style="color: #6b7280; margin-bottom: 20px;">
                            View real-time statistics and analytics for your chat activity.
                        </p>
                        
                        <!-- Statistics Sub-tabs -->
                        <div style="display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid #e5e7eb;">
                            <button class="btn" onclick="loadStatsTab('summary')" id="stats-tab-summary" style="background: #667eea; color: white; margin-bottom: -2px; border-bottom: 3px solid #667eea;">Summary</button>
                            <button class="btn" onclick="loadStatsTab('hourly')" id="stats-tab-hourly" style="background: transparent; color: #6b7280;">Hourly</button>
                            <button class="btn" onclick="loadStatsTab('daily')" id="stats-tab-daily" style="background: transparent; color: #6b7280;">Daily</button>
                            <button class="btn" onclick="loadStatsTab('weekly')" id="stats-tab-weekly" style="background: transparent; color: #6b7280;">Weekly</button>
                            <button class="btn" onclick="loadStatsTab('monthly')" id="stats-tab-monthly" style="background: transparent; color: #6b7280;">Monthly</button>
                            <button class="btn" onclick="loadStatsTab('yearly')" id="stats-tab-yearly" style="background: transparent; color: #6b7280;">Yearly</button>
                        </div>
                        
                        <!-- Statistics Controls -->
                        <div id="stats-controls" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;"></div>
                        
                        <div id="stats-error" style="margin-top: 20px;"></div>
                        <div id="stats-content" style="margin-top: 30px;"></div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div id="messages-tab" class="tab-content">
                    <div class="section">
                        <div class="section-header">
                            <div>
                                <h2>Message History</h2>
                                <p id="message-history-subtitle">View and manage all messages</p>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="message-type-filter" onchange="loadMessages(1)" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; display: none;">
                                    <option value="all">All Messages</option>
                                    <option value="public">Public Only</option>
                                    <option value="private">Private Only</option>
                                </select>
                                <button class="btn btn-warning" onclick="flushRedisCache()">
                                    ÔøΩ Flush Cache
                                </button>
                                <button class="btn btn-danger" onclick="clearPublicChat()">
                                    üóëÔ∏è Clear Chat
                                </button>
                            </div>
                        </div>
                        <div id="messages-table"></div>
                        <div class="pagination" id="messages-pagination"></div>
                    </div>
                </div>

                <!-- Active Users Tab -->
                <div id="users-tab" class="tab-content">
                    <div class="section">
                        <div class="section-header">
                            <div>
                                <h2>Active Users</h2>
                                <p>Currently online users</p>
                            </div>
                        </div>
                        <div id="users-table"></div>
                    </div>
                </div>
                <div id="user-details" class="section" style="display: none;">
                    <h2>User Details: <span id="user-details-name"></span></h2>
                    <button class="btn" onclick="closeUserDetails()" style="margin-bottom: 15px;">‚Üê Back to Users</button>
                    <div id="user-details-content"></div>
                </div>
            </div>

            <!-- Inactive Users Tab -->
            <div id="inactive-users-tab" class="tab-content">
                <div class="section" id="inactive-users-section">
                    <h2>Inactive Users</h2>
                    <p style="color: #6b7280; margin-bottom: 15px;">Users who have left the chat or disconnected</p>
                    <div id="inactive-users-table"></div>
                </div>
                <div id="inactive-user-details" class="section" style="display: none;">
                    <h2>User Details: <span id="inactive-user-details-name"></span></h2>
                    <button class="btn" onclick="closeInactiveUserDetails()" style="margin-bottom: 15px;">‚Üê Back to Inactive Users</button>
                    <div id="inactive-user-details-content"></div>
                </div>
            </div>

            <!-- Admin Users Tab -->
            <div id="admin-users-tab" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <div>
                            <h2>User Management</h2>
                            <p style="color: #6b7280;">Manage all system users and their access levels</p>
                        </div>
                        <button class="btn btn-success" onclick="openCreateUserModal()">
                            <span>‚ûï</span>
                            <span>Create New User</span>
                        </button>
                    </div>
                    <div id="admin-users-table"></div>
                </div>
                
                <div id="edit-admin-user-modal" class="section" style="display: none;">
                    <h2>Edit Admin User</h2>
                    <button class="btn" onclick="closeEditAdminUserModal()" style="margin-bottom: 15px;">‚Üê Back to Users</button>
                    
                    <input type="hidden" id="edit-admin-user-id">
                    
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="edit-admin-username" disabled style="background: #f3f4f6; cursor: not-allowed;">
                    </div>
                    
                    <div class="form-group">
                        <label>New Password (leave empty to keep current)</label>
                        <input type="password" id="edit-admin-password" placeholder="Minimum 8 characters" minlength="8">
                    </div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit-admin-email" placeholder="user@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label>Role</label>
                        <select id="edit-admin-role" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                            <option value="root">üî¥ Root</option>
                            <option value="administrator">üü† Administrator</option>
                            <option value="moderator">üü° Moderator</option>
                            <option value="simple_user">‚ö´ Simple User</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="edit-admin-is-active" style="width: auto;">
                            Account is active (can login)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveAdminUser()">Save Changes</button>
                        <button class="btn btn-danger" onclick="deleteAdminUser()">Delete User</button>
                    </div>
                </div>

                <!-- Create User Modal -->
                <div id="create-user-modal-overlay" class="modal-overlay" style="display: none;" onclick="closeCreateUserModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Create New User</h2>
                            <button class="modal-close" onclick="closeCreateUserModal()">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Username <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="new-admin-username" placeholder="Enter username" required minlength="3" maxlength="50">
                                <small style="color: #6b7280;">3-50 characters, unique identifier for login</small>
                            </div>

                            <div class="form-group">
                                <label>Password <span style="color: #ef4444;">*</span></label>
                                <input type="password" id="new-admin-password" placeholder="Enter password" required minlength="8">
                                <small style="color: #6b7280;">Minimum 8 characters</small>
                            </div>

                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="new-admin-email" placeholder="user@example.com">
                                <small style="color: #6b7280;">Optional - used for notifications and account recovery</small>
                            </div>

                            <div class="form-group">
                                <label>Role <span style="color: #ef4444;">*</span></label>
                                <select id="new-admin-role" required style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                                    <option value="">Select a role</option>
                                    <option value="root">üî¥ Root - Full system access</option>
                                    <option value="administrator">üü† Administrator - Full access (no root management)</option>
                                    <option value="moderator">üü° Moderator - Read-only access</option>
                                    <option value="simple_user">‚ö´ Simple User - No admin panel access</option>
                                </select>
                            </div>

                            <div class="info-box" style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 6px; margin-top: 20px;">
                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 12px; font-size: 14px;">üìã Role Permissions</div>
                                <div style="color: #1e3a8a; font-size: 13px; line-height: 1.8;">
                                    <p style="margin-bottom: 8px;"><strong>üî¥ Root:</strong> Complete system control including user management, settings, private messages, and all administrative functions</p>
                                    <p style="margin-bottom: 8px;"><strong>üü† Administrator:</strong> Full access except managing root users - can view private messages and modify settings</p>
                                    <p style="margin-bottom: 8px;"><strong>üü° Moderator:</strong> Read-only access to public messages, bans, and blacklists - cannot modify settings or manage users</p>
                                    <p style="margin-bottom: 0;"><strong>‚ö´ Simple User:</strong> No admin panel access - standard user account only</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="closeCreateUserModal()">Cancel</button>
                            <button class="btn btn-success" onclick="createAdminUser()">Create User</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fake Users Tab -->
            <div id="fake-users-tab" class="tab-content">
                <div class="section">
                    <h2>Add Fake User</h2>
                    <p style="color: #6b7280; margin-bottom: 15px;">Create fake users to make the chat look more active when there are few real users</p>
                    <p id="fake-user-profile-note" style="color: #ef4444; margin-bottom: 15px; display: none;">
                        ‚ö†Ô∏è Profile fields (Age, Sex, Country) are required because "Require Profile" is enabled in settings.
                    </p>
                    <div class="form-group">
                        <label>Nickname <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="fake-nickname" placeholder="e.g., ChatBot123" required minlength="3" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label>Age <span id="fake-age-required" style="color: #ef4444; display: none;">*</span></label>
                        <select id="fake-age"></select>
                    </div>
                    <div class="form-group">
                        <label>Sex <span id="fake-sex-required" style="color: #ef4444; display: none;">*</span></label>
                        <select id="fake-sex">
                            <option value="">Select Sex</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Country <span id="fake-location-required" style="color: #ef4444; display: none;">*</span></label>
                        <select id="fake-location">
                            <option value="">Select Country</option>
                        </select>
                    </div>
                    <button class="btn" onclick="addFakeUser()">Add Fake User</button>
                </div>

                <div class="section">
                    <h2>Fake Users List</h2>
                    <p style="color: #6b7280; margin-bottom: 15px;">Toggle to activate/deactivate fake users. Active fake users appear in the user list.</p>
                    <div id="fake-users-table"></div>
                </div>
            </div>

            <!-- Impersonation Tab (Root/Owner only) -->
            <div id="impersonate-tab" class="tab-content">
                <div class="section">
                    <h2>üë§ Impersonate Fake Users</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        Reply to users who message your fake users. Only root/owner can access this feature.
                    </p>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Select Fake User to Impersonate</label>
                            <select id="impersonate-select" onchange="loadImpersonateConversation()">
                                <option value="">-- Select a fake user --</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn" onclick="refreshImpersonateConversations()" style="background: #10b981;">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>

                    <div id="impersonate-no-conversations" style="text-align: center; padding: 40px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üí¨</div>
                        <p>No messages to fake users yet</p>
                        <p style="font-size: 14px;">When users send private messages to fake users, they'll appear here.</p>
                    </div>

                    <div id="impersonate-conversations" style="display: none;">
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; color: #374151;">Conversations</h3>
                            <div id="impersonate-senders-list"></div>
                        </div>

                        <div id="impersonate-selected-conversation" style="display: none;">
                            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>Chatting with: <span id="impersonate-current-sender"></span></strong>
                                    <span style="color: #6b7280; margin-left: 10px;">as <strong id="impersonate-as-name"></strong></span>
                                    <div id="impersonate-as-info" style="margin-top: 8px; font-size: 13px; color: #6b7280;"></div>
                                </div>
                                <button class="btn" onclick="selectSender(currentImpersonateAs, currentSender)" style="background: #10b981; padding: 6px 12px; font-size: 13px;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            
                            <div id="impersonate-messages" style="display: flex; flex-direction: column; min-height: 400px; max-height: 500px; overflow-y: auto; background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e5e7eb;">
                                <div style="text-align: center; color: #9ca3af; padding: 20px;">Loading conversation...</div>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb;">
                                <div style="margin-bottom: 8px; color: #6b7280; font-size: 13px; font-weight: 600;">
                                    Reply as <strong style="color: #667eea;" id="impersonate-as-name-2"></strong>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: flex-end;">
                                    <button 
                                        id="impersonate-emoji-button"
                                        onclick="toggleImpersonateEmojiPicker()" 
                                        style="background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px 14px; cursor: pointer; font-size: 20px; height: 44px; flex-shrink: 0;"
                                        title="Insert emoji">
                                        üòä
                                    </button>
                                    <button 
                                        id="impersonate-gif-button"
                                        onclick="toggleImpersonateGifPicker()" 
                                        style="background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px 14px; cursor: pointer; font-size: 20px; height: 44px; flex-shrink: 0; display: none;"
                                        title="Insert GIF">
                                        GIF
                                    </button>
                                    <button 
                                        onclick="document.getElementById('impersonate-photo-input').click()" 
                                        style="background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px 14px; cursor: pointer; font-size: 20px; height: 44px; flex-shrink: 0;"
                                        title="Send photo">
                                        üì∑
                                    </button>
                                    <input 
                                        type="file" 
                                        id="impersonate-photo-input" 
                                        accept="image/*" 
                                        style="display: none;"
                                        onchange="handleImpersonatePhotoUpload(this)">
                                    <textarea 
                                        id="impersonate-message" 
                                        rows="1" 
                                        placeholder="Type your message... (Enter to send)"
                                        style="flex: 1; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; resize: none; min-height: 44px; max-height: 120px; line-height: 1.5;"
                                        oninput="this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 120) + 'px';"
                                    ></textarea>
                                    <button 
                                        onclick="sendImpersonateMessage()" 
                                        style="background: #667eea; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-weight: 600; height: 44px; flex-shrink: 0;"
                                        title="Send message">
                                        Send üì§
                                    </button>
                                </div>
                                <!-- Photo preview -->
                                <div id="impersonate-photo-preview" style="display: none; margin-top: 10px; padding: 10px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <strong style="font-size: 13px; color: #6b7280;">Photo ready to send</strong>
                                        <button onclick="clearImpersonatePhoto()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Remove</button>
                                    </div>
                                    <img id="impersonate-photo-preview-img" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emoji picker for impersonate -->
                <div id="impersonate-emoji-picker" style="display: none;">
                    <div class="emoji-categories" style="display: flex; border-bottom: 1px solid #e5e7eb; background: #f9fafb; padding: 6px; gap: 2px; overflow-x: auto; flex-shrink: 0;">
                        <button class="impersonate-emoji-category active" data-category="smileys">üòÄ</button>
                        <button class="impersonate-emoji-category" data-category="gestures">üëã</button>
                        <button class="impersonate-emoji-category" data-category="hearts">‚ù§Ô∏è</button>
                        <button class="impersonate-emoji-category" data-category="animals">üê∂</button>
                        <button class="impersonate-emoji-category" data-category="food">üçï</button>
                        <button class="impersonate-emoji-category" data-category="activities">‚öΩ</button>
                        <button class="impersonate-emoji-category" data-category="travel">‚úàÔ∏è</button>
                        <button class="impersonate-emoji-category" data-category="objects">üí°</button>
                    </div>
                    <div id="impersonate-emoji-grid"></div>
                </div>

                <!-- GIF picker for impersonate -->
                <div id="impersonate-gif-picker" style="display: none;">
                    <div class="gif-search-container" style="display: flex; gap: 8px; padding: 12px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; flex-shrink: 0;">
                        <input type="text" id="impersonate-gif-search-input" placeholder="Search GIFs..." autocomplete="off">
                    </div>
                    <div id="impersonate-gif-grid"></div>
                    <div id="impersonate-gif-loading" style="display: none; text-align: center; padding: 20px; color: #6b7280;">Loading...</div>
                </div>
            </div>

            <!-- Notifications Tab (Root/Administrator only) -->
            <div id="notifications-tab" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <div>
                            <h2>üîî Admin Notifications</h2>
                            <p>Real-time alerts for admin-worthy events</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="refreshNotifications()" style="background: #10b981;">
                                üîÑ Refresh
                            </button>
                            <button class="btn" onclick="markAllNotificationsRead()" style="background: #667eea; color: white;">
                                ‚úì Mark All Read
                            </button>
                            <button class="btn" onclick="clearReadNotifications()" style="background: #ef4444; color: white;">
                                üóëÔ∏è Clear Read
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <button class="filter-btn active" onclick="filterNotifications('all')" data-filter="all" style="padding: 8px 16px; border: 2px solid #e5e7eb; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            All Notifications
                        </button>
                        <button class="filter-btn" onclick="filterNotifications('unread')" data-filter="unread" style="padding: 8px 16px; border: 2px solid #e5e7eb; background: white; color: #6b7280; border-radius: 6px; cursor: pointer;">
                            Unread Only
                        </button>
                        <button class="filter-btn" onclick="filterNotifications('fake_user_dm')" data-filter="fake_user_dm" style="padding: 8px 16px; border: 2px solid #e5e7eb; background: white; color: #6b7280; border-radius: 6px; cursor: pointer;">
                            Fake User DMs
                        </button>
                    </div>

                    <div id="notifications-list" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Notifications will be populated here -->
                        <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üîî</div>
                            <h3 style="margin-bottom: 8px; color: #6b7280;">No notifications yet</h3>
                            <p>You'll be notified here when users send DMs to fake users</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IP Bans Tab -->
            <div id="ip-bans-tab" class="tab-content">
                <div class="section">
                    <h2>Add IP Ban</h2>
                    <div class="form-group">
                        <label>IP Address</label>
                        <input type="text" id="ban-ip-address" placeholder="e.g., 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <input type="text" id="ban-ip-reason" placeholder="Reason for ban">
                    </div>
                    <div class="form-group">
                        <label>Duration (days, leave empty for permanent)</label>
                        <input type="number" id="ban-ip-duration" placeholder="e.g., 7">
                    </div>
                    <button class="btn btn-danger" onclick="banIP()">Ban IP</button>
                </div>

                <div class="section">
                    <h2>Current IP Bans</h2>
                    <div id="ip-bans-table"></div>
                </div>
            </div>

            <!-- Nickname Bans Tab -->
            <div id="nickname-bans-tab" class="tab-content">
                <div class="section">
                    <h2>Add Nickname Ban</h2>
                    <div class="form-group">
                        <label>Nickname</label>
                        <input type="text" id="ban-nickname-name" placeholder="Nickname to ban">
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <input type="text" id="ban-nickname-reason" placeholder="Reason for ban">
                    </div>
                    <button class="btn btn-danger" onclick="banNickname()">Ban Nickname</button>
                </div>

                <div class="section">
                    <h2>Current Nickname Bans</h2>
                    <div id="nickname-bans-table"></div>
                </div>

                <!-- Kicked Users Section -->
                <div class="section">
                    <h2>Kicked Users (Session Bans)</h2>
                    <button class="btn btn-outline" onclick="loadKickedUsers()" style="margin-bottom:10px;">üîÑ Refresh</button>
                    <div id="kicked-users-table"></div>
                </div>
            <script>
            // --- Kicked Users ---
            async function loadKickedUsers() {
                const table = document.getElementById('kicked-users-table');
                table.innerHTML = '<div style="color:#6b7280;padding:20px;">Loading kicked users...</div>';
                try {
                    const response = await fetch('/api/admin/list-kicked-users.php', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (data.kicked_sessions && data.kicked_sessions.length > 0) {
                        table.innerHTML = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Session ID</th>
                                        <th>Reason</th>
                                        <th>Kicked At</th>
                                        <th>Expires In</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.kicked_sessions.map(session => `
                                        <tr>
                                            <td>${escapeHtml(session.username || 'Unknown')}</td>
                                            <td style="font-size:12px;">${escapeHtml(session.session_id)}</td>
                                            <td>${escapeHtml(session.reason || 'N/A')}</td>
                                            <td>${session.kicked_at ? new Date(session.kicked_at * 1000).toLocaleString() : 'N/A'}</td>
                                            <td>${session.expires_in > 0 ? formatDuration(session.expires_in) : 'Expired'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else {
                        table.innerHTML = '<div style="color:#6b7280;padding:20px;">No kicked users currently.</div>';
                    }
                } catch (e) {
                    table.innerHTML = '<div style="color:#ef4444;padding:20px;">Failed to load kicked users.</div>';
                }
            }

            // Helper to format seconds as human readable
            function formatDuration(seconds) {
                if (seconds <= 0) return 'Expired';
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                let out = '';
                if (h) out += h + 'h ';
                if (m) out += m + 'm ';
                if (s || (!h && !m)) out += s + 's';
                return out.trim();
            }

            // Auto-refresh kicked users every 60s
            setInterval(() => {
                const tab = document.querySelector('.tab-content.active');
                if (tab && tab.id === 'nickname-bans-tab') loadKickedUsers();
            }, 60000);
            </script>
            </div>

            <!-- URL Whitelist Tab -->
            <div id="url-whitelist-tab" class="tab-content">
                <div class="section">
                    <h2>URL Whitelist Management</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        URLs matching these patterns are <strong>allowed</strong> in public messages. 
                        All other URLs will be replaced with ***. Use * as a wildcard (e.g., *.youtube.com).
                    </p>
                    
                    <div class="form-group">
                        <label>Add New Pattern</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="new-whitelist-pattern" placeholder="e.g., youtube.com or *.social.com" style="flex: 1;">
                            <input type="text" id="new-whitelist-description" placeholder="Description (optional)" style="flex: 1;">
                            <button class="btn" onclick="addUrlWhitelist()" style="white-space: nowrap;">Add Pattern</button>
                        </div>
                    </div>
                    
                    <div id="url-whitelist-table"></div>
                </div>
            </div>

            <!-- URL Blacklist Tab -->
            <div id="url-blacklist-tab" class="tab-content">
                <div class="section">
                    <h2>URL Blacklist Management</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        URLs matching these patterns will be replaced with *** even in private messages. 
                        Use * as a wildcard (e.g., *.badsite.com).
                    </p>
                    
                    <div class="form-group">
                        <label>Add New Pattern</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="new-url-pattern" placeholder="e.g., spam.com or *.badsite.*" style="flex: 1;">
                            <input type="text" id="new-url-description" placeholder="Description (optional)" style="flex: 1;">
                            <button class="btn" onclick="addUrlBlacklist()" style="white-space: nowrap;">Add Pattern</button>
                        </div>
                    </div>
                    
                    <div id="url-blacklist-table"></div>
                </div>
            </div>

            <!-- Photos Tab -->
            <div id="photos-tab" class="tab-content">
                <div class="section">
                    <h2>Uploaded Photos</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        Photos are automatically deleted after 48 hours. Click on username to view all photos by that user.
                    </p>
                    <div id="photos-table"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="section">
                    <h2>General Settings</h2>
                    <div class="form-group">
                        <label>Page Title</label>
                        <input type="text" id="setting-page-title" placeholder="RadioChatBox">
                    </div>
                    <div class="form-group">
                        <label>Stream Status JSON URL (Icecast/Shoutcast)</label>
                        <input type="url" id="setting-radio-status-url" placeholder="https://example.com/status-json.xsl">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">If set, the chat header shows the current song/artist.</small>
                    </div>
                    <div class="form-group">
                        <label>Color Scheme</label>
                        <select id="setting-color-scheme" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                            <option value="metal">Metal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Chat Mode</label>
                        <select id="setting-chat-mode" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                            <option value="public">Public Room Only</option>
                            <option value="private">Private Messaging Only</option>
                            <option value="both">Public & Private</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-require-profile" style="width: auto;">
                            Require Age & Location on Registration
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-allow-photo-uploads" style="width: auto;">
                            Allow Photo Uploads in Private Messages
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Max Photo Size (MB)</label>
                        <input type="number" id="setting-max-photo-size-mb" placeholder="5" min="1" max="50">
                        <small id="php-max-upload-hint" style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Server maximum: 50 MB
                        </small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-gif-enabled" style="width: auto;">
                            Enable GIF Selector (Tenor Integration)
                        </label>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Allow users to search and share GIFs from Tenor. Requires a free API key from <a href="https://developers.google.com/tenor/guides/quickstart" target="_blank" style="color: #667eea;">Google Tenor</a>.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Tenor API Key (Optional)</label>
                        <input type="text" id="setting-tenor-api-key" placeholder="Enter your Tenor API key">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Get a free API key at <a href="https://developers.google.com/tenor/guides/quickstart" target="_blank" style="color: #667eea;">developers.google.com/tenor</a>
                        </small>
                    </div>
                    <div class="form-group" id="setting-minimum-users-group">
                        <label>Minimum Users (Fake Users Feature)</label>
                        <input type="number" id="setting-minimum-users" placeholder="0" min="0" max="100">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            When real users are below this number, random fake users will be activated to fill the gap. Set to 0 to disable.
                        </small>
                    </div>
                </div>

                <div class="section">
                    <h2>SEO & Branding</h2>
                    <div class="form-group">
                        <label>Site Title (SEO)</label>
                        <input type="text" id="setting-site-title" placeholder="RadioChatBox - Real-time Chat">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Used in search results and browser tabs
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Meta Description</label>
                        <textarea id="setting-site-description" rows="2" placeholder="Connect with listeners in real-time during your radio show" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            150-160 characters recommended
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Keywords (comma-separated)</label>
                        <input type="text" id="setting-site-keywords" placeholder="radio, chat, live, real-time">
                    </div>
                    <div class="form-group">
                        <label>Brand Name</label>
                        <input type="text" id="setting-brand-name" placeholder="RadioChatBox">
                    </div>
                    <div class="form-group">
                        <label>Brand Color</label>
                        <input type="color" id="setting-brand-color" value="#007bff">
                    </div>
                    <div class="form-group">
                        <label>Logo URL (optional)</label>
                        <input type="url" id="setting-logo-url" placeholder="https://example.com/logo.png">
                        <div style="margin-top: 10px;">
                            <label for="logo-upload" class="btn btn-secondary" style="cursor: pointer; display: inline-block;">
                                üì§ Upload Logo
                            </label>
                            <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="uploadLogo('logo')">
                            <span id="logo-upload-status" style="margin-left: 10px; color: #666;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Favicon URL (optional)</label>
                        <input type="url" id="setting-favicon-url" placeholder="https://example.com/favicon.ico">
                        <div style="margin-top: 10px;">
                            <label for="favicon-upload" class="btn btn-secondary" style="cursor: pointer; display: inline-block;">
                                üì§ Upload Favicon
                            </label>
                            <input type="file" id="favicon-upload" accept="image/*,.ico" style="display: none;" onchange="uploadLogo('favicon')">
                            <span id="favicon-upload-status" style="margin-left: 10px; color: #666;"></span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Analytics Integration</h2>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-analytics-enabled" style="width: auto;">
                            Enable Analytics Tracking
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Analytics Provider</label>
                        <select id="setting-analytics-provider" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                            <option value="">None</option>
                            <option value="ga4">Google Analytics 4 (GA4)</option>
                            <option value="gtm">Google Tag Manager (GTM)</option>
                            <option value="matomo">Matomo / Piwik</option>
                            <option value="custom">Custom Endpoint</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tracking ID (optional)</label>
                        <input type="text" id="setting-analytics-tracking-id" placeholder="G-XXXXXXXXXX or GTM-XXXXXXX">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            For GA4: G-XXXXXXXXXX | For GTM: GTM-XXXXXXX
                        </small>
                    </div>
                    <details style="padding: 12px; background: #f0f9ff; border-radius: 6px; margin-top: 10px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #1e40af;">Tracked Events</summary>
                        <ul style="margin-top: 10px; padding-left: 20px; color: #3730a3; font-size: 13px; line-height: 1.6;">
                            <li>Private chat open/close (with duration)</li>
                            <li>Message sent (public/private)</li>
                            <li>Photo upload (success/failure)</li>
                            <li>User registration & profile updates</li>
                            <li>Session tracking</li>
                            <li>Ad views & clicks</li>
                        </ul>
                    </details>
                </div>

                <div class="section">
                    <h2>Advertisement System</h2>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-ads-enabled" style="width: auto;">
                            Enable Advertisements
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Main Top Ad (HTML/JS)</label>
                        <textarea id="setting-ads-main-top" rows="4" placeholder="<div>Your ad code here</div>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Displayed above chat messages
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Main Bottom Ad (HTML/JS)</label>
                        <textarea id="setting-ads-main-bottom" rows="4" placeholder="<div>Your ad code here</div>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Displayed below chat messages
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Chat Sidebar Ad (HTML/JS)</label>
                        <textarea id="setting-ads-chat-sidebar" rows="4" placeholder="<div>Your ad code here</div>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Displayed next to active users
                        </small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-ads-refresh-enabled" style="width: auto;">
                            Enable Auto-Refresh
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Refresh Interval (seconds)</label>
                        <input type="number" id="setting-ads-refresh-interval" placeholder="30" min="10" max="300">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            How often to reload ad content (10-300 seconds)
                        </small>
                    </div>
                </div>

                <div class="section">
                    <h2>Custom Scripts</h2>
                    <div class="form-group">
                        <label>Header Scripts (injected in &lt;head&gt;)</label>
                        <textarea id="setting-header-scripts" rows="6" placeholder="<script>// Analytics, tracking pixels, etc.</script>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Perfect for Google Analytics, Facebook Pixel, custom CSS
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Body Scripts (injected before &lt;/body&gt;)</label>
                        <textarea id="setting-body-scripts" rows="6" placeholder="<script>// Chatbots, widgets, etc.</script>" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Perfect for Intercom, Drift, cookie consent banners
                        </small>
                    </div>
                    <div style="padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                        <strong style="color: #92400e;">‚ö†Ô∏è Warning:</strong>
                        <p style="color: #78350f; font-size: 13px; margin-top: 4px;">
                            Only inject scripts from trusted sources. Malicious code can compromise your chat security.
                        </p>
                    </div>
                </div>

                <div class="section">
                    <h2>Rate Limiting</h2>
                    <div class="form-group">
                        <label>Max Messages per Window</label>
                        <input type="number" id="setting-rate-limit-messages" placeholder="10" min="1">
                    </div>
                    <div class="form-group">
                        <label>Time Window (seconds)</label>
                        <input type="number" id="setting-rate-limit-window" placeholder="60" min="1">
                    </div>
                </div>

                <div class="section">
                    <button class="btn btn-success" onclick="saveSettings()" style="width: 100%; font-size: 16px; padding: 12px;">
                        üíæ Save All Settings
                    </button>
                    <p style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 6px; color: #1e40af; font-size: 14px;">
                        ÔøΩ <strong>Note:</strong> To change your admin password, go to the <strong>User Management</strong> tab and edit your user account.
                    </p>
                </div>

                <div class="section">
                    <h2>Embed Code</h2>
                    <p style="margin-bottom: 10px; color: #6b7280;">Copy this code to embed the chat on your website:</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <input type="checkbox" id="embed-audio-enabled" checked>
                            <span>Enable audio notifications</span>
                        </label>
                        <button class="btn" onclick="updateEmbedCode()" style="font-size: 14px;">Update Code</button>
                    </div>
                    
                    <textarea id="embed-code" readonly style="width: 100%; height: 120px; font-family: monospace; resize: vertical; font-size: 12px;"></textarea>
                    <button class="btn btn-success" onclick="copyEmbedCode()" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    
                    <details style="margin-top: 15px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #374151;">URL Parameters</summary>
                        <ul style="margin-top: 10px; padding-left: 20px; color: #6b7280; font-size: 14px;">
                            <li><code>audio=true</code> - Enable audio notifications (default)</li>
                            <li><code>audio=false</code> - Disable audio notifications</li>
                        </ul>
                        <p style="margin-top: 10px; color: #6b7280; font-size: 13px;">
                            Example: <code style="background: white; padding: 2px 6px; border-radius: 3px;">https://yoursite.com/?audio=false</code>
                        </p>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('adminToken');
        let adminSessionToken = null; // Secure token for SSE connections
        let cachedSettings = null;

        // Pagination helper function
        function renderPagination(pagination, functionName) {
            if (!pagination || pagination.total_pages <= 1) return '';
            
            const { page, total_pages } = pagination;
            let pages = [];
            
            // Always show first page
            pages.push(1);
            
            // Show pages around current page
            for (let i = Math.max(2, page - 2); i <= Math.min(total_pages - 1, page + 2); i++) {
                if (!pages.includes(i)) pages.push(i);
            }
            
            // Always show last page
            if (!pages.includes(total_pages)) pages.push(total_pages);
            
            return `
                <div class="pagination" style="margin-top: 20px; display: flex; gap: 5px; justify-content: center; align-items: center;">
                    <button 
                        class="btn" 
                        ${page === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} 
                        onclick="${page === 1 ? 'return false' : functionName + '(' + (page - 1) + ')'}">
                        ‚Üê Prev
                    </button>
                    ${pages.map((p, i) => {
                        const prevPage = pages[i - 1];
                        const gap = prevPage && p - prevPage > 1 ? '<span style="padding: 0 5px;">...</span>' : '';
                        return `
                            ${gap}
                            <button 
                                class="btn ${p === page ? 'active' : ''}" 
                                onclick="${functionName}(${p})"
                                style="${p === page ? 'background: #667eea; color: white;' : ''}">
                                ${p}
                            </button>
                        `;
                    }).join('')}
                    <button 
                        class="btn" 
                        ${page === total_pages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} 
                        onclick="${page === total_pages ? 'return false' : functionName + '(' + (page + 1) + ')'}">
                        Next ‚Üí
                    </button>
                    <span style="margin-left: 15px; color: #6b7280; font-size: 14px;">
                        Page ${page} of ${total_pages} (${pagination.total} total)
                    </span>
                </div>
            `;
        }

        // Check authentication on load
        if (authToken) {
            showAdminPanel();
        } else {
            showLoginScreen();
        }

        function goBackToChat() {
            window.location.href = '/';
        }

        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-panel').classList.remove('active');
        }

        async function showAdminPanel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('admin-panel').classList.add('active');
            await loadAllData();
            // Connect to SSE stream for real-time notifications
            connectAdminStream();
        }

        async function login() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!username || !password) {
                errorDiv.textContent = 'Username and password are required';
                return;
            }
            
            // Test authentication with username:password format
            const credentials = `${username}:${password}`;
            
            try {
                // First, verify admin credentials
                const adminResponse = await fetch('/api/admin/messages.php?limit=1', {
                    headers: {
                        'Authorization': `Bearer ${credentials}`
                    }
                });

                if (!adminResponse.ok) {
                    if (adminResponse.status === 403) {
                        errorDiv.textContent = 'Access denied: Your role does not allow admin panel access';
                    } else {
                        errorDiv.textContent = 'Invalid username or password';
                    }
                    return;
                }

                // Now authenticate in the chat system and set up chat session
                const sessionId = 'chat_session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const loginResponse = await fetch('/api/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username, 
                        password,
                        sessionId
                    })
                });

                const loginData = await loginResponse.json();
                
                if (!loginResponse.ok || !loginData.success) {
                    errorDiv.textContent = loginData.error || 'Login failed';
                    return;
                }

                // Success! Set both admin and chat session data
                authToken = credentials;
                localStorage.setItem('adminToken', credentials);
                localStorage.setItem('isAdmin', 'true');
                
                // Also set up chat session data so user is logged into chat too
                localStorage.setItem('chatNickname', loginData.user.username);
                localStorage.setItem('userId', loginData.user.id);
                localStorage.setItem('chatSessionId', sessionId);
                localStorage.setItem('userRole', loginData.user.role);
                
                // Also set cookies for fallback/iframe compatibility
                const chatKeys = ['chatNickname', 'userId', 'chatSessionId', 'userRole'];
                chatKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    document.cookie = `${key}=${value}; path=/; SameSite=Lax`;
                    if (window.location.protocol === 'https:') {
                        document.cookie = `${key}=${value}; path=/; SameSite=None; Secure; Partitioned`;
                    }
                });
                
                // Create a secure session token for SSE connections
                const tokenCreated = await createAdminSessionToken();
                if (!tokenCreated) {
                    // Session token creation failed, but login succeeded
                    // This is non-critical - SSE notifications won't work but admin panel will
                    console.warn('‚ö†Ô∏è Warning: Could not create admin session token. Real-time notifications will not work.');
                    console.warn('This usually means Redis is unavailable. Check server logs.');
                }
                
                errorDiv.textContent = '';
                await showAdminPanel();
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
            }
        }

        async function createAdminSessionToken() {
            try {
                const response = await fetch('/api/admin/create-session.php', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (data.success && data.session_token) {
                    adminSessionToken = data.session_token;
                    console.log('‚úì Admin session token created successfully');
                    return true;
                } else {
                    console.error('Failed to create admin session token:', data.error || 'Unknown error');
                    // Check if the response indicates an auth issue
                    if (response.status === 401) {
                        console.error('Session token creation failed: Unauthorized. Try logging in again.');
                    }
                    return false;
                }
            } catch (error) {
                console.error('Error creating admin session token:', error);
                return false;
            }
        }

        function logout() {
            // Disconnect SSE streams
            disconnectAdminStream();
            disconnectImpersonateChatStream();
            
            authToken = null;
            adminSessionToken = null;
            localStorage.removeItem('adminToken');
            localStorage.removeItem('isAdmin'); // Remove admin flag
            
            // Also clear chat session data (both localStorage and cookies)
            const chatDataKeys = [
                'chatNickname',
                'userId', 
                'chatAge',
                'chatLocation',
                'chatSex',
                'chatSessionId',
                'chatSoundEnabled'
            ];
            
            chatDataKeys.forEach(key => {
                // Clear from localStorage
                localStorage.removeItem(key);
                
                // Clear from cookies (same way the chat does)
                document.cookie = `${key}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`;
                // Also try with Secure and Partitioned for HTTPS
                if (window.location.protocol === 'https:') {
                    document.cookie = `${key}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=None; Secure; Partitioned`;
                }
            });
            
            // If in an iframe context (embedded chat), reload to trigger re-login
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'logout' }, '*');
            }
            
            showLoginScreen();
        }

        // ============================================================================
        // ADMIN SSE STREAMING WITH RECONNECTION LOGIC
        // ============================================================================

        let adminStreamEventSource = null;
        let adminStreamReconnectAttempts = 0;
        let adminStreamMaxReconnectAttempts = 999; // Essentially unlimited
        let adminStreamReconnectDelay = 2000; // Start with 2 second delay
        let adminStreamMaxReconnectDelay = 30000; // Max 30 seconds between retries
        let adminStreamPeriodicReconnectTimer = null;
        
        // Impersonate chat streaming
        let impersonateChatEventSource = null;
        let impersonateChatReconnectAttempts = 0;
        let impersonateChatMaxReconnectAttempts = 999;
        let impersonateChatReconnectDelay = 2000;
        let impersonateChatMaxReconnectDelay = 30000;
        let impersonateChatPeriodicReconnectTimer = null;
        let currentImpersonateConversation = null; // Track current conversation

        function connectAdminStream() {
            // Close existing connection if any
            if (adminStreamEventSource) {
                adminStreamEventSource.close();
            }

            console.log('Connecting to admin notification stream...');

            try {
                // If session token is not available, try to create one first
                if (!adminSessionToken) {
                    console.warn('‚ö†Ô∏è No admin session token - attempting to create one...');
                    // Set a flag to prevent infinite retry loops
                    if (window.adminTokenCreationRetrying) {
                        console.warn('‚ö†Ô∏è Admin session token creation already in progress, skipping retry');
                        return;
                    }
                    
                    window.adminTokenCreationRetrying = true;
                    createAdminSessionToken().then((success) => {
                        window.adminTokenCreationRetrying = false;
                        if (success && adminSessionToken) {
                            console.log('‚úì Session token created, retrying connection...');
                            // Retry connection after token creation
                            connectAdminStream();
                        } else {
                            console.error('‚ùå Failed to create admin session token. Real-time notifications will not work.');
                            console.error('This usually means Redis is unavailable. Check your server configuration.');
                            // Don't retry further - user will need to refresh
                        }
                    }).catch(error => {
                        window.adminTokenCreationRetrying = false;
                        console.error('Error creating admin session token:', error);
                    });
                    return;
                }
                
                adminStreamEventSource = new EventSource(`/api/admin/stream.php?session_token=${encodeURIComponent(adminSessionToken)}`);

                adminStreamEventSource.addEventListener('open', () => {
                    console.log('Admin SSE stream connected');
                    adminStreamReconnectAttempts = 0;
                    // Clear periodic reconnect timer
                    if (adminStreamPeriodicReconnectTimer) {
                        clearInterval(adminStreamPeriodicReconnectTimer);
                    }
                    // Set up periodic reconnect every 95 seconds to avoid connection timeouts (Cloudflare limit)
                    adminStreamPeriodicReconnectTimer = setInterval(() => {
                        console.log('Periodic stream refresh (95s)...');
                        reconnectAdminStream();
                    }, 95000);
                });

                adminStreamEventSource.addEventListener('notification', (e) => {
                    try {
                        const notification = JSON.parse(e.data);
                        handleAdminNotificationEvent(notification);
                    } catch (error) {
                        console.error('Failed to parse notification event:', error);
                    }
                });

                adminStreamEventSource.addEventListener('message', (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        // Refresh message history if we're on the messages tab
                        const activeTab = document.querySelector('.tab-content.active');
                        if (activeTab && activeTab.id === 'messages-tab') {
                            console.log('New message received, refreshing message history...');
                            loadMessages(1); // Refresh to first page to show new messages
                        }
                    } catch (error) {
                        console.error('Failed to parse message event:', error);
                    }
                });

                adminStreamEventSource.addEventListener('error', (e) => {
                    console.error('Admin SSE error:', e);
                    adminStreamEventSource.close();
                    reconnectAdminStream();
                });

            } catch (error) {
                console.error('Failed to connect to admin stream:', error);
                reconnectAdminStream();
            }
        }

        function reconnectAdminStream() {
            if (adminStreamReconnectAttempts >= adminStreamMaxReconnectAttempts) {
                console.error('Max admin stream reconnection attempts reached');
                return;
            }

            adminStreamReconnectAttempts++;
            // Exponential backoff with max delay
            const delay = Math.min(adminStreamReconnectDelay * Math.pow(1.5, adminStreamReconnectAttempts - 1), adminStreamMaxReconnectDelay);

            console.log(`Admin stream reconnection attempt ${adminStreamReconnectAttempts} in ${Math.round(delay / 1000)}s...`);

            setTimeout(() => {
                connectAdminStream();
                // After reconnecting, fetch any missed notifications
                setTimeout(() => {
                    refreshNotifications();
                }, 500);
            }, delay);
        }

        function handleAdminNotificationEvent(notification) {
            // Update badge and re-render notifications
            updateNotificationBadge(notification.unread_count);
            
            // Refresh the notifications list
            refreshNotifications();
            
            // Play sound if enabled
            if (notification.unread_count > 0) {
                playNotificationSound();
            }
            
            // Show browser notification if permission granted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('RadioChatBox Admin', {
                    icon: 'üîî',
                    badge: 'üìª',
                    title: notification.title || 'New Notification',
                    body: notification.message || 'You have a new admin notification',
                    tag: 'radiochatbox-admin-' + (notification.id || Date.now()),
                    requireInteraction: true
                });
            }
        }

        function disconnectAdminStream() {
            if (adminStreamEventSource) {
                adminStreamEventSource.close();
                adminStreamEventSource = null;
            }
            if (adminStreamPeriodicReconnectTimer) {
                clearInterval(adminStreamPeriodicReconnectTimer);
                adminStreamPeriodicReconnectTimer = null;
            }
        }

        // ============================================================================
        // IMPERSONATE CHAT REAL-TIME STREAMING
        // ============================================================================

        function connectImpersonateChatStream(fakeUser, senderUsername) {
            // Store current conversation info
            currentImpersonateConversation = { fakeUser, senderUsername };
            
            // Close existing connection if any
            if (impersonateChatEventSource) {
                impersonateChatEventSource.close();
            }

            console.log(`Connecting to impersonate chat stream for ${fakeUser} <-> ${senderUsername}...`);

            try {
                const fakeSessionId = 'fake_' + md5(fakeUser);
                const url = `/api/stream.php?username=${encodeURIComponent(fakeUser)}&with_user=${encodeURIComponent(senderUsername)}&session_id=${encodeURIComponent(fakeSessionId)}&admin=true`;
                
                impersonateChatEventSource = new EventSource(url);

                impersonateChatEventSource.addEventListener('open', () => {
                    console.log('Impersonate chat stream connected');
                    impersonateChatReconnectAttempts = 0;
                    // Clear periodic reconnect timer
                    if (impersonateChatPeriodicReconnectTimer) {
                        clearInterval(impersonateChatPeriodicReconnectTimer);
                    }
                    // Set up periodic reconnect every 95 seconds
                    impersonateChatPeriodicReconnectTimer = setInterval(() => {
                        console.log('Periodic impersonate chat stream refresh (95s)...');
                        reconnectImpersonateChatStream();
                    }, 95000);
                });

                impersonateChatEventSource.addEventListener('private', (e) => {
                    try {
                        const messageData = JSON.parse(e.data);
                        handleImpersonateChatMessage(messageData);
                    } catch (error) {
                        console.error('Failed to parse impersonate chat message:', error);
                    }
                });

                impersonateChatEventSource.addEventListener('error', (e) => {
                    console.error('Impersonate chat stream error:', e);
                    impersonateChatEventSource.close();
                    reconnectImpersonateChatStream();
                });

            } catch (error) {
                console.error('Failed to connect to impersonate chat stream:', error);
                reconnectImpersonateChatStream();
            }
        }

        function reconnectImpersonateChatStream() {
            if (!currentImpersonateConversation) return;
            
            if (impersonateChatReconnectAttempts >= impersonateChatMaxReconnectAttempts) {
                console.error('Max impersonate chat stream reconnection attempts reached');
                return;
            }

            impersonateChatReconnectAttempts++;
            const delay = Math.min(impersonateChatReconnectDelay * Math.pow(1.5, impersonateChatReconnectAttempts - 1), impersonateChatMaxReconnectDelay);

            console.log(`Impersonate chat stream reconnection attempt ${impersonateChatReconnectAttempts} in ${Math.round(delay / 1000)}s...`);

            setTimeout(() => {
                connectImpersonateChatStream(currentImpersonateConversation.fakeUser, currentImpersonateConversation.senderUsername);
            }, delay);
        }

        function handleImpersonateChatMessage(message) {
            // Check if this message is for the current conversation we're viewing
            if (!currentImpersonateConversation) return;
            if (message.from_username !== currentImpersonateConversation.fakeUser && 
                message.from_username !== currentImpersonateConversation.senderUsername) return;
            if (message.to_username !== currentImpersonateConversation.fakeUser && 
                message.to_username !== currentImpersonateConversation.senderUsername) return;

            // Check if message already exists in the UI
            const messagesDiv = document.getElementById('impersonate-messages');
            const msgId = message.message_id || message.id;
            if (messagesDiv.querySelector(`[data-message-id="${msgId}"]`)) {
                return; // Message already displayed
            }

            // Add the new message to the UI
            const isFromFake = message.from_username === currentImpersonateConversation.fakeUser;
            
            const wrapperDiv = document.createElement('div');
            wrapperDiv.style.cssText = `display: flex; ${isFromFake ? 'justify-content: flex-end;' : 'justify-content: flex-start;'} margin: 8px 0;`;
            wrapperDiv.setAttribute('data-message-id', msgId);
            
            const msgDiv = document.createElement('div');
            msgDiv.style.cssText = `display: inline-block; padding: 12px 15px; border-radius: 12px; max-width: 70%; ${isFromFake ? 'background: #667eea; color: white; text-align: right;' : 'background: #f3f4f6; border: 1px solid #e5e7eb; text-align: left;'}`;
            
            // Parse timestamp robustly - handle various formats
            let timeStr = 'unknown time';
            if (message.created_at || message.timestamp) {
                try {
                    let timestamp;
                    const timeValue = message.created_at || message.timestamp;
                    
                    // If it's a Unix timestamp (number or numeric string)
                    if (typeof timeValue === 'number' || /^\d+$/.test(String(timeValue))) {
                        // Unix timestamp in seconds
                        timestamp = new Date(parseInt(timeValue) * 1000);
                    } else {
                        // ISO string or other format
                        timestamp = new Date(timeValue);
                    }
                    
                    // Check if date is valid
                    if (isNaN(timestamp.getTime())) {
                        console.warn('Invalid timestamp:', timeValue);
                    } else {
                        timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                } catch (e) {
                    console.error('Error parsing timestamp:', message.created_at || message.timestamp, e);
                }
            }
            
            let content = `
                <div style="font-size: 11px; ${isFromFake ? 'color: rgba(255,255,255,0.8);' : 'color: #6b7280;'} margin-bottom: 6px; font-weight: 600;">
                    ${escapeHtml(message.from_username)} ‚Ä¢ ${timeStr}
                </div>`;
            
            if (message.attachment && message.attachment.file_path) {
                content += `
                    <div style="margin-bottom: 8px;">
                        <img src="${escapeHtml(message.attachment.file_path)}" 
                             style="max-width: 250px; border-radius: 8px; cursor: pointer;" 
                             onclick="window.open('${escapeHtml(message.attachment.file_path)}', '_blank')">
                    </div>`;
            }
            
            if (message.message) {
                const formatted = formatImpersonateMessageText(message.message);
                content += `<div style="word-wrap: break-word; line-height: 1.4;">${formatted}</div>`;
            }
            
            msgDiv.innerHTML = content;
            wrapperDiv.appendChild(msgDiv);
            messagesDiv.appendChild(wrapperDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function disconnectImpersonateChatStream() {
            if (impersonateChatEventSource) {
                impersonateChatEventSource.close();
                impersonateChatEventSource = null;
            }
            if (impersonateChatPeriodicReconnectTimer) {
                clearInterval(impersonateChatPeriodicReconnectTimer);
                impersonateChatPeriodicReconnectTimer = null;
            }
            currentImpersonateConversation = null;
        }

        function switchTab(tabName, updateHistory = true) {
            // Update sidebar navigation
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (navItem) navItem.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) tabContent.classList.add('active');
            
            // Disconnect impersonate chat stream when leaving impersonate tab
            if (tabName !== 'impersonate') {
                disconnectImpersonateChatStream();
            }
            
            // Hide user detail panels when switching tabs
            const userDetailsPanel = document.getElementById('user-details');
            const inactiveUserDetailsPanel = document.getElementById('inactive-user-details');
            if (userDetailsPanel) {
                userDetailsPanel.style.display = 'none';
            }
            if (inactiveUserDetailsPanel) {
                inactiveUserDetailsPanel.style.display = 'none';
            }
            
            // Show the main content sections for users and inactive-users tabs
            if (tabName === 'users') {
                const usersTable = document.getElementById('users-table');
                if (usersTable && usersTable.parentElement) {
                    usersTable.parentElement.style.display = 'block';
                }
            } else if (tabName === 'inactive-users') {
                const inactiveUsersSection = document.getElementById('inactive-users-section');
                if (inactiveUsersSection) {
                    inactiveUsersSection.style.display = 'block';
                }
            }
            
            // Update page title
            const titles = {
                'dashboard': {title: 'Dashboard', subtitle: 'Overview and key metrics'},
                'messages': {title: 'Message History', subtitle: 'View and manage all messages'},
                'users': {title: 'Active Users', subtitle: 'Currently online users'},
                'inactive-users': {title: 'Inactive Users', subtitle: 'Users who have left the chat'},
                'admin-users': {title: 'User Management', subtitle: 'Manage administrative accounts'},
                'fake-users': {title: 'Fake Users', subtitle: 'Manage automated users'},
                'notifications': {title: 'Notifications', subtitle: 'Admin alerts and notifications'},
                'impersonate': {title: 'Impersonate', subtitle: 'Reply as fake users'},
                'ip-bans': {title: 'IP Bans', subtitle: 'Blocked IP addresses'},
                'nickname-bans': {title: 'Nickname Bans', subtitle: 'Blocked usernames'},
                'url-whitelist': {title: 'URL Whitelist', subtitle: 'Allowed URLs in public messages'},
                'url-blacklist': {title: 'URL Blacklist', subtitle: 'Blocked URLs and domains'},
                'photos': {title: 'Photo Gallery', subtitle: 'User uploaded images'},
                'settings': {title: 'System Settings', subtitle: 'Configure chat behavior'},
                'statistics': {title: 'Statistics Dashboard', subtitle: 'View and analyze chat analytics'}
            };
            
            if (titles[tabName]) {
                document.getElementById('page-title').textContent = titles[tabName].title;
                document.getElementById('page-subtitle').textContent = titles[tabName].subtitle;
                // Update browser title
                document.title = `${titles[tabName].title} - Admin Panel`;
            }
            
            // Update browser history
            if (updateHistory) {
                const url = new URL(window.location);
                url.hash = tabName;
                history.pushState({ tab: tabName }, '', url);
            }
            
            // Auto-load data when switching to certain tabs
            if (tabName === 'impersonate') {
                refreshImpersonateConversations();
            } else if (tabName === 'notifications') {
                refreshNotifications();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'dashboard') {
                loadDashboardKPIs();
                // Start live refresh for dashboard (every 10 seconds)
                clearInterval(window.dashboardRefreshInterval); // Clear any existing interval
                window.dashboardRefreshInterval = setInterval(() => {
                    loadDashboardKPIs();
                }, 10000);
            } else if (tabName === 'messages') {
                loadMessages(1);
                // Start live refresh for messages (every 20 seconds)
                clearInterval(window.messagesRefreshInterval); // Clear any existing interval
                window.messagesRefreshInterval = setInterval(() => {
                    loadMessages(1);
                }, 20000);
            } else if (tabName === 'statistics') {
                loadStatsTab('summary');
            } else if (tabName === 'url-whitelist') {
                loadUrlWhitelist();
            } else if (tabName === 'url-blacklist') {
                loadUrlBlacklist();
            } else {
                // Stop dashboard refresh when switching away from dashboard
                clearInterval(window.dashboardRefreshInterval);
                window.dashboardRefreshInterval = null;
                // Stop messages refresh when switching away from messages
                clearInterval(window.messagesRefreshInterval);
                window.messagesRefreshInterval = null;
            }
            
            // Close mobile sidebar when switching tabs
            closeMobileSidebar();
        }
        
        // Wrap switchTab to handle nickname-bans tab refresh
        (function() {
            const origSwitchTab = switchTab;
            switchTab = function(tabName, updateHistory = true) {
                origSwitchTab(tabName, updateHistory);
                if (tabName === 'nickname-bans') loadKickedUsers();
            };
        })();
        
        // Handle browser back/forward navigation
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.tab) {
                switchTab(event.state.tab, false);
            } else {
                // Handle hash-based navigation for initial load
                const hash = window.location.hash.substring(1);
                if (hash.startsWith('user-details/')) {
                    // Load user details from URL
                    const username = decodeURIComponent(hash.substring('user-details/'.length));
                    switchTab('users', false);
                    setTimeout(() => viewUserDetails(username), 100);
                } else if (hash.startsWith('inactive-user/')) {
                    // Load inactive user details from URL
                    const username = decodeURIComponent(hash.substring('inactive-user/'.length));
                    switchTab('inactive-users', false);
                    setTimeout(() => viewInactiveUserDetails(username), 100);
                } else {
                    const tab = hash || 'dashboard';
                    switchTab(tab, false);
                }
            }
        });
        
        // Load initial tab from URL hash on page load
        window.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash.substring(1);
            
            if (hash.startsWith('user-details/')) {
                // Load user details from URL
                const username = decodeURIComponent(hash.substring('user-details/'.length));
                switchTab('users', false);
                setTimeout(() => viewUserDetails(username), 100);
            } else if (hash.startsWith('inactive-user/')) {
                // Load inactive user details from URL
                const username = decodeURIComponent(hash.substring('inactive-user/'.length));
                switchTab('inactive-users', false);
                setTimeout(() => viewInactiveUserDetails(username), 100);
            } else {
                const initialTab = hash || 'dashboard';
                // Replace state for initial load so back button works correctly
                history.replaceState({ tab: initialTab }, '', window.location);
                if (hash) {
                    switchTab(initialTab, false);
                }
            }
        });
        
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }
        
        async function loadDashboardKPIs() {
            try {
                // Verify authToken is set
                if (!authToken) {
                    console.error('loadDashboardKPIs: authToken not set');
                    return;
                }
                
                console.log('Loading dashboard KPIs with authToken:', authToken.substring(0, 20) + '...');
                
                // Cache element references to avoid null errors
                const kpiActiveUsersEl = document.getElementById('kpi-active-users');
                const kpiMessagesTodayEl = document.getElementById('kpi-messages-today');
                const kpiFakeUsersEl = document.getElementById('kpi-fake-users');
                const kpiIpBansEl = document.getElementById('kpi-ip-bans');
                const kpiListenersEl = document.getElementById('kpi-listeners');
                const kpiListenersNowEl = document.getElementById('kpi-listeners-now');
                
                // Load active users count (real users only)
                try {
                    const usersResponse = await fetch('/api/admin/active-users.php', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (usersResponse.ok) {
                        const usersData = await usersResponse.json();
                        if (usersData.success && kpiActiveUsersEl) {
                            // Count only real users (exclude fake users)
                            const realUsersCount = usersData.users.filter(u => !u.is_fake).length;
                            kpiActiveUsersEl.textContent = realUsersCount;
                        }
                    } else {
                        console.warn('Active users response not ok:', usersResponse.status);
                    }
                } catch (e) {
                    console.error('Failed to load active users:', e);
                }
                
                // Load today's stats from summary
                try {
                    const statsResponse = await fetch('/api/admin/stats.php?granularity=summary', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        if (statsData.data && statsData.data.today && kpiMessagesTodayEl) {
                            // Use aggregated today's messages from stats
                            kpiMessagesTodayEl.textContent = statsData.data.today.total_messages || 0;
                        }
                    } else {
                        console.warn('Stats response not ok:', statsResponse.status);
                    }
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
                
                // Load messages for recent messages dashboard
                try {
                    const messagesResponse = await fetch('/api/admin/messages.php?limit=100', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (messagesResponse.ok) {
                        const messagesData = await messagesResponse.json();
                        if (messagesData.success) {
                            const includePrivate = messagesData.include_private || false;
                            const chatMode = messagesData.chat_mode || 'both';
                            loadDashboardRecentMessages(messagesData.messages.slice(0, 100), includePrivate, chatMode);
                            
                            // Recent Messages section is always visible regardless of chat mode
                        }
                    } else {
                        console.warn('Messages response not ok:', messagesResponse.status);
                    }
                } catch (e) {
                    console.error('Failed to load messages:', e);
                }
                
                // Load fake users
                try {
                    const fakeUsersResponse = await fetch('/api/admin/fake-users.php', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (fakeUsersResponse.ok) {
                        const fakeUsersData = await fakeUsersResponse.json();
                        if (fakeUsersData.success && kpiFakeUsersEl) {
                            const activeFake = fakeUsersData.users.filter(u => u.is_active).length;
                            kpiFakeUsersEl.textContent = activeFake;
                        }
                    }
                } catch (e) {
                    console.error('Failed to load fake users:', e);
                }
                
                // Load IP bans
                try {
                    const bansResponse = await fetch('/api/admin/ban-ip.php', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (bansResponse.ok) {
                        const bansData = await bansResponse.json();
                        if (bansData.success && kpiIpBansEl) {
                            kpiIpBansEl.textContent = bansData.banned_ips.length;
                        }
                    }
                } catch (e) {
                    console.error('Failed to load IP bans:', e);
                }
                
                // Load radio status (Shoutcast listeners)
                try {
                    const radioResponse = await fetch('/api/now-playing.php');
                    if (radioResponse.ok) {
                        const radioData = await radioResponse.json();
                        const kpiListenersCard = document.getElementById('kpi-listeners-card');
                        
                        if (kpiListenersEl && radioData.success && radioData.nowPlaying && radioData.nowPlaying.active) {
                            // Radio is enabled and active - show the widget
                            if (kpiListenersCard) {
                                kpiListenersCard.style.display = '';
                            }
                            
                            const listeners = radioData.nowPlaying.listeners ?? '-';
                            kpiListenersEl.textContent = listeners;
                            
                            // Show what's playing
                            let nowPlayingText = 'Now Playing';
                            if (radioData.nowPlaying.display) {
                                nowPlayingText = radioData.nowPlaying.display.substring(0, 50);
                                if (radioData.nowPlaying.display.length > 50) {
                                    nowPlayingText += '...';
                                }
                            }
                            if (kpiListenersNowEl) {
                                kpiListenersNowEl.textContent = nowPlayingText;
                            }
                        }
                    }
                } catch (e) {
                    console.error('Failed to load radio status:', e);
                }
            } catch (error) {
                console.error('Failed to load dashboard KPIs:', error);
            }
        }
        
        // Store all dashboard messages globally for filtering
        let allDashboardMessages = [];
        let dashboardIncludesPrivate = false;
        let dashboardChatMode = 'both';
        
        function loadDashboardRecentMessages(messages, includePrivate = false, chatMode = 'both') {
            allDashboardMessages = messages || [];
            dashboardIncludesPrivate = includePrivate;
            dashboardChatMode = chatMode;
            
            // Show/hide filter dropdown - only show if both types are available and user can see them
            const filterDropdown = document.getElementById('dashboard-message-filter');
            const subtitle = document.getElementById('dashboard-messages-subtitle');
            
            const showFilter = includePrivate && chatMode === 'both';
            if (showFilter && filterDropdown) {
                filterDropdown.style.display = '';
                if (subtitle) subtitle.textContent = 'Last 10 public and private messages';
            } else {
                if (filterDropdown) filterDropdown.style.display = 'none';
                if (subtitle) {
                    if (chatMode === 'private') {
                        subtitle.textContent = 'Last 10 private messages';
                    } else {
                        subtitle.textContent = 'Last 10 public messages';
                    }
                }
            }
            
            // Apply current filter
            filterDashboardMessages();
        }
        
        function filterDashboardMessages() {
            const container = document.getElementById('dashboard-recent-messages');
            const filterDropdown = document.getElementById('dashboard-message-filter');
            const filter = filterDropdown ? filterDropdown.value : 'all';
            
            let filteredMessages = allDashboardMessages;
            
            if (dashboardIncludesPrivate && filter !== 'all') {
                filteredMessages = allDashboardMessages.filter(msg => {
                    const isPrivate = msg.message_type === 'private';
                    if (filter === 'public') return !isPrivate;
                    if (filter === 'private') return isPrivate;
                    return true;
                });
            }
            
            // Limit to 10 messages
            filteredMessages = filteredMessages.slice(0, 10);
            
            if (!filteredMessages || filteredMessages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 40px;">No messages yet</p>';
                return;
            }
            
            let html = '<table><thead><tr>';
            if (dashboardIncludesPrivate) html += '<th>Type</th>';
            html += '<th>Time</th><th>User</th><th>Message</th></tr></thead><tbody>';
            
            filteredMessages.forEach(msg => {
                const isPrivate = msg.message_type === 'private';
                const rowStyle = isPrivate ? 'background: #fff7ed;' : '';
                
                // Handle both Unix timestamps and ISO datetime strings from database
                const date = typeof msg.timestamp === 'number' 
                    ? new Date(msg.timestamp * 1000) 
                    : new Date(msg.timestamp || msg.created_at);
                const time = isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleString();
                
                const displayUser = isPrivate ? `${escapeHtml(msg.from_username)} ‚Üí ${escapeHtml(msg.to_username)}` : escapeHtml(msg.username);
                
                html += `
                    <tr style="${rowStyle}">
                        ${dashboardIncludesPrivate ? `<td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; ${isPrivate ? 'background: #fed7aa; color: #9a3412;' : 'background: #dbeafe; color: #1e40af;'}">${isPrivate ? 'DM' : 'PUBLIC'}</span></td>` : ''}
                        <td>${time}</td>
                        <td><strong>${displayUser}</strong></td>
                        <td>${escapeHtml(msg.message.substring(0, 100))}${msg.message.length > 100 ? '...' : ''}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function loadAllData() {
            await loadCurrentUser();  // Load current user first to determine role
            await loadDashboardKPIs(); // Load dashboard metrics
            await loadMessages();
            await loadIPBans();
            await loadNicknameBans();
            await loadUsers();
            await loadInactiveUsers();
            await loadFakeUsers();
            await loadSettings();
            await loadUrlBlacklist();
            await loadPhotos();
            
            // Initialize GIF settings for impersonate
            try {
                if (!cachedSettings) {
                    const settingsRes = await fetch('/api/settings.php');
                    cachedSettings = await settingsRes.json();
                }
                if (cachedSettings && cachedSettings.success) {
                    // Show GIF button if Tenor API key is configured
                    const tenorKey = cachedSettings.settings.tenor_api_key || '';
                    const gifEnabled = cachedSettings.settings.gif_enabled === 'true' || cachedSettings.settings.gif_enabled === '1';
                    if ((gifEnabled && tenorKey.trim()) || tenorKey.trim()) {
                        impersonateTenorApiKey = tenorKey;
                        const gifBtn = document.getElementById('impersonate-gif-button');
                        if (gifBtn) {
                            gifBtn.style.display = 'inline-block';
                            gifBtn.style.visibility = 'visible';
                        }
                    }
                }
            } catch (err) {
                console.error('Failed to load GIF settings:', err);
            }
            
            // Only load admin users if user has permission
            if (currentUserRole !== 'moderator') {
                await loadAdminUsers();
            }
        }

        async function clearPublicChat() {
            if (!confirm('Are you sure you want to clear all public chat messages?\n\nThis will hide all messages from users, but they will remain in the database logs for admin viewing.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/clear-chat.php', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Public chat cleared! ${data.deleted_count} messages hidden.`);
                    loadMessages(1); // Reload messages to show updated state
                } else {
                    alert('Failed to clear chat: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to clear chat:', error);
                alert('Failed to clear chat');
            }
        }

        async function flushRedisCache() {
            if (!confirm('Are you sure you want to flush the Redis cache?\n\nThis will:\n- Clear all cached messages (will reload from database)\n- Clear all cached settings\n- Clear all rate limit counters\n- Clear all active user sessions\n\nUsers will need to reconnect.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/flush-redis.php', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Redis cache flushed successfully!\n\nCleared: ${data.keys_cleared} keys`);
                    // Reload data since cache is now empty
                    loadMessages(1);
                    loadUsers();
                    loadSettings();
                } else {
                    alert('Failed to flush Redis: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to flush Redis:', error);
                alert('Failed to flush Redis cache');
            }
        }

        async function loadMessages(page = 1) {
            try {
                const filterDropdown = document.getElementById('message-type-filter');
                const filter = filterDropdown ? filterDropdown.value : 'all';
                
                const response = await fetch(`/api/admin/messages.php?page=${page}&limit=20&type=${filter}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('messages-table');
                    const pagination = data.pagination;
                    const includePrivate = data.include_private || false;
                    const chatMode = data.chat_mode || 'both';
                    
                    // Show/hide filter dropdown only if both message types are available and user can see them
                    if (filterDropdown) {
                        const showFilter = includePrivate && chatMode === 'both';
                        filterDropdown.style.display = showFilter ? '' : 'none';
                    }
                    
                    // Update subtitle to show what's being displayed
                    const subtitle = document.getElementById('message-history-subtitle');
                    if (subtitle) {
                        if (!includePrivate) {
                            subtitle.textContent = 'View and manage all public messages';
                        } else if (chatMode === 'public') {
                            subtitle.textContent = 'View and manage all public messages';
                        } else if (chatMode === 'private') {
                            subtitle.textContent = 'View and manage all private messages';
                        } else {
                            const filterText = filter === 'public' ? 'public' : filter === 'private' ? 'private' : 'public and private';
                            subtitle.textContent = `Viewing ${filterText} messages`;
                        }
                    }
                    
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    ${includePrivate ? '<th>Type</th>' : ''}
                                    <th>Time</th>
                                    ${includePrivate ? '<th>From</th><th>To</th>' : '<th>Username</th>'}
                                    <th>Message</th>
                                    ${!includePrivate ? '<th>IP</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.messages.map(msg => {
                                    const isPrivate = msg.message_type === 'private';
                                    const rowStyle = isPrivate ? 'background: #fff7ed;' : '';
                                    return `
                                    <tr style="${rowStyle}">
                                        ${includePrivate ? `<td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; ${isPrivate ? 'background: #fed7aa; color: #9a3412;' : 'background: #dbeafe; color: #1e40af;'}">${isPrivate ? 'DM' : 'PUBLIC'}</span></td>` : ''}
                                        <td>${new Date(msg.created_at).toLocaleString()}</td>
                                        ${includePrivate 
                                            ? `<td>${escapeHtml(isPrivate ? msg.from_username : msg.username)}</td><td>${isPrivate ? escapeHtml(msg.to_username) : '-'}</td>`
                                            : `<td>${escapeHtml(msg.username)}</td>`
                                        }
                                        <td>${escapeHtml(msg.message)}</td>
                                        ${!includePrivate ? `<td>${msg.ip_address}</td>` : ''}
                                    </tr>
                                `;
                                }).join('')}
                            </tbody>
                        </table>
                        ${renderPagination(pagination, 'loadMessages')}
                    `;
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        async function loadIPBans() {
            try {
                const response = await fetch('/api/admin/ban-ip.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('ip-bans-table');
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>Reason</th>
                                    <th>Banned At</th>
                                    <th>Expires</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.banned_ips.map(ban => `
                                    <tr>
                                        <td>${ban.ip_address}</td>
                                        <td>${escapeHtml(ban.reason || 'N/A')}</td>
                                        <td>${new Date(ban.banned_at).toLocaleString()}</td>
                                        <td>${ban.banned_until ? new Date(ban.banned_until).toLocaleString() : 'Permanent'}</td>
                                        <td>
                                            <button class="btn btn-success" onclick="unbanIP('${ban.ip_address}')">Unban</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load IP bans:', error);
            }
        }

        async function loadNicknameBans() {
            try {
                const response = await fetch('/api/admin/ban-nickname.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('nickname-bans-table');
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Nickname</th>
                                    <th>Reason</th>
                                    <th>Banned At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.banned_nicknames.map(ban => `
                                    <tr>
                                        <td>${escapeHtml(ban.nickname)}</td>
                                        <td>${escapeHtml(ban.reason || 'N/A')}</td>
                                        <td>${new Date(ban.banned_at).toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-success" onclick="unbanNickname('${escapeHtml(ban.nickname)}')">Unban</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load nickname bans:', error);
            }
        }

        // Fake Users Functions
        async function loadFakeUsers() {
            try {
                const response = await fetch('/api/admin/list-fake-users.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('fake-users-table');
                    
                    if (data.fake_users.length === 0) {
                        table.innerHTML = '<p style="color: #6b7280; padding: 20px; text-align: center;">No fake users created yet. Add one above!</p>';
                        return;
                    }
                    
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Nickname</th>
                                    <th>Age</th>
                                    <th>Sex</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.fake_users.map(user => `
                                    <tr>
                                        <td>${escapeHtml(user.nickname)}</td>
                                        <td>${user.age || 'N/A'}</td>
                                        <td>${user.sex || 'N/A'}</td>
                                        <td>${escapeHtml(user.location || 'N/A')}</td>
                                        <td>
                                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; ${user.is_active ? 'background: #10b981; color: white;' : 'background: #6b7280; color: white;'}">
                                                ${user.is_active ? 'üü¢ Active' : '‚ö´ Inactive'}
                                            </span>
                                        </td>
                                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn btn-secondary" onclick="toggleFakeUser(${user.id})" style="margin-right: 5px;">
                                                ${user.is_active ? 'Deactivate' : 'Activate'}
                                            </button>
                                            <button class="btn btn-danger" onclick="deleteFakeUser(${user.id}, '${escapeHtml(user.nickname).replace(/'/g, "\\'")}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load fake users:', error);
            }
        }

        async function addFakeUser() {
            const nickname = document.getElementById('fake-nickname').value.trim();
            const ageInput = document.getElementById('fake-age');
            const age = ageInput.value;
            const sexSelect = document.getElementById('fake-sex');
            const sex = sexSelect.value;
            const locationSelect = document.getElementById('fake-location');
            const location = locationSelect.value;

            // Validate nickname
            if (!nickname) {
                alert('Nickname is required');
                return;
            }

            if (nickname.length < 3) {
                alert('Nickname must be at least 3 characters');
                return;
            }

            // Check if profile fields are required
            if (ageInput.required || sexSelect.required || locationSelect.required) {
                if (!age || !sex || !location) {
                    alert('Age, Sex, and Country are required when "Require Profile" is enabled in settings');
                    return;
                }
            }

            // Validate age if provided
            if (age && (parseInt(age) < 18 || parseInt(age) > 99)) {
                alert('Age must be between 18 and 99');
                return;
            }

            try {
                const response = await fetch('/api/admin/add-fake-user.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        nickname,
                        age: age ? parseInt(age) : null,
                        sex: sex || null,
                        location: location || null
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Fake user added successfully');
                    document.getElementById('fake-nickname').value = '';
                    document.getElementById('fake-age').value = '';
                    document.getElementById('fake-sex').value = '';
                    document.getElementById('fake-location').value = '';
                    loadFakeUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to add fake user:', error);
                alert('Failed to add fake user');
            }
        }

        async function toggleFakeUser(id) {
            try {
                const response = await fetch('/api/admin/toggle-fake-user.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id })
                });

                const data = await response.json();
                
                if (data.success) {
                    loadFakeUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to toggle fake user:', error);
                alert('Failed to toggle fake user');
            }
        }

        async function deleteFakeUser(id, nickname) {
            if (!confirm(`Are you sure you want to delete fake user "${nickname}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/delete-fake-user.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Fake user deleted successfully');
                    loadFakeUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to delete fake user:', error);
                alert('Failed to delete fake user');
            }
        }

        async function banIP() {
            const ipAddress = document.getElementById('ban-ip-address').value;
            const reason = document.getElementById('ban-ip-reason').value;
            const duration = document.getElementById('ban-ip-duration').value;

            try {
                const response = await fetch('/api/admin/ban-ip.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        ip_address: ipAddress,
                        reason: reason,
                        duration_days: duration ? parseInt(duration) : null
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('IP banned successfully');
                    document.getElementById('ban-ip-address').value = '';
                    document.getElementById('ban-ip-reason').value = '';
                    document.getElementById('ban-ip-duration').value = '';
                    loadIPBans();
                } else {
                    alert('Failed to ban IP: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function unbanIP(ipAddress) {
            if (!confirm(`Unban IP ${ipAddress}?`)) return;

            try {
                const response = await fetch('/api/admin/ban-ip.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ ip_address: ipAddress })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('IP unbanned successfully');
                    loadIPBans();
                } else {
                    alert('Failed to unban IP');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function banNickname() {
            const nickname = document.getElementById('ban-nickname-name').value;
            const reason = document.getElementById('ban-nickname-reason').value;

            try {
                const response = await fetch('/api/admin/ban-nickname.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        nickname: nickname,
                        reason: reason
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Nickname banned successfully');
                    document.getElementById('ban-nickname-name').value = '';
                    document.getElementById('ban-nickname-reason').value = '';
                    loadNicknameBans();
                } else {
                    alert('Failed to ban nickname: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function unbanNickname(nickname) {
            if (!confirm(`Unban nickname "${nickname}"?`)) return;

            try {
                const response = await fetch('/api/admin/ban-nickname.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ nickname: nickname })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Nickname unbanned successfully');
                    loadNicknameBans();
                } else {
                    alert('Failed to unban nickname');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/active-users.php');
                const data = await response.json();

                if (data.success) {
                    const isRootOrOwner = currentUserRole === 'root' || currentUserRole === 'owner';
                    
                    // Filter users based on role
                    const displayUsers = isRootOrOwner ? data.users : data.users.filter(u => !u.is_fake);
                    
                    const table = document.getElementById('users-table');
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    ${isRootOrOwner ? '<th>Type</th>' : ''}
                                    <th>Joined At</th>
                                    <th>Last Heartbeat</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${displayUsers.map(user => `
                                    <tr>
                                        <td>${escapeHtml(user.username)}</td>
                                        ${isRootOrOwner ? `<td>${user.is_fake ? '<span style="color: #f59e0b;">Fake</span>' : '<span style="color: #10b981;">Real</span>'}</td>` : ''}
                                        <td>${user.joined_at ? new Date(user.joined_at).toLocaleString() : '<em style="color: #9ca3af;">N/A</em>'}</td>
                                        <td>${user.last_heartbeat ? new Date(user.last_heartbeat).toLocaleString() : '<em style="color: #9ca3af;">N/A</em>'}</td>
                                        <td>
                                            <button class="btn" onclick="viewUserDetails(\`${user.username.replace(/`/g, '\\`')}\`)">View Details</button>
                                            <button class="btn btn-danger" onclick="kickUser(\`${user.username.replace(/`/g, '\\`')}\`)">Kick</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        async function viewUserDetails(username, page = 1, search = '') {
            try {
                const response = await fetch(`/api/admin/user-details.php?username=${encodeURIComponent(username)}&page=${page}&limit=10&search=${encodeURIComponent(search)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    // Update URL hash
                    const url = new URL(window.location);
                    url.hash = `user-details/${encodeURIComponent(username)}`;
                    history.pushState({ tab: 'users', username: username }, '', url);
                    
                    const user = data.user;
                    const pagination = data.pagination;
                    document.getElementById('user-details-name').textContent = username;
                    
                    let profileHtml = '';
                    if (user.profile) {
                        profileHtml = `
                            <h3>Profile</h3>
                            <p><strong>Age:</strong> ${escapeHtml(user.profile.age || 'N/A')}</p>
                            <p><strong>Sex:</strong> ${escapeHtml(user.profile.sex || 'N/A')}</p>
                            <p><strong>Location:</strong> ${escapeHtml(user.profile.location || 'N/A')}</p>
                        `;
                    }

                    let ipHtml = '<h3>IP Addresses & Sessions</h3>';
                    
                    // Show active session if available
                    if (user.active_session) {
                        ipHtml += `
                            <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                                <p style="margin: 0 0 8px 0;"><strong style="color: #3b82f6;">üü¢ Active Session</strong></p>
                                <p style="margin: 4px 0;"><strong>IP Address:</strong> ${escapeHtml(user.active_session.ip_address)}</p>
                                <p style="margin: 4px 0;"><strong>Session ID:</strong> ${escapeHtml(user.active_session.session_id)}</p>
                                <p style="margin: 4px 0;"><strong>Joined:</strong> ${new Date(user.active_session.joined_at).toLocaleString()}</p>
                                <p style="margin: 4px 0;"><strong>Last Activity:</strong> ${new Date(user.active_session.last_heartbeat).toLocaleString()}</p>
                            </div>
                        `;
                    }
                    
                    // Show historical IP addresses
                    if (user.ip_addresses.length > 0) {
                        ipHtml += '<p><strong>Historical IP Addresses:</strong></p><ul>';
                        user.ip_addresses.forEach(ip => {
                            ipHtml += `<li>${ip.ip_address} - First seen: ${new Date(ip.first_seen).toLocaleString()}</li>`;
                        });
                        ipHtml += '</ul>';
                    } else if (!user.active_session) {
                        ipHtml += '<p>No IP address data available</p>';
                    }

                    // Search field for messages
                    let searchHtml = `
                        <div style="margin: 20px 0;">
                            <input type="text" id="user-search-field" placeholder="Search messages..." style="padding: 8px 12px; width: 300px; max-width: 100%; border: 1px solid #ccc; border-radius: 4px;">
                            <button class="btn btn-sm" onclick="searchUserMessages('${escapeHtml(username)}')">Search</button>
                        </div>
                    `;

                    // Pagination controls for messages
                    let paginationHtml = '';
                    if (pagination.total_pages > 1) {
                        paginationHtml = `<div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">`;
                        
                        if (pagination.page > 1) {
                            paginationHtml += `<button class="btn btn-sm" onclick="viewUserDetails('${escapeHtml(username)}', 1)">‚èÆ First</button>`;
                            paginationHtml += `<button class="btn btn-sm" onclick="viewUserDetails('${escapeHtml(username)}', ${pagination.page - 1})">‚Üê Previous</button>`;
                        }
                        
                        paginationHtml += `<span style="min-width: 150px;">Page ${pagination.page} of ${pagination.total_pages}</span>`;
                        
                        if (pagination.page < pagination.total_pages) {
                            paginationHtml += `<button class="btn btn-sm" onclick="viewUserDetails('${escapeHtml(username)}', ${pagination.page + 1})">Next ‚Üí</button>`;
                            paginationHtml += `<button class="btn btn-sm" onclick="viewUserDetails('${escapeHtml(username)}', ${pagination.total_pages})">Last ‚è≠</button>`;
                        }
                        
                        paginationHtml += `</div>`;
                    }

                    let messagesHtml = `<h3>Messages (${pagination.total_messages} total)</h3>
                        ${paginationHtml}
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    user.messages.forEach(msg => {
                        messagesHtml += `
                            <tr>
                                <td>${new Date(msg.created_at).toLocaleString()}</td>
                                <td>${escapeHtml(msg.message)}</td>
                            </tr>
                        `;
                    });
                    messagesHtml += `</tbody></table>${paginationHtml}`;
                    
                    // Private messages - show as conversation list
                    let privateMessagesHtml = '<h3>Private Conversations</h3>';
                    if (user.private_messages && user.private_messages.length > 0) {
                        // Group by conversation partner
                        const conversations = {};
                        user.private_messages.forEach(msg => {
                            const partner = msg.from_username === username ? msg.to_username : msg.from_username;
                            if (!conversations[partner]) {
                                conversations[partner] = [];
                            }
                            conversations[partner].push(msg);
                        });
                        
                        privateMessagesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
                        Object.keys(conversations).forEach(partner => {
                            const count = conversations[partner].length;
                            privateMessagesHtml += `
                                <button class="btn" onclick="viewConversation('${escapeHtml(username)}', '${escapeHtml(partner)}')">
                                    üí¨ ${escapeHtml(partner)} (${count})
                                </button>
                            `;
                        });
                        privateMessagesHtml += '</div>';
                        privateMessagesHtml += '<div id="conversation-thread" style="display: none;"></div>';
                    } else {
                        privateMessagesHtml += '<p>No private messages</p>';
                    }

                    document.getElementById('user-details-content').innerHTML = 
                        profileHtml + ipHtml + messagesHtml + privateMessagesHtml;
                    
                    // Store private messages data for conversation viewing
                    window.currentUserPrivateMessages = user.private_messages || [];
                    
                    // Hide active users table and show details
                    const usersTable = document.getElementById('users-table');
                    if (usersTable && usersTable.parentElement) {
                        usersTable.parentElement.style.display = 'none';
                    }
                    
                    document.getElementById('user-details').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load user details:', error);
                alert('Failed to load user details');
            }
        }

        function closeUserDetails() {
            document.getElementById('user-details').style.display = 'none';
            const usersTable = document.getElementById('users-table');
            if (usersTable && usersTable.parentElement) {
                usersTable.parentElement.style.display = 'block';
            }
            // Update URL hash to remove username
            const url = new URL(window.location);
            url.hash = 'users';
            history.pushState({ tab: 'users' }, '', url);
        }

        async function viewInactiveUserDetails(username, page = 1, search = '') {
            try {
                const response = await fetch(`/api/admin/user-details.php?username=${encodeURIComponent(username)}&page=${page}&limit=10&search=${encodeURIComponent(search)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    // Update URL hash
                    const url = new URL(window.location);
                    url.hash = `inactive-user/${encodeURIComponent(username)}`;
                    history.pushState({ tab: 'inactive-users', username: username }, '', url);
                    
                    const user = data.user;
                    const pagination = data.pagination;
                    document.getElementById('inactive-user-details-name').textContent = username;
                    
                    let profileHtml = '';
                    if (user.profile) {
                        profileHtml = `
                            <h3>Profile</h3>
                            <p><strong>Age:</strong> ${escapeHtml(user.profile.age || 'N/A')}</p>
                            <p><strong>Sex:</strong> ${escapeHtml(user.profile.sex || 'N/A')}</p>
                            <p><strong>Location:</strong> ${escapeHtml(user.profile.location || 'N/A')}</p>
                        `;
                    }

                    let ipHtml = '<h3>IP Addresses & Sessions</h3>';
                    
                    // Show active session if available
                    if (user.active_session) {
                        ipHtml += `
                            <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                                <p style="margin: 0 0 8px 0;"><strong style="color: #3b82f6;">üü¢ Active Session</strong></p>
                                <p style="margin: 4px 0;"><strong>IP Address:</strong> ${escapeHtml(user.active_session.ip_address)}</p>
                                <p style="margin: 4px 0;"><strong>Session ID:</strong> ${escapeHtml(user.active_session.session_id)}</p>
                                <p style="margin: 4px 0;"><strong>Joined:</strong> ${new Date(user.active_session.joined_at).toLocaleString()}</p>
                                <p style="margin: 4px 0;"><strong>Last Activity:</strong> ${new Date(user.active_session.last_heartbeat).toLocaleString()}</p>
                            </div>
                        `;
                    }
                    
                    // Show historical IP addresses
                    if (user.ip_addresses.length > 0) {
                        ipHtml += '<p><strong>Historical IP Addresses:</strong></p><ul>';
                        user.ip_addresses.forEach(ip => {
                            ipHtml += `<li>${ip.ip_address} - First seen: ${new Date(ip.first_seen).toLocaleString()}</li>`;
                        });
                        ipHtml += '</ul>';
                    } else if (!user.active_session) {
                        ipHtml += '<p>No IP address data available</p>';
                    }

                    // Search field for messages
                    let searchHtml = `
                        <div style="margin: 20px 0;">
                            <input type="text" id="inactive-search-field" placeholder="Search messages..." style="padding: 8px 12px; width: 300px; max-width: 100%; border: 1px solid #ccc; border-radius: 4px;">
                            <button class="btn btn-sm" onclick="searchInactiveUserMessages('${escapeHtml(username)}')">Search</button>
                        </div>
                    `;

                    // Pagination controls for messages
                    let paginationHtml = '';
                    if (pagination.total_pages > 1) {
                        paginationHtml = `<div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">`;
                        
                        if (pagination.page > 1) {
                            paginationHtml += `<button class="btn btn-sm" onclick="viewInactiveUserDetails('${escapeHtml(username)}', 1)">‚èÆ First</button>`;
                            paginationHtml += `<button class="btn btn-sm" onclick="viewInactiveUserDetails('${escapeHtml(username)}', ${pagination.page - 1})">‚Üê Previous</button>`;
                        }
                        
                        paginationHtml += `<span style="min-width: 150px;">Page ${pagination.page} of ${pagination.total_pages}</span>`;
                        
                        if (pagination.page < pagination.total_pages) {
                            paginationHtml += `<button class="btn btn-sm" onclick="viewInactiveUserDetails('${escapeHtml(username)}', ${pagination.page + 1})">Next ‚Üí</button>`;
                            paginationHtml += `<button class="btn btn-sm" onclick="viewInactiveUserDetails('${escapeHtml(username)}', ${pagination.total_pages})">Last ‚è≠</button>`;
                        }
                        
                        paginationHtml += `</div>`;
                    }

                    let messagesHtml = `<h3>Messages (${pagination.total_messages} total)</h3>
                        ${searchHtml}
                        ${paginationHtml}
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    user.messages.forEach(msg => {
                        messagesHtml += `
                            <tr>
                                <td>${new Date(msg.created_at).toLocaleString()}</td>
                                <td>${escapeHtml(msg.message)}</td>
                            </tr>
                        `;
                    });
                    messagesHtml += `</tbody></table>${paginationHtml}`;
                    
                    // Private messages - show as conversation list
                    let privateMessagesHtml = '<h3>Private Conversations</h3>';
                    if (user.private_messages && user.private_messages.length > 0) {
                        // Group by conversation partner
                        const conversations = {};
                        user.private_messages.forEach(msg => {
                            const partner = msg.from_username === username ? msg.to_username : msg.from_username;
                            if (!conversations[partner]) {
                                conversations[partner] = [];
                            }
                            conversations[partner].push(msg);
                        });
                        
                        privateMessagesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
                        Object.keys(conversations).forEach(partner => {
                            const count = conversations[partner].length;
                            privateMessagesHtml += `
                                <button class="btn" onclick="viewConversation('${escapeHtml(username)}', '${escapeHtml(partner)}')">
                                    üí¨ ${escapeHtml(partner)} (${count})
                                </button>
                            `;
                        });
                        privateMessagesHtml += '</div>';
                        privateMessagesHtml += '<div id="conversation-thread" style="display: none;"></div>';
                    } else {
                        privateMessagesHtml += '<p>No private messages</p>';
                    }

                    document.getElementById('inactive-user-details-content').innerHTML = 
                        profileHtml + ipHtml + messagesHtml + privateMessagesHtml;
                    
                    // Store private messages data for conversation viewing
                    window.currentUserPrivateMessages = user.private_messages || [];
                    
                    document.getElementById('inactive-users-section').style.display = 'none';
                    document.getElementById('inactive-user-details').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load user details:', error);
                alert('Failed to load user details');
            }
        }

        function closeInactiveUserDetails() {
            document.getElementById('inactive-user-details').style.display = 'none';
            document.getElementById('inactive-users-section').style.display = 'block';
            // Update URL hash to remove username
            const url = new URL(window.location);
            url.hash = 'inactive-users';
            history.pushState({ tab: 'inactive-users' }, '', url);
        }
        
        function searchUserMessages(username) {
            const searchField = document.getElementById('user-search-field');
            if (searchField) {
                const searchTerm = searchField.value;
                // Fetch user details with search query, starting from page 1
                viewUserDetails(username, 1, searchTerm);
            }
        }
        
        function searchInactiveUserMessages(username) {
            const searchField = document.getElementById('inactive-search-field');
            if (searchField) {
                const searchTerm = searchField.value;
                // Fetch user details with search query, starting from page 1
                viewInactiveUserDetails(username, 1, searchTerm);
            }
        }
        
        function viewConversation(user1, user2) {
            // Find the conversation thread in the currently visible section
            let thread = null;
            const activeDetails = document.getElementById('user-details');
            const inactiveDetails = document.getElementById('inactive-user-details');
            
            if (activeDetails && activeDetails.style.display !== 'none') {
                thread = activeDetails.querySelector('#conversation-thread');
            } else if (inactiveDetails && inactiveDetails.style.display !== 'none') {
                thread = inactiveDetails.querySelector('#conversation-thread');
            }
            
            if (!thread || !window.currentUserPrivateMessages) return;
            
            // Filter messages for this conversation
            const conversationMessages = window.currentUserPrivateMessages.filter(msg => 
                (msg.from_username === user1 && msg.to_username === user2) ||
                (msg.from_username === user2 && msg.to_username === user1)
            ).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            let html = `
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0;">üí¨ Conversation: ${escapeHtml(user1)} ‚Üî ${escapeHtml(user2)}</h4>
                        <button class="btn" onclick="closeConversation()">‚úï Close</button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 6px;">
            `;
            
            conversationMessages.forEach(msg => {
                const isSentByUser1 = msg.from_username === user1;
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: ${isSentByUser1 ? '#eff6ff' : '#f3f4f6'}; border-radius: 6px; border-left: 3px solid ${isSentByUser1 ? '#667eea' : '#9ca3af'};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong style="color: ${isSentByUser1 ? '#667eea' : '#1f2937'};">${escapeHtml(msg.from_username)}</strong>
                            <small style="color: #6b7280;">${new Date(msg.created_at).toLocaleString()}</small>
                        </div>
                        <div style="color: #374151;">${escapeHtml(msg.message)}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            thread.innerHTML = html;
            thread.style.display = 'block';
        }
        
        function closeConversation() {
            // Find and close the conversation thread in whichever section is visible
            const threads = document.querySelectorAll('#conversation-thread');
            threads.forEach(thread => {
                thread.style.display = 'none';
                thread.innerHTML = '';
            });
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/settings.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('setting-page-title').value = settings.page_title || 'RadioChatBox';
                    document.getElementById('setting-radio-status-url').value = settings.radio_status_url || '';
                    document.getElementById('setting-color-scheme').value = settings.color_scheme || 'dark';
                    document.getElementById('setting-chat-mode').value = settings.chat_mode || 'public';
                    document.getElementById('setting-require-profile').checked = settings.require_profile === 'true';
                    document.getElementById('setting-allow-photo-uploads').checked = settings.allow_photo_uploads === 'true';
                    document.getElementById('setting-gif-enabled').checked = settings.gif_enabled === 'true';
                    document.getElementById('setting-tenor-api-key').value = settings.tenor_api_key || '';
                    
                    // Update fake user form requirements based on require_profile
                    updateFakeUserFormRequirements(settings.require_profile === 'true');
                    
                    // Set photo size with PHP limit
                    const photoSizeInput = document.getElementById('setting-max-photo-size-mb');
                    const phpMaxUpload = settings.php_max_upload_mb || 50;
                    photoSizeInput.max = phpMaxUpload;
                    photoSizeInput.value = settings.max_photo_size_mb || '5';
                    
                    // Update hint text
                    const hintElement = document.getElementById('php-max-upload-hint');
                    if (hintElement) {
                        hintElement.textContent = `Server maximum: ${phpMaxUpload} MB`;
                    }
                    
                    // Minimum users (fake users feature)
                    document.getElementById('setting-minimum-users').value = settings.minimum_users || '0';
                    
                    document.getElementById('setting-rate-limit-messages').value = settings.rate_limit_messages || '10';
                    document.getElementById('setting-rate-limit-window').value = settings.rate_limit_window || '60';
                    
                    // Load SEO & Branding settings
                    document.getElementById('setting-site-title').value = settings.site_title || '';
                    document.getElementById('setting-site-description').value = settings.site_description || '';
                    document.getElementById('setting-site-keywords').value = settings.site_keywords || '';
                    document.getElementById('setting-brand-name').value = settings.brand_name || 'RadioChatBox';
                    document.getElementById('setting-brand-color').value = settings.brand_color || '#007bff';
                    document.getElementById('setting-logo-url').value = settings.logo_url || '';
                    document.getElementById('setting-favicon-url').value = settings.favicon_url || '';
                    
                    // Load Analytics settings
                    document.getElementById('setting-analytics-enabled').checked = settings.analytics_enabled === 'true';
                    document.getElementById('setting-analytics-provider').value = settings.analytics_provider || '';
                    document.getElementById('setting-analytics-tracking-id').value = settings.analytics_tracking_id || '';
                    
                    // Load Advertisement settings
                    document.getElementById('setting-ads-enabled').checked = settings.ads_enabled === 'true';
                    document.getElementById('setting-ads-main-top').value = settings.ads_main_top || '';
                    document.getElementById('setting-ads-main-bottom').value = settings.ads_main_bottom || '';
                    document.getElementById('setting-ads-chat-sidebar').value = settings.ads_chat_sidebar || '';
                    document.getElementById('setting-ads-refresh-enabled').checked = settings.ads_refresh_enabled === 'true';
                    document.getElementById('setting-ads-refresh-interval').value = settings.ads_refresh_interval || '30';
                    
                    // Load Custom Scripts
                    document.getElementById('setting-header-scripts').value = settings.header_scripts || '';
                    document.getElementById('setting-body-scripts').value = settings.body_scripts || '';
                    
                    // Generate embed code
                    updateEmbedCode();
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        async function uploadLogo(type) {
            const inputId = type === 'favicon' ? 'favicon-upload' : 'logo-upload';
            const statusId = type === 'favicon' ? 'favicon-upload-status' : 'logo-upload-status';
            const urlInputId = type === 'favicon' ? 'setting-favicon-url' : 'setting-logo-url';
            
            const fileInput = document.getElementById(inputId);
            const statusSpan = document.getElementById(statusId);
            const urlInput = document.getElementById(urlInputId);
            
            if (!fileInput.files || !fileInput.files[0]) {
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('File too large. Maximum size is 2MB.');
                fileInput.value = '';
                return;
            }
            
            statusSpan.textContent = 'Uploading...';
            statusSpan.style.color = '#666';
            
            try {
                const formData = new FormData();
                formData.append('logo', file);
                formData.append('type', type);
                
                const response = await fetch('/api/admin/upload-logo.php', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    urlInput.value = data.url;
                    statusSpan.textContent = '‚úì Uploaded';
                    statusSpan.style.color = '#10b981';
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    // Clear status after 3 seconds
                    setTimeout(() => {
                        statusSpan.textContent = '';
                    }, 3000);
                } else {
                    statusSpan.textContent = '‚úó Failed: ' + (data.error || 'Unknown error');
                    statusSpan.style.color = '#ef4444';
                }
            } catch (error) {
                statusSpan.textContent = '‚úó Error: ' + error.message;
                statusSpan.style.color = '#ef4444';
            }
        }

        async function saveSettings() {
            // Validate photo size before submitting
            const photoSizeInput = document.getElementById('setting-max-photo-size-mb');
            const photoSize = parseInt(photoSizeInput.value);
            const maxAllowed = parseInt(photoSizeInput.max);
            
            if (photoSize > maxAllowed) {
                alert(`Photo size cannot exceed ${maxAllowed}MB (PHP server limit)`);
                return;
            }
            
            if (photoSize < 1) {
                alert('Photo size must be at least 1MB');
                return;
            }
            
            const settings = {
                page_title: document.getElementById('setting-page-title').value,
                radio_status_url: document.getElementById('setting-radio-status-url').value,
                color_scheme: document.getElementById('setting-color-scheme').value,
                chat_mode: document.getElementById('setting-chat-mode').value,
                require_profile: document.getElementById('setting-require-profile').checked ? 'true' : 'false',
                allow_photo_uploads: document.getElementById('setting-allow-photo-uploads').checked ? 'true' : 'false',
                gif_enabled: document.getElementById('setting-gif-enabled').checked ? 'true' : 'false',
                tenor_api_key: document.getElementById('setting-tenor-api-key').value,
                max_photo_size_mb: document.getElementById('setting-max-photo-size-mb').value,
                minimum_users: document.getElementById('setting-minimum-users').value,
                rate_limit_messages: document.getElementById('setting-rate-limit-messages').value,
                rate_limit_window: document.getElementById('setting-rate-limit-window').value,
                
                // SEO & Branding
                site_title: document.getElementById('setting-site-title').value,
                site_description: document.getElementById('setting-site-description').value,
                site_keywords: document.getElementById('setting-site-keywords').value,
                brand_name: document.getElementById('setting-brand-name').value,
                brand_color: document.getElementById('setting-brand-color').value,
                logo_url: document.getElementById('setting-logo-url').value,
                favicon_url: document.getElementById('setting-favicon-url').value,
                
                // Analytics
                analytics_enabled: document.getElementById('setting-analytics-enabled').checked ? 'true' : 'false',
                analytics_provider: document.getElementById('setting-analytics-provider').value,
                analytics_tracking_id: document.getElementById('setting-analytics-tracking-id').value,
                
                // Advertisements
                ads_enabled: document.getElementById('setting-ads-enabled').checked ? 'true' : 'false',
                ads_main_top: document.getElementById('setting-ads-main-top').value,
                ads_main_bottom: document.getElementById('setting-ads-main-bottom').value,
                ads_chat_sidebar: document.getElementById('setting-ads-chat-sidebar').value,
                ads_refresh_enabled: document.getElementById('setting-ads-refresh-enabled').checked ? 'true' : 'false',
                ads_refresh_interval: document.getElementById('setting-ads-refresh-interval').value,
                
                // Custom Scripts
                header_scripts: document.getElementById('setting-header-scripts').value,
                body_scripts: document.getElementById('setting-body-scripts').value,
            };

            try {
                const response = await fetch('/api/admin/settings.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Settings saved successfully!');
                    loadSettings();
                } else {
                    alert('Failed to save settings: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function updateEmbedCode() {
            const audioEnabled = document.getElementById('embed-audio-enabled').checked;
            const currentUrl = window.location.origin;
            const audioParam = audioEnabled ? '' : '?audio=false';
            
            const embedCode = `<iframe 
    src="${currentUrl}${audioParam}" 
    width="100%" 
    height="600" 
    frameborder="0"
    allow="autoplay"
    style="border: 1px solid #e5e7eb; border-radius: 8px;">
</iframe>`;
            
            document.getElementById('embed-code').value = embedCode;
        }

        function copyEmbedCode() {
            const embedCode = document.getElementById('embed-code');
            embedCode.select();
            document.execCommand('copy');
            alert('Embed code copied to clipboard!');
        }
        
        async function kickUser(username) {
            if (!confirm(`Are you sure you want to kick "${username}" from the chat?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/kick-user.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ username: username })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('User kicked successfully!');
                    loadUsers();
                    loadInactiveUsers();
                } else {
                    alert('Failed to kick user: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function loadInactiveUsers(page = 1) {
            try {
                const response = await fetch(`/api/admin/inactive-users.php?page=${page}&limit=20`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('inactive-users-table');
                    const pagination = data.pagination;
                    
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Profile</th>
                                    <th>Last Message</th>
                                    <th>Message Count</th>
                                    <th>IP Address</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => {
                                    let profile = '';
                                    if (user.age) profile += `${user.age}y `;
                                    if (user.sex) profile += `${user.sex} `;
                                    if (user.location) profile += user.location;
                                    
                                    return `
                                    <tr>
                                        <td>${escapeHtml(user.username)}</td>
                                        <td>${escapeHtml(profile || 'N/A')}</td>
                                        <td>${user.last_message_at ? new Date(user.last_message_at).toLocaleString() : 'Never'}</td>
                                        <td>${user.message_count || 0}</td>
                                        <td>${user.ip_address}</td>
                                        <td>
                                            <button class="btn" onclick="viewInactiveUserDetails(\`${user.username.replace(/`/g, '\\`')}\`)">View Details</button>
                                        </td>
                                    </tr>
                                `;
                                }).join('')}
                            </tbody>
                        </table>
                        ${renderPagination(pagination, 'loadInactiveUsers')}
                    `;
                }
            } catch (error) {
                console.error('Failed to load inactive users:', error);
            }
        }
        
        async function loadUrlWhitelist() {
            try {
                const response = await fetch('/api/admin/url-whitelist.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('url-whitelist-table');
                    table.innerHTML = `
                        <p style="margin-bottom: 10px;"><strong>Total patterns:</strong> ${data.patterns.length}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Pattern</th>
                                    <th>Description</th>
                                    <th>Added By</th>
                                    <th>Added At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.patterns.length === 0 ? '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No patterns added yet</td></tr>' : 
                                data.patterns.map(item => `
                                    <tr>
                                        <td><code>${item.pattern}</code></td>
                                        <td>${item.description || '-'}</td>
                                        <td>${item.added_by || 'admin'}</td>
                                        <td>${new Date(item.added_at).toLocaleString()}</td>
                                        <td>
                                            <button class="btn-danger" onclick="deleteWhitelistPattern(${item.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load URL whitelist:', error);
            }
        }
        
        async function addUrlWhitelist() {
            const pattern = document.getElementById('new-whitelist-pattern').value.trim();
            const description = document.getElementById('new-whitelist-description').value.trim();
            
            if (!pattern) {
                alert('Please enter a URL pattern');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/url-whitelist.php', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pattern, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('new-whitelist-pattern').value = '';
                    document.getElementById('new-whitelist-description').value = '';
                    loadUrlWhitelist();
                } else {
                    alert(data.error || 'Failed to add pattern');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }
        
        async function deleteWhitelistPattern(id) {
            if (!confirm('Are you sure you want to delete this pattern?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/url-whitelist.php?id=${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadUrlWhitelist();
                } else {
                    alert(data.error || 'Failed to delete pattern');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }
        
        async function loadUrlBlacklist() {
            try {
                const response = await fetch('/api/admin/url-blacklist.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('url-blacklist-table');
                    table.innerHTML = `
                        <p style="margin-bottom: 10px;"><strong>Total patterns:</strong> ${data.patterns.length}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Pattern</th>
                                    <th>Description</th>
                                    <th>Added By</th>
                                    <th>Added At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.patterns.length === 0 ? '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No patterns added yet</td></tr>' : 
                                data.patterns.map(item => `
                                    <tr>
                                        <td><code>${item.pattern}</code></td>
                                        <td>${item.description || '-'}</td>
                                        <td>${item.added_by || 'admin'}</td>
                                        <td>${new Date(item.added_at).toLocaleString()}</td>
                                        <td>
                                            <button class="btn-danger" onclick="deleteUrlPattern(${item.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load URL blacklist:', error);
            }
        }
        
        async function addUrlBlacklist() {
            const pattern = document.getElementById('new-url-pattern').value.trim();
            const description = document.getElementById('new-url-description').value.trim();
            
            if (!pattern) {
                alert('Please enter a URL pattern');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/url-blacklist.php', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pattern, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('new-url-pattern').value = '';
                    document.getElementById('new-url-description').value = '';
                    loadUrlBlacklist();
                } else {
                    alert(data.error || 'Failed to add pattern');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }
        
        async function deleteUrlPattern(id) {
            if (!confirm('Are you sure you want to delete this pattern?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/url-blacklist.php?id=${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadUrlBlacklist();
                } else {
                    alert(data.error || 'Failed to delete pattern');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        // Photos Management
        async function loadPhotos(page = 1) {
            try {
                const response = await fetch(`/api/admin/photos.php?action=list&page=${page}&limit=20`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('photos-table');
                    const photos = data.photos;
                    const pagination = data.pagination;
                    
                    if (photos.length === 0) {
                        table.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No photos uploaded yet</p>';
                        return;
                    }
                    
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Preview</th>
                                    <th>Filename</th>
                                    <th>Uploaded By</th>
                                    <th>Recipient</th>
                                    <th>Size</th>
                                    <th>Dimensions</th>
                                    <th>Uploaded</th>
                                    <th>Expires</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${photos.map(photo => `
                                    <tr>
                                        <td>
                                            <a href="${photo.file_path}" target="_blank">
                                                <img src="${photo.file_path}" style="max-width: 80px; max-height: 60px; border-radius: 4px;" alt="Preview">
                                            </a>
                                        </td>
                                        <td><code>${photo.filename}</code></td>
                                        <td>
                                            <a href="#" onclick="loadPhotosByUser('${photo.uploaded_by}'); return false;" style="color: #3b82f6;">
                                                ${photo.uploaded_by}
                                            </a>
                                        </td>
                                        <td>${photo.recipient || '-'}</td>
                                        <td>${formatFileSize(photo.file_size)}</td>
                                        <td>${photo.width}√ó${photo.height}</td>
                                        <td>${new Date(photo.uploaded_at).toLocaleString()}</td>
                                        <td>${new Date(photo.expires_at).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${renderPagination(pagination, 'loadPhotos')}
                    `;
                }
            } catch (error) {
                console.error('Error loading photos:', error);
            }
        }

        async function loadPhotosByUser(username) {
            try {
                const response = await fetch(`/api/admin/photos.php?action=by_user&username=${encodeURIComponent(username)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('photos-table');
                    const photos = data.photos;
                    
                    table.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <button class="btn" onclick="loadPhotos()">‚Üê Back to All Photos</button>
                            <h3 style="display: inline; margin-left: 20px;">Photos by ${username}</h3>
                        </div>
                        ${photos.length === 0 ? '<p style="color: #9ca3af;">No photos found</p>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Preview</th>
                                    <th>Filename</th>
                                    <th>Recipient</th>
                                    <th>Size</th>
                                    <th>Dimensions</th>
                                    <th>Uploaded</th>
                                    <th>Expires</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${photos.map(photo => `
                                    <tr>
                                        <td>
                                            <a href="${photo.file_path}" target="_blank">
                                                <img src="${photo.file_path}" style="max-width: 80px; max-height: 60px; border-radius: 4px;" alt="Preview">
                                            </a>
                                        </td>
                                        <td><code>${photo.filename}</code></td>
                                        <td>${photo.recipient || '-'}</td>
                                        <td>${formatFileSize(photo.file_size)}</td>
                                        <td>${photo.width}√ó${photo.height}</td>
                                        <td>${new Date(photo.uploaded_at).toLocaleString()}</td>
                                        <td>${new Date(photo.expires_at).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <p style="margin-top: 20px; color: #6b7280;">
                            Total: ${photos.length} photo${photos.length !== 1 ? 's' : ''}
                        </p>
                        `}
                    `;
                }
            } catch (error) {
                console.error('Error loading photos by user:', error);
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Initialize fake user form with country dropdown
        function initializeFakeUserForm() {
                        // Populate age select (18-90)
                        const ageSelect = document.getElementById('fake-age');
                        if (ageSelect) {
                            ageSelect.innerHTML = '<option value="">Select Age</option>';
                            for (let i = 18; i <= 90; i++) {
                                ageSelect.innerHTML += `<option value="${i}">${i}</option>`;
                            }
                        }
            const locationSelect = document.getElementById('fake-location');
            console.log('COUNTRIES:', typeof COUNTRIES, COUNTRIES);
            if (locationSelect && typeof COUNTRIES !== 'undefined' && Array.isArray(COUNTRIES)) {
                locationSelect.innerHTML = '<option value="">Select Country</option>';
                COUNTRIES.forEach((country, idx) => {
                    console.log('Adding country', idx, country);
                    const option = document.createElement('option');
                    option.value = country.code;
                    option.textContent = `${country.flag} ${country.name}`;
                    if (country.code === 'GR') {
                        option.selected = true;
                    }
                    locationSelect.appendChild(option);
                });
            } else if (locationSelect) {
                // Fallback if COUNTRIES is not loaded
                locationSelect.innerHTML = '<option value="GR" selected>üá¨üá∑ Greece</option>';
            }
        }

        // Update form based on require_profile setting
        function updateFakeUserFormRequirements(requireProfile) {
            const ageInput = document.getElementById('fake-age');
            const sexSelect = document.getElementById('fake-sex');
            const locationSelect = document.getElementById('fake-location');
            const profileNote = document.getElementById('fake-user-profile-note');
            const ageRequired = document.getElementById('fake-age-required');
            const sexRequired = document.getElementById('fake-sex-required');
            const locationRequired = document.getElementById('fake-location-required');

            if (requireProfile) {
                ageInput.required = true;
                sexSelect.required = true;
                locationSelect.required = true;
                profileNote.style.display = 'block';
                ageRequired.style.display = 'inline';
                sexRequired.style.display = 'inline';
                locationRequired.style.display = 'inline';
            } else {
                ageInput.required = false;
                sexSelect.required = false;
                locationSelect.required = false;
                profileNote.style.display = 'none';
                ageRequired.style.display = 'none';
                sexRequired.style.display = 'none';
                locationRequired.style.display = 'none';
            }
        }

        // ============================================================================
        // ADMIN USERS MANAGEMENT
        // ============================================================================

        let currentUserRole = null;
        let currentUsername = null;

        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/admin/current-user.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUserRole = data.user.role;
                    currentUsername = data.user.username;
                    
                    // Update header user info
                    document.getElementById('user-name').textContent = data.user.username;
                    document.getElementById('user-avatar').textContent = data.user.username.charAt(0).toUpperCase();
                    
                    applyRoleBasedRestrictions(data.user.role);

                    // Connect to notifications stream
                    connectNotificationsStream();
                }
            } catch (error) {
                console.error('Failed to load current user:', error);
                // Assume root for legacy auth
                currentUserRole = 'root';
                document.getElementById('user-role').textContent = 'root';

                // Connect to notifications stream for legacy auth
                connectNotificationsStream();
            }
        }

        function applyRoleBasedRestrictions(role) {
            // Hide/show nav items based on role
            const adminUsersNav = document.getElementById('nav-admin-users');
            const settingsNav = document.getElementById('nav-settings');
            const impersonateNav = document.getElementById('nav-impersonate');
            const notificationsNav = document.getElementById('nav-notifications');
            const fakeUsersNav = document.querySelector('.nav-item[data-tab="fake-users"]');
            const fakeUsersKpi = document.querySelector('.kpi-card:has(#kpi-fake-users)');
            const manageFakeUsersBtn = document.querySelector('button[onclick*="fake-users"]');
            const minimumUsersGroup = document.getElementById('setting-minimum-users-group');

            // Update user role display
            document.getElementById('user-role').textContent = role;

            if (role === 'moderator') {
                if (adminUsersNav) adminUsersNav.style.display = 'none';
                if (settingsNav) settingsNav.style.display = 'none';
                if (impersonateNav) impersonateNav.style.display = 'none';
                if (notificationsNav) notificationsNav.style.display = 'none';
                if (fakeUsersNav) fakeUsersNav.style.display = 'none';
                if (fakeUsersKpi) fakeUsersKpi.style.display = 'none';
                if (manageFakeUsersBtn) manageFakeUsersBtn.style.display = 'none';
                if (minimumUsersGroup) minimumUsersGroup.style.display = 'none';
            } else if (role === 'root' || role === 'owner') {
                // Show all features for root/owner
                if (impersonateNav) impersonateNav.style.display = 'flex';
                if (notificationsNav) notificationsNav.style.display = 'flex';
                if (fakeUsersNav) fakeUsersNav.style.display = 'flex';
                if (fakeUsersKpi) fakeUsersKpi.style.display = 'block';
                if (manageFakeUsersBtn) manageFakeUsersBtn.style.display = 'flex';
                if (minimumUsersGroup) minimumUsersGroup.style.display = 'block';
            } else if (role === 'administrator') {
                // Administrators can view notifications but not impersonate
                if (notificationsNav) notificationsNav.style.display = 'flex';
                if (fakeUsersNav) fakeUsersNav.style.display = 'none';
                if (fakeUsersKpi) fakeUsersKpi.style.display = 'none';
                if (manageFakeUsersBtn) manageFakeUsersBtn.style.display = 'none';
                if (impersonateNav) impersonateNav.style.display = 'none';
                if (minimumUsersGroup) minimumUsersGroup.style.display = 'none';
            }
        }

        async function loadAdminUsers() {
            try {
                const response = await fetch('/api/admin/users.php?include_inactive=true', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const table = document.getElementById('admin-users-table');
                    
                    if (data.users.length === 0) {
                        table.innerHTML = '<p style="color: #6b7280; padding: 20px; text-align: center;">No admin users found</p>';
                        return;
                    }
                    
                    const getRoleBadge = (role) => {
                        const badges = {
                            'root': '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üî¥ ROOT</span>',
                            'administrator': '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üü† ADMIN</span>',
                            'moderator': '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üü° MOD</span>',
                            'simple_user': '<span style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ö´ USER</span>'
                        };
                        return badges[role] || role;
                    };
                    
                    table.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => `
                                    <tr>
                                        <td><strong>${escapeHtml(user.username)}</strong></td>
                                        <td>${getRoleBadge(user.role)}</td>
                                        <td>${escapeHtml(user.email || 'N/A')}</td>
                                        <td>
                                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; ${user.is_active ? 'background: #10b981; color: white;' : 'background: #6b7280; color: white;'}">
                                                ${user.is_active ? '‚úì Active' : '‚úó Inactive'}
                                            </span>
                                        </td>
                                        <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn" onclick="editAdminUser(${user.id})" style="font-size: 13px;">
                                                Edit
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load admin users:', error);
            }
        }

        async function createAdminUser() {
            const username = document.getElementById('new-admin-username').value.trim();
            const password = document.getElementById('new-admin-password').value;
            const email = document.getElementById('new-admin-email').value.trim();
            const role = document.getElementById('new-admin-role').value;

            if (!username || !password || !role) {
                alert('Username, password, and role are required');
                return;
            }

            if (password.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }

            try {
                const response = await fetch('/api/admin/create-user.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        role,
                        email: email || null
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(`User "${username}" created successfully!`);
                    closeCreateUserModal();
                    loadAdminUsers();
                } else {
                    alert('Error: ' + (data.error || 'Failed to create user'));
                }
            } catch (error) {
                console.error('Failed to create admin user:', error);
                alert('Failed to create admin user');
            }
        }

        let editingUserId = null;

        async function editAdminUser(userId) {
            try {
                const response = await fetch('/api/admin/users.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const user = data.users.find(u => u.id === userId);
                    if (!user) {
                        alert('User not found');
                        return;
                    }
                    
                    editingUserId = userId;
                    const isOwnAccount = user.username === currentUsername;
                    
                    document.getElementById('edit-admin-user-id').value = user.id;
                    document.getElementById('edit-admin-username').value = user.username;
                    document.getElementById('edit-admin-email').value = user.email || '';
                    document.getElementById('edit-admin-role').value = user.role;
                    document.getElementById('edit-admin-is-active').checked = user.is_active;
                    document.getElementById('edit-admin-password').value = '';
                    
                    // Disable role and active status if editing own account
                    const roleSelect = document.getElementById('edit-admin-role');
                    const activeCheckbox = document.getElementById('edit-admin-is-active');
                    
                    if (isOwnAccount) {
                        roleSelect.disabled = true;
                        activeCheckbox.disabled = true;
                        roleSelect.title = 'You cannot change your own role';
                        activeCheckbox.title = 'You cannot deactivate your own account';
                    } else {
                        roleSelect.disabled = false;
                        activeCheckbox.disabled = false;
                        roleSelect.title = '';
                        activeCheckbox.title = '';
                    }
                    
                    // Hide users list, show edit form
                    const table = document.getElementById('admin-users-table');
                    if (table && table.parentElement) {
                        table.parentElement.style.display = 'none';
                    }
                    document.getElementById('edit-admin-user-modal').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load user for editing:', error);
                alert('Failed to load user details');
            }
        }

        function closeEditAdminUserModal() {
            document.getElementById('edit-admin-user-modal').style.display = 'none';
            const table = document.getElementById('admin-users-table');
            if (table && table.parentElement) {
                table.parentElement.style.display = 'block';
            }
            editingUserId = null;
        }

        function openCreateUserModal() {
            document.getElementById('create-user-modal-overlay').style.display = 'flex';
            // Clear form fields
            document.getElementById('new-admin-username').value = '';
            document.getElementById('new-admin-password').value = '';
            document.getElementById('new-admin-email').value = '';
            document.getElementById('new-admin-role').value = '';
        }

        function closeCreateUserModal() {
            document.getElementById('create-user-modal-overlay').style.display = 'none';
        }

        async function saveAdminUser() {
            const userId = parseInt(document.getElementById('edit-admin-user-id').value);
            const password = document.getElementById('edit-admin-password').value;
            const email = document.getElementById('edit-admin-email').value.trim();
            const role = document.getElementById('edit-admin-role').value;
            const isActive = document.getElementById('edit-admin-is-active').checked;

            const updates = {
                user_id: userId,
                role,
                email: email || null,
                is_active: isActive
            };

            if (password) {
                if (password.length < 8) {
                    alert('Password must be at least 8 characters');
                    return;
                }
                updates.password = password;
            }

            try {
                const response = await fetch('/api/admin/update-user.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(updates)
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('User updated successfully!');
                    closeEditAdminUserModal();
                    loadAdminUsers();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update user'));
                }
            } catch (error) {
                console.error('Failed to update admin user:', error);
                alert('Failed to update admin user');
            }
        }

        async function deleteAdminUser() {
            const userId = parseInt(document.getElementById('edit-admin-user-id').value);
            const username = document.getElementById('edit-admin-username').value;

            // Prevent deleting yourself
            if (username === currentUsername) {
                alert('You cannot delete your own account. For security reasons, ask another administrator to delete your account if needed.');
                return;
            }

            if (!confirm(`Are you sure you want to delete admin user "${username}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/delete-user.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('User deleted successfully!');
                    closeEditAdminUserModal();
                    loadAdminUsers();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete user'));
                }
            } catch (error) {
                console.error('Failed to delete admin user:', error);
                alert('Failed to delete admin user');
            }
        }

        // Impersonation functions
        let impersonateData = {};
        let currentImpersonateAs = '';
        let currentSender = '';

        // Format message text with GIF rendering and links
        function formatImpersonateMessageText(text) {
            // Escape HTML first
            const escaped = escapeHtml(text);
            
            // Detect Tenor/Giphy GIF URLs and render as images
            const gifRegex = /(https?:\/\/(?:media\.tenor\.com|media[0-9]*\.giphy\.com|i\.giphy\.com)\/[^\s]+\.gif)/gi;
            let formatted = escaped.replace(gifRegex, (url) => {
                return `<br><img src="${url}" alt="GIF" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 8px;">`;
            });
            
            // Convert regular URLs to clickable links (excluding GIF URLs which are already handled)
            const urlRegex = /(https?:\/\/(?!(?:media\.tenor\.com|media[0-9]*\.giphy\.com|i\.giphy\.com)\/[^\s]+\.gif)[^\s<]+)/gi;
            formatted = formatted.replace(urlRegex, (url) => {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: underline;">${url}</a>`;
            });
            
            return formatted;
        }

        // Emoji picker for impersonate
        const commonEmojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üëç','üëé','üëå','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','‚úã','ü§ö','üñê','üññ','üëã','ü§ù','üôè','üí™','ü¶æ','üéâ','üéä','üéà','üéÅ','üèÜ','ü•á','ü•à','ü•â','‚≠ê','üåü','üíØ','üí•','üí´','üí¨','üí≠','üí§','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üî•','‚ú®','‚ö°','üåà','‚òÄÔ∏è','üåô','‚≠ê','üåç','üåé','üåè','üéµ','üé∂','üé§','üéß','üé∏','üéπ','üé∫','üé∑','üì±','üíª','‚å®Ô∏è','üñ•Ô∏è','üñ®Ô∏è','üñ±Ô∏è','üì∑','üì∏','üìπ','üé•','‚òéÔ∏è','üìû','üìü','üì†','üì∫','üìª','üîä','üîâ','üîá','üîî','üîï','‚è∞','üïê'];

        let impersonateCurrentEmojiCategory = 'smileys';

        function toggleImpersonateEmojiPicker() {
            console.log('toggleImpersonateEmojiPicker called');
            const picker = document.getElementById('impersonate-emoji-picker');
            const button = document.getElementById('impersonate-emoji-button');
            
            if (!picker) {
                console.error('Emoji picker element not found');
                return;
            }
            if (!button) {
                console.error('Emoji button element not found');
                return;
            }
            
            const isVisible = picker.style.display === 'block';
            console.log('Emoji picker visible:', isVisible);
            
            if (isVisible) {
                picker.style.display = 'none';
                button.classList.remove('active');
            } else {
                // Close GIF picker if open
                const gifPicker = document.getElementById('impersonate-gif-picker');
                if (gifPicker && gifPicker.style.display === 'block') {
                    gifPicker.style.display = 'none';
                }
                
                // Position the emoji picker dynamically above the button
                const rect = button.getBoundingClientRect();
                console.log('Button rect:', rect);
                picker.style.display = 'block';
                // Position above the button (picker height + gap)
                picker.style.top = (rect.top - picker.offsetHeight - 10) + 'px';
                picker.style.left = (rect.left) + 'px';
                // Ensure it doesn't go off-screen to the right
                if (rect.left + 380 > window.innerWidth) {
                    picker.style.left = (window.innerWidth - 390) + 'px';
                }
                picker.style.zIndex = '10000';
                button.classList.add('active');
                console.log('Calling renderImpersonateEmojis');
                renderImpersonateEmojis(impersonateCurrentEmojiCategory);
            }
        }

        function renderImpersonateEmojis(category) {
            const emojiGrid = document.getElementById('impersonate-emoji-grid');
            if (!emojiGrid) {
                console.error('Emoji grid not found');
                return;
            }
            
            emojiGrid.innerHTML = '';
            
            // Try to use EMOJIS data if available, otherwise use common emojis
            const emojisToShow = (typeof EMOJIS !== 'undefined' && EMOJIS[category]) 
                ? EMOJIS[category] 
                : commonEmojis;
            
            console.log('Rendering emojis for category:', category, 'count:', emojisToShow.length);
            
            emojisToShow.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-item';
                btn.textContent = emoji;
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    insertEmojiIntoImpersonate(emoji);
                });
                emojiGrid.appendChild(btn);
            });
            
            // Parse emojis with Twemoji for older Windows support
            if (typeof twemoji !== 'undefined') {
                twemoji.parse(emojiGrid, {
                    folder: 'svg',
                    ext: '.svg'
                });
            }
        }

        function insertEmojiIntoImpersonate(emoji) {
            const textarea = document.getElementById('impersonate-message');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
        }

        // GIF picker for impersonate
        let impersonateTenorApiKey = '';
        const impersonateTenorClientKey = 'radiochatbox';

        function toggleImpersonateGifPicker() {
            console.log('toggleImpersonateGifPicker called');
            const picker = document.getElementById('impersonate-gif-picker');
            const button = document.getElementById('impersonate-gif-button');
            
            if (!picker) {
                console.error('GIF picker element not found');
                return;
            }
            if (!button) {
                console.error('GIF button element not found');
                return;
            }
            
            const isVisible = picker.style.display === 'block';
            console.log('GIF picker visible:', isVisible);
            
            if (isVisible) {
                picker.style.display = 'none';
                button.classList.remove('active');
            } else {
                // Hide emoji picker if open
                const emojiPicker = document.getElementById('impersonate-emoji-picker');
                if (emojiPicker && emojiPicker.style.display === 'block') {
                    emojiPicker.style.display = 'none';
                    document.getElementById('impersonate-emoji-button').classList.remove('active');
                }
                
                // Position the GIF picker dynamically above the button
                const rect = button.getBoundingClientRect();
                console.log('Button rect:', rect);
                picker.style.display = 'block';
                // Position above the button (picker height + gap)
                picker.style.top = (rect.top - picker.offsetHeight - 10) + 'px';
                picker.style.left = (rect.left) + 'px';
                // Ensure it doesn't go off-screen to the right
                if (rect.left + 380 > window.innerWidth) {
                    picker.style.left = (window.innerWidth - 390) + 'px';
                }
                picker.style.zIndex = '10000';
                button.classList.add('active');
                
                // Load trending GIFs on open
                console.log('Calling searchImpersonateGifs');
                searchImpersonateGifs('');
            }
        }

        async function searchImpersonateGifs(query) {
            const gifGrid = document.getElementById('impersonate-gif-grid');
            const gifLoading = document.getElementById('impersonate-gif-loading');
            
            if (!gifGrid) return;
            
            gifGrid.innerHTML = '';
            gifLoading.style.display = 'block';
            
            // Check if API key is configured
            if (!impersonateTenorApiKey) {
                gifLoading.style.display = 'none';
                gifGrid.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444; font-size: 13px; grid-column: 1/-1;">‚ö†Ô∏è Tenor API key not configured.<br><br>Admin: Go to Settings and add your free API key from <a href="https://developers.google.com/tenor/guides/quickstart" target="_blank" style="color: #667eea;">Google Tenor</a></div>';
                return;
            }
            
            try {
                // Use Tenor API v2
                const endpoint = query 
                    ? `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(query)}&key=${impersonateTenorApiKey}&client_key=${impersonateTenorClientKey}&limit=12`
                    : `https://tenor.googleapis.com/v2/featured?key=${impersonateTenorApiKey}&client_key=${impersonateTenorClientKey}&limit=12`;
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                gifLoading.style.display = 'none';
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(gif => {
                        const gifItem = document.createElement('div');
                        gifItem.style.cssText = 'cursor: pointer; border-radius: 6px; overflow: hidden; border: 2px solid #e5e7eb; transition: transform 0.2s;';
                        gifItem.onmouseover = () => gifItem.style.transform = 'scale(1.05)';
                        gifItem.onmouseout = () => gifItem.style.transform = 'scale(1)';
                        
                        const img = document.createElement('img');
                        // Use tinygif for preview, mediumgif for sending
                        img.src = gif.media_formats.tinygif?.url || gif.media_formats.gif?.url;
                        img.alt = gif.content_description || 'GIF';
                        img.loading = 'lazy';
                        img.style.cssText = 'width: 100%; height: 100px; object-fit: cover;';
                        
                        gifItem.appendChild(img);
                        
                        gifItem.addEventListener('click', () => {
                            const gifUrl = gif.media_formats.mediumgif?.url || gif.media_formats.gif?.url;
                            insertGifIntoImpersonate(gifUrl);
                            document.getElementById('impersonate-gif-picker').style.display = 'none';
                            document.getElementById('impersonate-gif-button').classList.remove('active');
                        });
                        
                        gifGrid.appendChild(gifItem);
                    });
                } else {
                    gifGrid.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280; grid-column: 1/-1;">No GIFs found</div>';
                }
            } catch (error) {
                console.error('Error fetching GIFs:', error);
                gifLoading.style.display = 'none';
                const errorMsg = error.message && error.message.includes('API key') 
                    ? 'Invalid API key. Admin: Update your Tenor API key in Settings.'
                    : 'Failed to load GIFs. Please try again.';
                gifGrid.innerHTML = `<div style="padding: 20px; text-align: center; color: #ef4444; font-size: 13px; grid-column: 1/-1;">${errorMsg}</div>`;
            }
        }

        function insertGifIntoImpersonate(gifUrl) {
            const textarea = document.getElementById('impersonate-message');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + gifUrl + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + gifUrl.length;
            textarea.focus();
        }

        // Setup emoji category event listeners
        function setupImpersonateEmojiCategoryListeners() {
            document.querySelectorAll('.impersonate-emoji-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.impersonate-emoji-category').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    impersonateCurrentEmojiCategory = btn.dataset.category;
                    renderImpersonateEmojis(impersonateCurrentEmojiCategory);
                });
            });

            // Close picker when clicking outside
            document.addEventListener('click', (e) => {
                const emojiPicker = document.getElementById('impersonate-emoji-picker');
                const gifPicker = document.getElementById('impersonate-gif-picker');
                const emojiButton = document.getElementById('impersonate-emoji-button');
                const gifButton = document.getElementById('impersonate-gif-button');
                const messageContainer = document.getElementById('impersonate-selected-conversation');
                
                if (emojiPicker && emojiPicker.style.display === 'block' && !emojiPicker.contains(e.target) && e.target !== emojiButton && !e.target.closest('.impersonate-emoji-category')) {
                    emojiPicker.style.display = 'none';
                    emojiButton.classList.remove('active');
                }
                if (gifPicker && gifPicker.style.display === 'block' && !gifPicker.contains(e.target) && e.target !== gifButton) {
                    gifPicker.style.display = 'none';
                    gifButton.classList.remove('active');
                }
            });
        }

        // Setup GIF search
        function setupImpersonateGifSearch() {
            const gifSearchInput = document.getElementById('impersonate-gif-search-input');
            if (!gifSearchInput) return;

            let searchTimeout;
            gifSearchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = gifSearchInput.value.trim();
                    searchImpersonateGifs(query);
                }, 500); // Wait 500ms after user stops typing
            });

            // Also search on Enter key
            gifSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    const query = gifSearchInput.value.trim();
                    searchImpersonateGifs(query);
                }
            });
        }

        let impersonatePhotoAttachmentId = null;

        async function handleImpersonatePhotoUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!currentImpersonateAs || !currentSender) {
                alert('Please select a conversation first');
                input.value = '';
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                input.value = '';
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                input.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('impersonate-photo-preview-img').src = e.target.result;
                document.getElementById('impersonate-photo-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Upload to server
            const formData = new FormData();
            formData.append('photo', file);
            formData.append('username', currentImpersonateAs);
            formData.append('recipient', currentSender);
            formData.append('sessionId', 'fake_' + md5(currentImpersonateAs));

            try {
                const response = await fetch('/api/upload-photo.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                console.log('Upload response:', data); // Debug log

                if (data.success) {
                    impersonatePhotoAttachmentId = data.attachment.attachment_id;
                } else {
                    alert('Photo upload failed: ' + (data.error || 'Unknown error'));
                    clearImpersonatePhoto();
                }
            } catch (error) {
                console.error('Photo upload error:', error);
                alert('Failed to upload photo: ' + error.message);
                clearImpersonatePhoto();
            }
        }

        function clearImpersonatePhoto() {
            document.getElementById('impersonate-photo-input').value = '';
            document.getElementById('impersonate-photo-preview').style.display = 'none';
            impersonatePhotoAttachmentId = null;
        }

        async function refreshImpersonateConversations() {
            try {
                const response = await fetch('/api/admin/impersonate-conversations.php', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    impersonateData = data;
                    
                    // Populate fake users dropdown (already sorted by last message time from API)
                    const select = document.getElementById('impersonate-select');
                    select.innerHTML = '<option value="">-- Select a fake user --</option>';
                    
                    data.fake_users.forEach(fakeUser => {
                        const option = document.createElement('option');
                        option.value = fakeUser;
                        const conversation = data.conversations[fakeUser];
                        
                        let optionText = fakeUser;
                        
                        // Show profile info
                        let profileInfo = [];
                        if (conversation.age) profileInfo.push(conversation.age);
                        if (conversation.sex) profileInfo.push(conversation.sex.charAt(0).toUpperCase());
                        if (conversation.location) profileInfo.push(conversation.location);
                        
                        if (profileInfo.length > 0) {
                            optionText += ' (' + profileInfo.join(', ') + ')';
                        }
                        
                        // Show last message date
                        if (conversation.last_message_time) {
                            const lastMsgTime = new Date(conversation.last_message_time);
                            const timeStr = lastMsgTime.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                            optionText += ` - ${timeStr}`;
                        }
                        
                        // Show message count if any
                        if (conversation.total_messages) {
                            optionText += ` [${conversation.total_messages} msgs]`;
                        }
                        
                        option.textContent = optionText;
                        select.appendChild(option);
                    });

                    // Show/hide no conversations message
                    const hasConversations = Object.keys(data.conversations).length > 0;
                    document.getElementById('impersonate-no-conversations').style.display = 
                        hasConversations ? 'none' : 'block';
                    document.getElementById('impersonate-conversations').style.display = 
                        hasConversations ? 'block' : 'none';

                    // Initialize emoji and GIF pickers
                    setupImpersonateEmojiCategoryListeners();
                    setupImpersonateGifSearch();
                    
                    // Update GIF button visibility based on cached settings
                    if (cachedSettings && cachedSettings.success && cachedSettings.settings.gif_enabled === 'true') {
                        impersonateTenorApiKey = cachedSettings.settings.tenor_api_key || '';
                        if (impersonateTenorApiKey && impersonateTenorApiKey.trim() !== '') {
                            document.getElementById('impersonate-gif-button').style.display = 'inline-block';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load impersonate conversations:', error);
            }
        }

        function loadImpersonateConversation() {
            const select = document.getElementById('impersonate-select');
            const fakeUser = select.value;
            
            if (!fakeUser) {
                document.getElementById('impersonate-selected-conversation').style.display = 'none';
                return;
            }

            // Update URL to show the selected fake user (without a specific sender yet)
            const url = new URL(window.location);
            url.hash = `impersonate/${encodeURIComponent(fakeUser)}`;
            history.pushState({ 
                tab: 'impersonate',
                fakeUser: fakeUser
            }, '', url);

            currentImpersonateAs = fakeUser;
            const conversation = impersonateData.conversations[fakeUser];
            
            if (!conversation) {
                document.getElementById('impersonate-selected-conversation').style.display = 'none';
                return;
            }

            // Display senders list (already sorted by online status then by date from API)
            const sendersList = document.getElementById('impersonate-senders-list');
            sendersList.innerHTML = '';
            
            conversation.senders.forEach(sender => {
                const senderDiv = document.createElement('div');
                const lastMsgTime = new Date(sender.last_message_time);
                const timeStr = lastMsgTime.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                const onlineIndicator = sender.is_online ? 
                    '<span style="display: inline-block; width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 8px;"></span>' : 
                    '<span style="display: inline-block; width: 8px; height: 8px; background: #d1d5db; border-radius: 50%; margin-right: 8px;"></span>';
                
                const onlineText = sender.is_online ? 
                    '<span style="color: #10b981; font-weight: 600; font-size: 12px;">‚óè</span>' : '';
                
                senderDiv.style.cssText = 'padding: 10px; margin: 5px 0; background: white; border-radius: 6px; cursor: pointer; border: 2px solid transparent;';
                senderDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${onlineIndicator}${sender.username}</strong>
                            <div style="color: #6b7280; font-size: 13px; margin-left: 0;">${sender.unread_count} message(s)</div>
                            <div style="color: #9ca3af; font-size: 12px; margin-top: 5px;">${sender.last_message.substring(0, 50)}...</div>
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #6b7280; white-space: nowrap; margin-left: 10px;">${timeStr}</div>
                    </div>
                `;
                senderDiv.onclick = () => selectSender(fakeUser, sender.username);
                sendersList.appendChild(senderDiv);
            });
        }

        // Simple MD5 implementation for JavaScript
        function md5(string) {
            function md5cycle(x, k) {
                var a = x[0], b = x[1], c = x[2], d = x[3];
                a = ff(a, b, c, d, k[0], 7, -680876936);
                d = ff(d, a, b, c, k[1], 12, -389564586);
                c = ff(c, d, a, b, k[2], 17, 606105819);
                b = ff(b, c, d, a, k[3], 22, -1044525330);
                a = ff(a, b, c, d, k[4], 7, -176418897);
                d = ff(d, a, b, c, k[5], 12, 1200080426);
                c = ff(c, d, a, b, k[6], 17, -1473231341);
                b = ff(b, c, d, a, k[7], 22, -45705983);
                a = ff(a, b, c, d, k[8], 7, 1770035416);
                d = ff(d, a, b, c, k[9], 12, -1958414417);
                c = ff(c, d, a, b, k[10], 17, -42063);
                b = ff(b, c, d, a, k[11], 22, -1990404162);
                a = ff(a, b, c, d, k[12], 7, 1804603682);
                d = ff(d, a, b, c, k[13], 12, -40341101);
                c = ff(c, d, a, b, k[14], 17, -1502002290);
                b = ff(b, c, d, a, k[15], 22, 1236535329);
                a = gg(a, b, c, d, k[1], 5, -165796510);
                d = gg(d, a, b, c, k[6], 9, -1069501632);
                c = gg(c, d, a, b, k[11], 14, 643717713);
                b = gg(b, c, d, a, k[0], 20, -373897302);
                a = gg(a, b, c, d, k[5], 5, -701558691);
                d = gg(d, a, b, c, k[10], 9, 38016083);
                c = gg(c, d, a, b, k[15], 14, -660478335);
                b = gg(b, c, d, a, k[4], 20, -405537848);
                a = gg(a, b, c, d, k[9], 5, 568446438);
                d = gg(d, a, b, c, k[14], 9, -1019803690);
                c = gg(c, d, a, b, k[3], 14, -187363961);
                b = gg(b, c, d, a, k[8], 20, 1163531501);
                a = gg(a, b, c, d, k[13], 5, -1444681467);
                d = gg(d, a, b, c, k[2], 9, -51403784);
                c = gg(c, d, a, b, k[7], 14, 1735328473);
                b = gg(b, c, d, a, k[12], 20, -1926607734);
                a = hh(a, b, c, d, k[5], 4, -378558);
                d = hh(d, a, b, c, k[8], 11, -2022574463);
                c = hh(c, d, a, b, k[11], 16, 1839030562);
                b = hh(b, c, d, a, k[14], 23, -35309556);
                a = hh(a, b, c, d, k[1], 4, -1530992060);
                d = hh(d, a, b, c, k[4], 11, 1272893353);
                c = hh(c, d, a, b, k[7], 16, -155497632);
                b = hh(b, c, d, a, k[10], 23, -1094730640);
                a = hh(a, b, c, d, k[13], 4, 681279174);
                d = hh(d, a, b, c, k[0], 11, -358537222);
                c = hh(c, d, a, b, k[3], 16, -722521979);
                b = hh(b, c, d, a, k[6], 23, 76029189);
                a = hh(a, b, c, d, k[9], 4, -640364487);
                d = hh(d, a, b, c, k[12], 11, -421815835);
                c = hh(c, d, a, b, k[15], 16, 530742520);
                b = hh(b, c, d, a, k[2], 23, -995338651);
                a = ii(a, b, c, d, k[0], 6, -198630844);
                d = ii(d, a, b, c, k[7], 10, 1126891415);
                c = ii(c, d, a, b, k[14], 15, -1416354905);
                b = ii(b, c, d, a, k[5], 21, -57434055);
                a = ii(a, b, c, d, k[12], 6, 1700485571);
                d = ii(d, a, b, c, k[3], 10, -1894986606);
                c = ii(c, d, a, b, k[10], 15, -1051523);
                b = ii(b, c, d, a, k[1], 21, -2054922799);
                a = ii(a, b, c, d, k[8], 6, 1873313359);
                d = ii(d, a, b, c, k[15], 10, -30611744);
                c = ii(c, d, a, b, k[6], 15, -1560198380);
                b = ii(b, c, d, a, k[13], 21, 1309151649);
                a = ii(a, b, c, d, k[4], 6, -145523070);
                d = ii(d, a, b, c, k[11], 10, -1120210379);
                c = ii(c, d, a, b, k[2], 15, 718787259);
                b = ii(b, c, d, a, k[9], 21, -343485551);
                x[0] = add32(a, x[0]);
                x[1] = add32(b, x[1]);
                x[2] = add32(c, x[2]);
                x[3] = add32(d, x[3]);
            }
            function cmn(q, a, b, x, s, t) {
                a = add32(add32(a, q), add32(x, t));
                return add32((a << s) | (a >>> (32 - s)), b);
            }
            function ff(a, b, c, d, x, s, t) { return cmn((b & c) | ((~b) & d), a, b, x, s, t); }
            function gg(a, b, c, d, x, s, t) { return cmn((b & d) | (c & (~d)), a, b, x, s, t); }
            function hh(a, b, c, d, x, s, t) { return cmn(b ^ c ^ d, a, b, x, s, t); }
            function ii(a, b, c, d, x, s, t) { return cmn(c ^ (b | (~d)), a, b, x, s, t); }
            function md51(s) {
                var n = s.length, state = [1732584193, -271733879, -1732584194, 271733878], i;
                for (i = 64; i <= s.length; i += 64) {
                    md5cycle(state, md5blk(s.substring(i - 64, i)));
                }
                s = s.substring(i - 64);
                var tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                for (i = 0; i < s.length; i++)
                    tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);
                tail[i >> 2] |= 0x80 << ((i % 4) << 3);
                if (i > 55) {
                    md5cycle(state, tail);
                    for (i = 0; i < 16; i++) tail[i] = 0;
                }
                tail[14] = n * 8;
                md5cycle(state, tail);
                return state;
            }
            function md5blk(s) {
                var md5blks = [], i;
                for (i = 0; i < 64; i += 4) {
                    md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);
                }
                return md5blks;
            }
            var hex_chr = '0123456789abcdef'.split('');
            function rhex(n) {
                var s = '', j = 0;
                for (; j < 4; j++)
                    s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];
                return s;
            }
            function hex(x) {
                for (var i = 0; i < x.length; i++)
                    x[i] = rhex(x[i]);
                return x.join('');
            }
            function add32(a, b) {
                return (a + b) & 0xFFFFFFFF;
            }
            return hex(md51(string));
        }

        async function selectSender(fakeUser, senderUsername) {
            currentSender = senderUsername;
            document.getElementById('impersonate-current-sender').textContent = senderUsername;
            document.getElementById('impersonate-as-name').textContent = fakeUser;
            document.getElementById('impersonate-as-name-2').textContent = fakeUser;
            
            // Connect to real-time chat stream for this conversation
            connectImpersonateChatStream(fakeUser, senderUsername);
            
            // Update URL to reflect the current conversation
            updateImpersonateURL(fakeUser, senderUsername);
            
            // Display fake user profile info
            const conversation = impersonateData.conversations[fakeUser];
            if (conversation) {
                let infoText = '';
                if (conversation.age) {
                    infoText += conversation.age + ' years old';
                }
                if (conversation.sex) {
                    if (infoText) infoText += ' ‚Ä¢ ';
                    infoText += conversation.sex.charAt(0).toUpperCase() + conversation.sex.slice(1);
                }
                if (conversation.location) {
                    if (infoText) infoText += ' ‚Ä¢ ';
                    infoText += conversation.location;
                }
                document.getElementById('impersonate-as-info').textContent = infoText;
            }
            
            document.getElementById('impersonate-selected-conversation').style.display = 'block';

            // Generate fake session ID using MD5 to match the format in private-message.php
            const fakeSessionId = 'fake_' + md5(fakeUser);

            // Load full conversation - get ALL messages with admin=true parameter
            try {
                const response = await fetch(`/api/private-message.php?username=${encodeURIComponent(fakeUser)}&with_user=${encodeURIComponent(senderUsername)}&session_id=${encodeURIComponent(fakeSessionId)}&admin=true`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                console.log('Conversation data:', data); // Debug log
                console.log('Session ID used:', fakeSessionId); // Debug log

                if (data.success && data.messages) {
                    const messagesDiv = document.getElementById('impersonate-messages');
                    messagesDiv.innerHTML = '';
                    
                    console.log('Messages count:', data.messages.length); // Debug log
                    
                    if (data.messages.length === 0) {
                        messagesDiv.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 40px;">No messages yet</div>';
                        return;
                    }
                    
                    // Messages are already in ASC order (oldest first) from the query
                    data.messages.forEach(msg => {
                        // Messages FROM the fake user should be on the right (we're replying as them)
                        const isFromFake = msg.from_username === fakeUser;
                        
                        // Create wrapper for proper alignment
                        const wrapperDiv = document.createElement('div');
                        wrapperDiv.style.cssText = `display: flex; ${isFromFake ? 'justify-content: flex-end;' : 'justify-content: flex-start;'} margin: 8px 0;`;
                        
                        const msgDiv = document.createElement('div');
                        msgDiv.style.cssText = `display: inline-block; padding: 12px 15px; border-radius: 12px; max-width: 70%; ${isFromFake ? 'background: #667eea; color: white; text-align: right;' : 'background: #f3f4f6; border: 1px solid #e5e7eb; text-align: left;'}`;
                        
                        const timestamp = new Date(msg.created_at);
                        const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        let content = `
                            <div style="font-size: 11px; ${isFromFake ? 'color: rgba(255,255,255,0.8);' : 'color: #6b7280;'} margin-bottom: 6px; font-weight: 600;">
                                ${escapeHtml(msg.from_username)} ‚Ä¢ ${timeStr}
                            </div>`;
                        
                        // Show attachment if present
                        if (msg.attachment && msg.attachment.file_path) {
                            content += `
                                <div style="margin-bottom: 8px;">
                                    <img src="${escapeHtml(msg.attachment.file_path)}" 
                                         style="max-width: 250px; border-radius: 8px; cursor: pointer;" 
                                         onclick="window.open('${escapeHtml(msg.attachment.file_path)}', '_blank')">
                                </div>`;
                        }
                        
                        // Show message text if present
                        if (msg.message) {
                            // Format message to render GIFs and links
                            const formatted = formatImpersonateMessageText(msg.message);
                            content += `<div style="word-wrap: break-word; line-height: 1.4;">${formatted}</div>`;
                        }
                        
                        msgDiv.innerHTML = content;
                        wrapperDiv.appendChild(msgDiv);
                        messagesDiv.appendChild(wrapperDiv);
                    });
                    
                    console.log('Fake user:', fakeUser); // Debug to verify
                    
                    // Scroll to bottom
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    
                    // Focus on message input
                    document.getElementById('impersonate-message').focus();
                } else {
                    console.error('Invalid data received:', data);
                    messagesDiv.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">Error loading messages</div>';
                }
            } catch (error) {
                console.error('Failed to load conversation:', error);
                document.getElementById('impersonate-messages').innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">Error loading conversation</div>';
            }
        }

        async function sendImpersonateMessage() {
            const messageInput = document.getElementById('impersonate-message');
            let message = messageInput.value.trim();
            
            // Allow empty message if there's a photo
            if (!message && !impersonatePhotoAttachmentId) {
                return; // Silent return if empty
            }

            if (!currentImpersonateAs || !currentSender) {
                alert('Please select a conversation first');
                return;
            }

            // Convert emoticons to emojis
            message = convertEmoticonsToEmojis(message);

            try {
                const requestBody = {
                    impersonate_as: currentImpersonateAs,
                    to_username: currentSender,
                    message: message
                };

                // Add attachment if present
                if (impersonatePhotoAttachmentId) {
                    requestBody.attachment_id = impersonatePhotoAttachmentId;
                }

                const response = await fetch('/api/admin/impersonate-send.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (data.success) {
                    messageInput.value = '';
                    clearImpersonatePhoto(); // Clear photo after sending
                    // Reload conversation
                    await selectSender(currentImpersonateAs, currentSender);
                } else {
                    alert('Error: ' + (data.error || 'Failed to send message'));
                }
            } catch (error) {
                console.error('Failed to send impersonate message:', error);
                alert('Failed to send message');
            }
        }

        function convertEmoticonsToEmojis(text) {
            // First, protect URLs by replacing them with placeholders
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = [];
            let protectedText = text.replace(urlRegex, (url) => {
                const placeholder = `__URL_${urls.length}__`;
                urls.push(url);
                return placeholder;
            });
            
            // Map of common emoticons to their emoji equivalents
            const emoticonMap = [
                // Happy/Smiling faces
                { pattern: /:-\)/g, emoji: 'üôÇ' },
                { pattern: /:\)/g, emoji: 'üôÇ' },
                { pattern: /=\)/g, emoji: 'üôÇ' },
                { pattern: /:-D/g, emoji: 'üòÉ' },
                { pattern: /:D/g, emoji: 'üòÉ' },
                { pattern: /=D/g, emoji: 'üòÉ' },
                { pattern: /xD/gi, emoji: 'üòÜ' },
                { pattern: /XD/g, emoji: 'üòÜ' },
                
                // Winking
                { pattern: /;-\)/g, emoji: 'üòâ' },
                { pattern: /;\)/g, emoji: 'üòâ' },
                
                // Sad faces
                { pattern: /:-\(/g, emoji: 'üôÅ' },
                { pattern: /:\(/g, emoji: 'üôÅ' },
                { pattern: /=\(/g, emoji: 'üôÅ' },
                { pattern: /:-\[/g, emoji: 'üòû' },
                { pattern: /:\[/g, emoji: 'üòû' },
                
                // Tongue out
                { pattern: /:-[pP]/g, emoji: 'üòõ' },
                { pattern: /:[pP]/g, emoji: 'üòõ' },
                { pattern: /:-[bB]/g, emoji: 'üòõ' },
                
                // Love/Hearts
                { pattern: /<3/g, emoji: '‚ù§Ô∏è' },
                { pattern: /<\/3/g, emoji: 'üíî' },
                
                // Cool/Sunglasses
                { pattern: /8-\)/g, emoji: 'üòé' },
                { pattern: /B-\)/gi, emoji: 'üòé' },
                
                // Surprised/Shocked
                { pattern: /:-[oO]/g, emoji: 'üòÆ' },
                { pattern: /:[oO]/g, emoji: 'üòÆ' },
                
                // Crying
                { pattern: /:'-\(/g, emoji: 'üò¢' },
                { pattern: /:'\(/g, emoji: 'üò¢' },
                { pattern: /;-;/g, emoji: 'üò¢' },
                { pattern: /T_T/g, emoji: 'üò≠' },
                { pattern: /T-T/g, emoji: 'üò≠' },
                
                // Laughing
                { pattern: /:-\|/g, emoji: 'üòê' },
                { pattern: /:\|/g, emoji: 'üòê' },
                
                // Kiss
                { pattern: /:-\*/g, emoji: 'üòò' },
                { pattern: /:\*/g, emoji: 'üòò' },
                
                // Angel
                { pattern: /O:-\)/g, emoji: 'üòá' },
                { pattern: /O:\)/g, emoji: 'üòá' },
                
                // Devil
                { pattern: />:-\)/g, emoji: 'üòà' },
                { pattern: />:\)/g, emoji: 'üòà' },
                
                // Confused
                { pattern: /:-\//g, emoji: 'üòï' },
                { pattern: /:\//g, emoji: 'üòï' },
                { pattern: /:-\\/g, emoji: 'üòï' },
                { pattern: /:\\/g, emoji: 'üòï' },
                
                // Thinking
                { pattern: /:-\?/g, emoji: 'ü§î' },
                { pattern: /:\?/g, emoji: 'ü§î' },
                
                // Thumbs up/down
                { pattern: /\(y\)/gi, emoji: 'üëç' },
                { pattern: /\(n\)/gi, emoji: 'üëé' }
            ];
            
            // Apply each emoticon replacement on the protected text
            emoticonMap.forEach(({ pattern, emoji }) => {
                protectedText = protectedText.replace(pattern, emoji);
            });
            
            // Restore URLs from placeholders
            urls.forEach((url, index) => {
                protectedText = protectedText.replace(`__URL_${index}__`, url);
            });
            
            return protectedText;
        }
        
        // Add Enter key support for impersonate message
        document.addEventListener('DOMContentLoaded', function() {
            const impersonateInput = document.getElementById('impersonate-message');
            if (impersonateInput) {
                impersonateInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendImpersonateMessage();
                    }
                });
            }
        });
        
        // =========================================
        // STATISTICS FUNCTIONS
        // =========================================
        
        let currentStatsTab = 'summary';
        
        async function loadStatsTab(tab) {
            currentStatsTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('[id^="stats-tab-"]').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#6b7280';
                btn.style.borderBottom = 'none';
            });
            document.getElementById(`stats-tab-${tab}`).style.background = '#667eea';
            document.getElementById(`stats-tab-${tab}`).style.color = 'white';
            document.getElementById(`stats-tab-${tab}`).style.borderBottom = '3px solid #667eea';
            
            // Update controls
            const controlsDiv = document.getElementById('stats-controls');
            
            if (tab === 'summary') {
                controlsDiv.innerHTML = '<button class="btn btn-primary" onclick="loadStatsContent()">Refresh</button>';
            } else if (tab === 'hourly') {
                controlsDiv.innerHTML = `
                    <label style="color: #333; font-weight: 600;">Show last:</label>
                    <select id="hourly-limit" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <option value="24">24 hours</option>
                        <option value="48">48 hours</option>
                        <option value="168" selected>7 days</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadStatsContent()">Load</button>
                `;
            } else if (tab === 'daily') {
                controlsDiv.innerHTML = `
                    <label style="color: #333; font-weight: 600;">Show last:</label>
                    <select id="daily-limit" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <option value="30">30 days</option>
                        <option value="90" selected>90 days</option>
                        <option value="180">180 days</option>
                        <option value="365">1 year</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadStatsContent()">Load</button>
                `;
            } else if (tab === 'weekly') {
                const currentYear = new Date().getFullYear();
                let yearOptions = '';
                for (let i = currentYear; i >= currentYear - 5; i--) {
                    yearOptions += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`;
                }
                controlsDiv.innerHTML = `
                    <label style="color: #333; font-weight: 600;">Year:</label>
                    <select id="weekly-year" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                        ${yearOptions}
                    </select>
                    <button class="btn btn-primary" onclick="loadStatsContent()">Load</button>
                `;
            } else if (tab === 'monthly') {
                const currentYear = new Date().getFullYear();
                let yearOptions = '';
                for (let i = currentYear; i >= currentYear - 5; i--) {
                    yearOptions += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`;
                }
                controlsDiv.innerHTML = `
                    <label style="color: #333; font-weight: 600;">Year:</label>
                    <select id="monthly-year" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                        ${yearOptions}
                    </select>
                    <button class="btn btn-primary" onclick="loadStatsContent()">Load</button>
                `;
            } else if (tab === 'yearly') {
                controlsDiv.innerHTML = '<button class="btn btn-primary" onclick="loadStatsContent()">Refresh</button>';
            }
            
            loadStatsContent();
        }
        
        async function loadStatsContent() {
            const content = document.getElementById('stats-content');
            const errorDiv = document.getElementById('stats-error');
            errorDiv.innerHTML = '';
            
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">Loading statistics...</div>';
            
            try {
                if (currentStatsTab === 'summary') {
                    await loadStatsSummary();
                } else if (currentStatsTab === 'hourly') {
                    const limit = document.getElementById('hourly-limit')?.value || 168;
                    await loadStatsHourly(limit);
                } else if (currentStatsTab === 'daily') {
                    const limit = document.getElementById('daily-limit')?.value || 90;
                    await loadStatsDaily(limit);
                } else if (currentStatsTab === 'weekly') {
                    const year = document.getElementById('weekly-year')?.value || new Date().getFullYear();
                    await loadStatsWeekly(year);
                } else if (currentStatsTab === 'monthly') {
                    const year = document.getElementById('monthly-year')?.value || new Date().getFullYear();
                    await loadStatsMonthly(year);
                } else if (currentStatsTab === 'yearly') {
                    await loadStatsYearly();
                }
            } catch (error) {
                content.innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #ef4444; padding: 20px; border-radius: 6px; color: #991b1b; text-align: center;">
                        <strong>Failed to load statistics</strong><br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        async function loadStatsSummary() {
            const content = document.getElementById('stats-content');
            const result = await fetchStatsData('summary');
            const summary = result.data;
            const radioEnabled = result.radio_enabled || false;
            const chatMode = result.chat_mode || 'both';
            const photosEnabled = result.photos_enabled !== false;
            
            // Extract summary data
            const today = summary.today || {};
            const week = summary.this_week || {};
            const month = summary.this_month || {};
            const year = summary.this_year || {};
            const snapshot = summary.latest_snapshot || {};
            
            // Debug logging
            console.log('loadStatsSummary - today.active_users:', today.active_users, 'snapshot.concurrent_users:', snapshot.concurrent_users);
            
            // Debug logging
            console.log('loadStatsSummary:', {
                today: today,
                today_active_users: today.active_users,
                snapshot_concurrent_users: snapshot.concurrent_users,
                radioEnabled: radioEnabled,
                chatMode: chatMode,
                photosEnabled: photosEnabled
            });
            
            // Conditional KPI cards based on settings
            const privateCard = chatMode !== 'public' ? `
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #1f2937; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üîí Private (Today)</div>
                        <div style="font-size: 32px; font-weight: bold;">${today.private_messages || 0}</div>
                    </div>
            ` : '';
            
            const photosCard = photosEnabled ? `
                    <!-- Photos -->
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üì∏ Photos (Today)</div>
                        <div style="font-size: 32px; font-weight: bold;">${today.photo_uploads || 0}</div>
                    </div>
            ` : '';
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <!-- Real-time Users -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; cursor: help;" title="Number of users currently active in chat (real-time snapshot)">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üë• Active Users (Now)</div>
                        <div style="font-size: 32px; font-weight: bold;">${snapshot.concurrent_users || 0}</div>
                    </div>
                    
                    <!-- Today's Users Breakdown -->
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; cursor: help;" title="Users with registered accounts that have been active today">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üë§ Registered (Today)</div>
                        <div style="font-size: 32px; font-weight: bold;">${today.registered_users || 0}</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); color: white; padding: 20px; border-radius: 8px; cursor: help;" title="Anonymous users who chatted without registering an account today">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üö∂ Guests (Today)</div>
                        <div style="font-size: 32px; font-weight: bold;">${today.guest_users || 0}</div>
                    </div>
                    
                    <!-- Messages -->
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px; cursor: help;" title="Total public messages posted in chat today">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üí¨ Messages (Today)</div>
                        <div style="font-size: 32px; font-weight: bold;">${today.total_messages || 0}</div>
                    </div>
                    
                    ${privateCard}
                    ${photosCard}
                    
                    <!-- Registrations -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 8px; cursor: help;" title="New user accounts created today">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">‚ú® New Registrations (Today)</div>
                        <div style="font-size: 32px; font-weight: bold;">${today.new_registrations || 0}</div>
                    </div>
                    
                    ${radioEnabled ? `
                    <!-- Radio Listeners -->
                    <div style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 20px; border-radius: 8px; cursor: help;" title="Number of people currently listening to the radio stream">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üìª Radio Listeners (Now)</div>
                        <div style="font-size: 32px; font-weight: bold;">${snapshot.radio_listeners || 0}</div>
                    </div>
                    
                    <!-- Peak Radio Listeners -->
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #1f2937; padding: 20px; border-radius: 8px; cursor: help;" title="Highest number of radio listeners at any point today">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üìª Peak Listeners (Today)</div>
                        <div style="font-size: 32px; font-weight: bold;">${today.radio_listeners_peak || 0}</div>
                    </div>
                    ` : ''}
                    
                    <!-- Peak Concurrent (Chat Users) -->
                    <div style="background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%); color: white; padding: 20px; border-radius: 8px; cursor: help;" title="Highest number of chat users online at any point today">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">‚ö° Peak Chat Users (Today)</div>
                        <div style="font-size: 32px; font-weight: bold;">${today.peak_concurrent_users || 0}</div>
                    </div>
                    
                    <!-- Month Summary -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #667eea 100%); color: white; padding: 20px; border-radius: 8px; border-left: 4px solid white; cursor: help;" title="Total public messages posted this month">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üìä Month Total</div>
                        <div style="font-size: 32px; font-weight: bold;">${month.total_messages || 0}</div>
                    </div>
                    
                    <!-- Week Summary -->
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px; border-left: 4px solid white; cursor: help;" title="Total public messages posted this week">
                        <div style="font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">üìÖ Week Total</div>
                        <div style="font-size: 32px; font-weight: bold;">${week.total_messages || 0}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <!-- Today's Summary Card -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                            üìÖ Today's Summary
                        </h3>
                        <div style="space-y: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; cursor: help;" title="Users with registered accounts that have been active today">
                                <span style="color: #6b7280;">Active Users:</span>
                                <strong>${today.active_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; cursor: help;" title="Users with registered accounts that have been active today">
                                <span style="color: #6b7280;">Registered:</span>
                                <strong>${today.registered_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; cursor: help;" title="Anonymous users who chatted without registering an account today">
                                <span style="color: #6b7280;">Guests:</span>
                                <strong>${today.guest_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; cursor: help;" title="Total public messages posted in chat today">
                                <span style="color: #6b7280;">Public Messages:</span>
                                <strong>${today.total_messages || 0}</strong>
                            </div>
                            ${chatMode !== 'public' ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; cursor: help;" title="Private one-on-one messages sent today">
                                <span style="color: #6b7280;">Private Messages:</span>
                                <strong>${today.private_messages || 0}</strong>
                            </div>
                            ` : ''}
                            ${photosEnabled ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; cursor: help;" title="Images/photos uploaded to chat today">
                                <span style="color: #6b7280;">Photo Uploads:</span>
                                <strong>${today.photo_uploads || 0}</strong>
                            </div>
                            ` : ''}
                            ${radioEnabled ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; cursor: help;" title="Average number of radio stream listeners throughout the day">
                                <span style="color: #6b7280;">Avg Radio Listeners:</span>
                                <strong>${today.radio_listeners_avg || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; cursor: help;" title="Highest number of radio stream listeners at any point today">
                                <span style="color: #6b7280;">Peak Radio Listeners:</span>
                                <strong>${today.radio_listeners_peak || 0}</strong>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; cursor: help;" title="New user accounts created today">
                                <span style="color: #6b7280;">New Registrations:</span>
                                <strong>${today.new_registrations || 0}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Week Summary Card -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                            üìÖ This Week's Summary
                        </h3>
                        <div style="space-y: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Active Users:</span>
                                <strong>${week.active_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Registered:</span>
                                <strong>${week.registered_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Guests:</span>
                                <strong>${week.guest_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Public Messages:</span>
                                <strong>${week.total_messages || 0}</strong>
                            </div>
                            ${chatMode !== 'public' ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Private Messages:</span>
                                <strong>${week.private_messages || 0}</strong>
                            </div>
                            ` : ''}
                            ${photosEnabled ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Photo Uploads:</span>
                                <strong>${week.photo_uploads || 0}</strong>
                            </div>
                            ` : ''}
                            ${radioEnabled ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Avg Radio Listeners:</span>
                                <strong>${week.radio_listeners_avg || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Peak Radio Listeners:</span>
                                <strong>${week.radio_listeners_peak || 0}</strong>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span style="color: #6b7280;">New Registrations:</span>
                                <strong>${week.new_registrations || 0}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Month Summary Card -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                            üìÜ This Month's Summary
                        </h3>
                        <div style="space-y: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Active Users:</span>
                                <strong>${month.active_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Registered:</span>
                                <strong>${month.registered_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Guests:</span>
                                <strong>${month.guest_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Public Messages:</span>
                                <strong>${month.total_messages || 0}</strong>
                            </div>
                            ${chatMode !== 'public' ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Private Messages:</span>
                                <strong>${month.private_messages || 0}</strong>
                            </div>
                            ` : ''}
                            ${photosEnabled ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Photo Uploads:</span>
                                <strong>${month.photo_uploads || 0}</strong>
                            </div>
                            ` : ''}
                            ${radioEnabled ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Avg Radio Listeners:</span>
                                <strong>${month.radio_listeners_avg || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Peak Radio Listeners:</span>
                                <strong>${month.radio_listeners_peak || 0}</strong>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span style="color: #6b7280;">New Registrations:</span>
                                <strong>${month.new_registrations || 0}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Year Summary Card -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                            üìà This Year's Summary
                        </h3>
                        <div style="space-y: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Active Users:</span>
                                <strong>${year.active_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Registered:</span>
                                <strong>${year.registered_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Guests:</span>
                                <strong>${year.guest_users || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Public Messages:</span>
                                <strong>${year.total_messages || 0}</strong>
                            </div>
                            ${chatMode !== 'public' ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Private Messages:</span>
                                <strong>${year.private_messages || 0}</strong>
                            </div>
                            ` : ''}
                            ${photosEnabled ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Photo Uploads:</span>
                                <strong>${year.photo_uploads || 0}</strong>
                            </div>
                            ` : ''}
                            ${radioEnabled ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Avg Radio Listeners:</span>
                                <strong>${year.radio_listeners_avg || 0}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #6b7280;">Peak Radio Listeners:</span>
                                <strong>${year.radio_listeners_peak || 0}</strong>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span style="color: #6b7280;">New Registrations:</span>
                                <strong>${year.new_registrations || 0}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #1f2937;">Last 7 Days Activity</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            `;
            
            loadStatsChart('summary');
        }
        
        async function loadStatsHourly(limit) {
            const content = document.getElementById('stats-content');
            const result = await fetchStatsData('hourly', { limit });
            const data = result.data || result;
            const reversed = data.reverse();
            
            content.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #1f2937;">Hourly Statistics</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            `;
            
            loadStatsChart('hourly', reversed);
        }
        
        async function loadStatsDaily(limit) {
            const content = document.getElementById('stats-content');
            const result = await fetchStatsData('daily', { limit });
            const data = result.data || result;
            const reversed = data.reverse();
            
            content.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #1f2937;">Daily Statistics</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            `;
            
            loadStatsChart('daily', reversed);
        }
        
        async function loadStatsWeekly(year) {
            const content = document.getElementById('stats-content');
            const result = await fetchStatsData('weekly', { year });
            const data = result.data || result;
            const reversed = data.reverse();
            
            content.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #1f2937;">Weekly Statistics - ${year}</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            `;
            
            loadStatsChart('weekly', reversed);
        }
        
        async function loadStatsMonthly(year) {
            const content = document.getElementById('stats-content');
            const result = await fetchStatsData('monthly', { year });
            const data = result.data || result;
            const reversed = data.reverse();
            
            content.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #1f2937;">Monthly Statistics - ${year}</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            `;
            
            loadStatsChart('monthly', reversed);
        }
        
        async function loadStatsYearly() {
            const content = document.getElementById('stats-content');
            const result = await fetchStatsData('yearly');
            const data = result.data || result;
            const reversed = data.reverse();
            
            content.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #1f2937;">Yearly Statistics</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            `;
            
            loadStatsChart('yearly', reversed);
        }
        
        function loadStatsChart(type, data = null) {
            const ctx = document.getElementById('statsChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (window.statsChartInstance) {
                window.statsChartInstance.destroy();
            }
            
            const chartCtx = ctx.getContext('2d');
            
            if (type === 'summary') {
                // Load 7-day data for summary
                fetchStatsData('daily', { limit: 7 }).then(result => {
                    const daily = result.data || result;
                    const reversed = daily.reverse();
                    
                    const datasets = [
                        { label: 'Messages', data: reversed.map(d => d.total_messages), borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4, yAxisID: 'y' }
                    ];
                    
                    // Only show private messages if chat mode allows it
                    if (window.chatMode !== 'public') {
                        datasets.push({ label: 'Private Messages', data: reversed.map(d => d.private_messages), borderColor: '#f093fb', backgroundColor: 'rgba(240, 147, 251, 0.1)', tension: 0.4, yAxisID: 'y' });
                    }
                    
                    datasets.push(
                        { label: 'Active Users', data: reversed.map(d => d.active_users), borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.1)', tension: 0.4, yAxisID: 'y1' },
                        { label: 'Peak Concurrent', data: reversed.map(d => d.peak_concurrent_users), borderColor: '#ff6b6b', backgroundColor: 'rgba(255, 107, 107, 0.1)', borderDash: [5, 5], tension: 0.4, yAxisID: 'y1' }
                    );
                    
                    if (window.radioEnabled) {
                        datasets.push({ label: 'üìª Radio Listeners (avg)', data: reversed.map(d => d.radio_listeners_avg), borderColor: '#30cfd0', backgroundColor: 'rgba(48, 207, 208, 0.1)', tension: 0.4, yAxisID: 'y1' });
                        datasets.push({ label: 'üìª Radio Peak', data: reversed.map(d => d.radio_listeners_peak), borderColor: '#00b4d8', backgroundColor: 'rgba(0, 180, 216, 0.1)', borderDash: [5, 5], tension: 0.4, yAxisID: 'y1' });
                    }
                    
                    window.statsChartInstance = new Chart(chartCtx, {
                        type: 'line',
                        data: { labels: reversed.map(d => d.stat_date), datasets: datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'top' } },
                            scales: { y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Messages' } }, y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Users / Listeners' } } }
                        }
                    });
                });
            } else if (type === 'hourly') {
                const datasets = [
                    { label: 'Messages', data: data.map(d => d.total_messages), backgroundColor: 'rgba(102, 126, 234, 0.7)', yAxisID: 'y' }
                ];
                
                // Only show private messages if chat mode allows it
                if (window.chatMode !== 'public') {
                    datasets.push({ label: 'Private Messages', data: data.map(d => d.private_messages), backgroundColor: 'rgba(240, 147, 251, 0.7)', yAxisID: 'y' });
                }
                
                // Only show photos if enabled
                if (window.photosEnabled) {
                    datasets.push({ label: 'Photos', data: data.map(d => d.photo_uploads), backgroundColor: 'rgba(67, 233, 123, 0.7)', yAxisID: 'y1' });
                }
                
                datasets.push(
                    { label: 'Active Users', data: data.map(d => d.active_users), backgroundColor: 'rgba(79, 172, 254, 0.7)', yAxisID: 'y1' },
                    { label: 'Peak Concurrent', data: data.map(d => d.peak_concurrent_users), backgroundColor: 'rgba(255, 107, 107, 0.7)', yAxisID: 'y1' }
                );
                if (window.radioEnabled) {
                    datasets.push({ label: 'üìª Radio (avg)', data: data.map(d => d.radio_listeners_avg), backgroundColor: 'rgba(48, 207, 208, 0.7)', yAxisID: 'y1' });
                    datasets.push({ label: 'üìª Radio Peak', data: data.map(d => d.radio_listeners_peak), backgroundColor: 'rgba(0, 180, 216, 0.7)', yAxisID: 'y1' });
                }
                window.statsChartInstance = new Chart(chartCtx, {
                    type: 'bar',
                    data: { labels: data.map(d => new Date(d.stat_hour).toLocaleString()), datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Messages' } }, y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Count' } } } }
                });
            } else if (type === 'daily') {
                const datasets = [
                    { label: 'Messages', data: data.map(d => d.total_messages), borderColor: '#667eea', tension: 0.4, yAxisID: 'y' }
                ];
                
                // Only show private messages if chat mode allows it
                if (window.chatMode !== 'public') {
                    datasets.push({ label: 'Private Messages', data: data.map(d => d.private_messages), borderColor: '#f093fb', tension: 0.4, yAxisID: 'y' });
                }
                
                // Only show photos if enabled
                if (window.photosEnabled) {
                    datasets.push({ label: 'Photos', data: data.map(d => d.photo_uploads), borderColor: '#43e97b', tension: 0.4, yAxisID: 'y' });
                }
                
                datasets.push(
                    { label: 'New Registrations', data: data.map(d => d.new_registrations), borderColor: '#fa709a', tension: 0.4, yAxisID: 'y' },
                    { label: 'Active Users', data: data.map(d => d.active_users), borderColor: '#4facfe', tension: 0.4, yAxisID: 'y1' },
                    { label: 'Guest Users', data: data.map(d => d.guest_users), borderColor: '#ffa751', tension: 0.4, yAxisID: 'y1' },
                    { label: 'Peak Concurrent', data: data.map(d => d.peak_concurrent_users), borderColor: '#ff6b6b', borderDash: [5, 5], tension: 0.4, yAxisID: 'y1' }
                );
                if (window.radioEnabled) {
                    datasets.push({ label: 'üìª Listeners (avg)', data: data.map(d => d.radio_listeners_avg), borderColor: '#30cfd0', tension: 0.4, yAxisID: 'y1' });
                    datasets.push({ label: 'üìª Peak', data: data.map(d => d.radio_listeners_peak), borderColor: '#00b4d8', borderDash: [5, 5], tension: 0.4, yAxisID: 'y1' });
                }
                window.statsChartInstance = new Chart(chartCtx, {
                    type: 'line',
                    data: { labels: data.map(d => d.stat_date), datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Messages' } }, y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Users' } } } }
                });
            } else if (type === 'weekly') {
                const datasets = [
                    { label: 'Messages', data: data.map(d => d.total_messages), backgroundColor: 'rgba(102, 126, 234, 0.7)', yAxisID: 'y' }
                ];
                
                // Only show private messages if chat mode allows it
                if (window.chatMode !== 'public') {
                    datasets.push({ label: 'Private Messages', data: data.map(d => d.private_messages), backgroundColor: 'rgba(240, 147, 251, 0.7)', yAxisID: 'y' });
                }
                
                // Only show photos if enabled
                if (window.photosEnabled) {
                    datasets.push({ label: 'Photos', data: data.map(d => d.photo_uploads), backgroundColor: 'rgba(67, 233, 123, 0.7)', yAxisID: 'y' });
                }
                
                datasets.push(
                    { label: 'New Registrations', data: data.map(d => d.new_registrations), backgroundColor: 'rgba(250, 112, 154, 0.7)', yAxisID: 'y' },
                    { label: 'Active Users', data: data.map(d => d.active_users), backgroundColor: 'rgba(79, 172, 254, 0.7)', yAxisID: 'y1' },
                    { label: 'Guest Users', data: data.map(d => d.guest_users), backgroundColor: 'rgba(255, 167, 81, 0.7)', yAxisID: 'y1' },
                    { label: 'Peak Concurrent', data: data.map(d => d.peak_concurrent_users), backgroundColor: 'rgba(255, 107, 107, 0.7)', yAxisID: 'y1' }
                );
                if (window.radioEnabled) {
                    datasets.push({ label: 'üìª Listeners (avg)', data: data.map(d => d.radio_listeners_avg), backgroundColor: 'rgba(48, 207, 208, 0.7)', yAxisID: 'y1' });
                    datasets.push({ label: 'üìª Peak', data: data.map(d => d.radio_listeners_peak), backgroundColor: 'rgba(0, 180, 216, 0.7)', yAxisID: 'y1' });
                }
                window.statsChartInstance = new Chart(chartCtx, {
                    type: 'bar',
                    data: { labels: data.map(d => `Week ${d.stat_week}`), datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Messages' } }, y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Count' } } } }
                });
            } else if (type === 'monthly') {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const datasets = [
                    { label: 'Messages', data: data.map(d => d.total_messages), backgroundColor: 'rgba(102, 126, 234, 0.7)', yAxisID: 'y' }
                ];
                
                // Only show private messages if chat mode allows it
                if (window.chatMode !== 'public') {
                    datasets.push({ label: 'Private Messages', data: data.map(d => d.private_messages), backgroundColor: 'rgba(240, 147, 251, 0.7)', yAxisID: 'y' });
                }
                
                // Only show photos if enabled
                if (window.photosEnabled) {
                    datasets.push({ label: 'Photos', data: data.map(d => d.photo_uploads), backgroundColor: 'rgba(67, 233, 123, 0.7)', yAxisID: 'y' });
                }
                
                datasets.push(
                    { label: 'New Registrations', data: data.map(d => d.new_registrations), backgroundColor: 'rgba(250, 112, 154, 0.7)', yAxisID: 'y' },
                    { label: 'Active Users', data: data.map(d => d.active_users), backgroundColor: 'rgba(79, 172, 254, 0.7)', yAxisID: 'y1' },
                    { label: 'Guest Users', data: data.map(d => d.guest_users), backgroundColor: 'rgba(255, 167, 81, 0.7)', yAxisID: 'y1' },
                    { label: 'Peak Concurrent', data: data.map(d => d.peak_concurrent_users), backgroundColor: 'rgba(255, 107, 107, 0.7)', yAxisID: 'y1' }
                );
                if (window.radioEnabled) {
                    datasets.push({ label: 'üìª Listeners (avg)', data: data.map(d => d.radio_listeners_avg), backgroundColor: 'rgba(48, 207, 208, 0.7)', yAxisID: 'y1' });
                    datasets.push({ label: 'üìª Peak', data: data.map(d => d.radio_listeners_peak), backgroundColor: 'rgba(0, 180, 216, 0.7)', yAxisID: 'y1' });
                }
                window.statsChartInstance = new Chart(chartCtx, {
                    type: 'bar',
                    data: { labels: data.map(d => months[d.stat_month - 1]), datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Messages' } }, y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Count' } } } }
                });
            } else if (type === 'yearly') {
                const datasets = [
                    { label: 'Messages', data: data.map(d => d.total_messages), backgroundColor: 'rgba(102, 126, 234, 0.7)', yAxisID: 'y' }
                ];
                
                // Only show private messages if chat mode allows it
                if (window.chatMode !== 'public') {
                    datasets.push({ label: 'Private Messages', data: data.map(d => d.private_messages), backgroundColor: 'rgba(240, 147, 251, 0.7)', yAxisID: 'y' });
                }
                
                // Only show photos if enabled
                if (window.photosEnabled) {
                    datasets.push({ label: 'Photos', data: data.map(d => d.photo_uploads), backgroundColor: 'rgba(67, 233, 123, 0.7)', yAxisID: 'y' });
                }
                
                datasets.push(
                    { label: 'New Registrations', data: data.map(d => d.new_registrations), backgroundColor: 'rgba(250, 112, 154, 0.7)', yAxisID: 'y' },
                    { label: 'Active Users', data: data.map(d => d.active_users), backgroundColor: 'rgba(79, 172, 254, 0.7)', yAxisID: 'y1' },
                    { label: 'Guest Users', data: data.map(d => d.guest_users), backgroundColor: 'rgba(255, 167, 81, 0.7)', yAxisID: 'y1' },
                    { label: 'Peak Concurrent', data: data.map(d => d.peak_concurrent_users), backgroundColor: 'rgba(255, 107, 107, 0.7)', yAxisID: 'y1' }
                );
                if (window.radioEnabled) {
                    datasets.push({ label: 'üìª Listeners (avg)', data: data.map(d => d.radio_listeners_avg), backgroundColor: 'rgba(48, 207, 208, 0.7)', yAxisID: 'y1' });
                    datasets.push({ label: 'üìª Peak', data: data.map(d => d.radio_listeners_peak), backgroundColor: 'rgba(0, 180, 216, 0.7)', yAxisID: 'y1' });
                }
                window.statsChartInstance = new Chart(chartCtx, {
                    type: 'bar',
                    data: { labels: data.map(d => d.stat_year), datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Messages' } }, y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Count' } } } }
                });
            }
        }
        
        async function fetchStatsData(granularity, params = {}) {
            const queryString = new URLSearchParams(params).toString();
            const url = `/api/admin/stats.php?granularity=${granularity}&${queryString}`;
            
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to fetch statistics');
            }
            
            const result = await response.json();
            console.log('fetchStatsData result:', { granularity, result });
            
            // Store settings globally for conditional display
            if (result.radio_enabled !== undefined) {
                window.radioEnabled = result.radio_enabled;
            }
            if (result.chat_mode !== undefined) {
                window.chatMode = result.chat_mode;
            }
            if (result.photos_enabled !== undefined) {
                window.photosEnabled = result.photos_enabled;
            }
            return result;
        }

        // ========== Notifications System ==========
        let notificationsFilter = 'all';
        let notificationsStream = null;
        let notificationSound = null;

        async function refreshNotifications() {
            const unreadOnly = notificationsFilter === 'unread';
            const type = notificationsFilter === 'fake_user_dm' ? 'fake_user_dm' : null;

            try {
                const params = new URLSearchParams();
                if (unreadOnly) params.append('unread_only', 'true');
                if (type) params.append('type', type);

                const response = await fetch(`/api/admin/notifications.php?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch notifications');
                }

                const data = await response.json();

                if (data.success) {
                    renderNotifications(data.notifications);
                    updateNotificationBadge(data.unread_count);
                }
            } catch (error) {
                console.error('Error fetching notifications:', error);
                alert('Failed to load notifications');
            }
        }

        function renderNotifications(notifications) {
            const container = document.getElementById('notifications-list');

            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üîî</div>
                        <h3 style="margin-bottom: 8px; color: #6b7280;">No notifications ${notificationsFilter === 'unread' ? '(unread)' : notificationsFilter === 'fake_user_dm' ? '(fake user DMs)' : ''}</h3>
                        <p>You'll be notified here when users send DMs to fake users</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map(notification => {
                const timestamp = new Date(notification.created_at);
                const isUnread = !notification.is_read;
                const metadata = notification.metadata || {};

                return `
                    <div class="notification-item" style="background: ${isUnread ? '#eff6ff' : 'white'}; border: 2px solid ${isUnread ? '#667eea' : '#e5e7eb'}; border-radius: 8px; padding: 16px; display: flex; gap: 12px; align-items: start;">
                        <div style="font-size: 24px; flex-shrink: 0;">
                            ${notification.notification_type === 'fake_user_dm' ? 'üí¨' : 'üîî'}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                <h4 style="margin: 0; color: ${isUnread ? '#667eea' : '#374151'}; font-weight: 600;">
                                    ${escapeHtml(notification.title)}
                                    ${isUnread ? '<span style="background: #667eea; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-weight: 700;">NEW</span>' : ''}
                                </h4>
                                <span style="color: #9ca3af; font-size: 13px; white-space: nowrap; margin-left: 12px;">${formatTimeAgo(timestamp)}</span>
                            </div>
                            <p style="margin: 4px 0 8px 0; color: #6b7280; line-height: 1.4;">${escapeHtml(notification.message)}</p>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${notification.notification_type === 'fake_user_dm' && metadata.from_username ? `
                                    <button class="btn" onclick="viewUserDetails('${escapeHtml(metadata.from_username).replace(/'/g, "\\'")}');" style="padding: 6px 12px; font-size: 13px;">
                                        üëÅÔ∏è View Sender
                                    </button>
                                    <button class="btn" onclick="switchTab('impersonate'); setTimeout(() => loadImpersonateFromNotification('${escapeHtml(metadata.to_username).replace(/'/g, "\\'")}', '${escapeHtml(metadata.from_username).replace(/'/g, "\\'")}', ${notification.id}), 100);" style="padding: 6px 12px; font-size: 13px; background: #667eea; color: white;">
                                        üí¨ Reply
                                    </button>
                                ` : ''}
                                ${isUnread ? `
                                    <button class="btn" onclick="markNotificationRead(${notification.id})" style="padding: 6px 12px; font-size: 13px; background: #10b981; color: white;">
                                        ‚úì Mark Read
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function filterNotifications(filter) {
            notificationsFilter = filter;

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.getAttribute('data-filter') === filter) {
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#6b7280';
                    btn.classList.remove('active');
                }
            });

            refreshNotifications();
        }

        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch('/api/admin/notifications.php', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notification_id: notificationId })
                });

                if (!response.ok) throw new Error('Failed to mark notification as read');

                refreshNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllNotificationsRead() {
            if (!confirm('Mark all notifications as read?')) return;

            try {
                const response = await fetch('/api/admin/notifications.php', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mark_all_read: true })
                });

                if (!response.ok) throw new Error('Failed to mark all notifications as read');

                const data = await response.json();
                if (data.success) {
                    refreshNotifications();
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                alert('Failed to mark all notifications as read');
            }
        }

        async function clearReadNotifications() {
            if (!confirm('Delete all read notifications? This action cannot be undone.')) return;

            try {
                const response = await fetch('/api/admin/notifications.php', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ clear_read: true })
                });

                if (!response.ok) throw new Error('Failed to clear read notifications');

                const data = await response.json();
                if (data.success) {
                    refreshNotifications();
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error clearing read notifications:', error);
                alert('Failed to clear read notifications');
            }
        }

        async function connectNotificationsStream() {
            // Only connect if user has access to notifications
            if (currentUserRole !== 'root' && currentUserRole !== 'administrator' && currentUserRole !== 'owner') {
                return;
            }

            // Ensure we have auth token
            if (!authToken) {
                console.error('Cannot connect to notifications stream: No auth token');
                return;
            }

            // Close existing stream
            if (notificationsStream && notificationsStream.abort) {
                notificationsStream.abort();
            }

            // Create abort controller for this connection
            const abortController = new AbortController();
            notificationsStream = abortController;

            try {
                const response = await fetch('/api/admin/stream.php', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'text/event-stream'
                    },
                    signal: abortController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        console.log('Stream ended, reconnecting...');
                        setTimeout(connectNotificationsStream, 1000);
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer

                    let currentEvent = { type: 'message', data: '' };

                    for (const line of lines) {
                        if (line.startsWith('event:')) {
                            currentEvent.type = line.substring(6).trim();
                        } else if (line.startsWith('data:')) {
                            currentEvent.data += line.substring(5).trim();
                        } else if (line === '') {
                            // Empty line signals end of event
                            if (currentEvent.data) {
                                handleSSEEvent(currentEvent);
                            }
                            currentEvent = { type: 'message', data: '' };
                        }
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Stream connection aborted');
                    return;
                }
                console.error('Stream error:', error);
                setTimeout(connectNotificationsStream, 5000);
            }
        }

        function handleSSEEvent(event) {
            try {
                if (event.type === 'notification_count') {
                    const data = JSON.parse(event.data);
                    updateNotificationBadge(data.unread_count);
                } else if (event.type === 'notification') {
                    const data = JSON.parse(event.data);

                    // Check if admin is currently viewing this conversation in impersonate tab
                    const impersonateTab = document.getElementById('impersonate-tab');
                    const isViewingConversation = impersonateTab && 
                                                 impersonateTab.classList.contains('active') &&
                                                 currentImpersonateAs === data.to_username &&
                                                 currentSender === data.from_username;

                    // If already viewing this conversation, play sound but skip visual notifications
                    if (isViewingConversation) {
                        // Play sound to indicate new message
                        playNotificationSound();
                        // Silently mark notification as read since admin is already viewing it
                        markNotificationRead(data.id);
                        return; // Skip visual notification alerts
                    }

                    // Update badge
                    const badge = document.getElementById('notification-badge');
                    let currentCount = parseInt(badge.textContent) || 0;
                    updateNotificationBadge(currentCount + 1);

                    // Always refresh notifications to update the list in real-time
                    refreshNotifications();

                    // Play sound
                    playNotificationSound();

                    // Show browser notification if permission granted
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('New Admin Notification', {
                            body: data.from_username + ' ‚Üí ' + data.to_username + ': ' + data.message_preview.substring(0, 100),
                            icon: '/favicon.ico',
                            tag: 'admin-notification-' + data.id
                        });
                    }
                } else if (event.type === 'reconnect') {
                    console.log('Server requested reconnect');
                    if (notificationsStream && notificationsStream.abort) {
                        notificationsStream.abort();
                    }
                    setTimeout(connectNotificationsStream, 1000);
                } else if (event.type === 'error') {
                    const errorData = JSON.parse(event.data);
                    console.error('Server error:', errorData);
                }
            } catch (error) {
                console.error('Error handling SSE event:', error);
            }
        }

        function playNotificationSound() {
            try {
                // Create a simple notification beep using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.error('Failed to play notification sound:', error);
            }
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return date.toLocaleDateString();
        }

        async function loadImpersonateFromNotification(fakeUsername, senderUsername, notificationId) {
            try {
                // First, make sure impersonate conversations are loaded
                if (!impersonateData || !impersonateData.conversations[fakeUsername]) {
                    await refreshImpersonateConversations();
                }
                
                // Now set the select dropdown and load
                const impersonateSelect = document.getElementById('impersonate-select');
                if (impersonateSelect) {
                    impersonateSelect.value = fakeUsername;
                    currentImpersonateAs = fakeUsername;
                    
                    // Load conversation list for this fake user
                    loadImpersonateConversation();
                    
                    // Then select the specific sender after a small delay
                    setTimeout(() => {
                        selectSender(fakeUsername, senderUsername);
                    }, 200);
                }
                
                // Mark notification as read if provided
                if (notificationId) {
                    markNotificationRead(notificationId);
                }
            } catch (error) {
                console.error('Failed to load impersonate from notification:', error);
            }
        }

        // Request notification permission on page load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // URL Routing for Impersonate Tab
        function updateImpersonateURL(fakeUser, senderUsername) {
            // Update URL hash without triggering hashchange event initially
            const url = new URL(window.location);
            url.hash = `impersonate/${encodeURIComponent(fakeUser)}/${encodeURIComponent(senderUsername)}`;
            history.pushState({ 
                tab: 'impersonate',
                fakeUser: fakeUser,
                senderUsername: senderUsername
            }, '', url);
        }

        function parseImpersonateURL() {
            // Parse hash like #impersonate/fakeuser or #impersonate/fakeuser/sender
            const hash = window.location.hash.slice(1); // Remove #
            const parts = hash.split('/');
            
            if (parts[0] === 'impersonate') {
                if (parts.length >= 3) {
                    // Full URL with sender
                    return {
                        fakeUser: decodeURIComponent(parts[1]),
                        senderUsername: decodeURIComponent(parts[2])
                    };
                } else if (parts.length === 2) {
                    // Just fake user, no sender
                    return {
                        fakeUser: decodeURIComponent(parts[1]),
                        senderUsername: null
                    };
                }
            }
            return null;
        }

        function restoreImpersonateState() {
            const state = parseImpersonateURL();
            if (state && state.fakeUser) {
                // Make sure impersonate data is loaded
                if (impersonateData && impersonateData.conversations && impersonateData.conversations[state.fakeUser]) {
                    // Set the select dropdown and open the conversation
                    const select = document.getElementById('impersonate-select');
                    if (select) {
                        select.value = state.fakeUser;
                        currentImpersonateAs = state.fakeUser;
                        // Load the conversation list for this fake user
                        loadImpersonateConversation();
                        
                        // If there's a specific sender, select them
                        if (state.senderUsername) {
                            setTimeout(() => {
                                selectSender(state.fakeUser, state.senderUsername);
                            }, 100);
                        }
                    }
                }
            }
        }

        // Handle hash changes (back/forward button navigation)
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.slice(1);
            
            // If it's an impersonate route with user/sender info
            if (hash.startsWith('impersonate/')) {
                switchTab('impersonate', false); // Switch to impersonate tab without updating history
                
                // Wait a moment for the tab to be visible, then restore state
                setTimeout(() => {
                    // Reload conversations if needed
                    if (!impersonateData) {
                        refreshImpersonateConversations().then(() => {
                            restoreImpersonateState();
                        });
                    } else {
                        restoreImpersonateState();
                    }
                }, 200);
            } else if (hash) {
                // Normal tab hash
                switchTab(hash, false);
            }
        });

        // Check URL on page load
        window.addEventListener('load', function() {
            const hash = window.location.hash.slice(1);
            
            if (hash) {
                // If it's an impersonate route
                if (hash.startsWith('impersonate/')) {
                    switchTab('impersonate', false);
                    
                    // Load conversations and restore state
                    setTimeout(() => {
                        refreshImpersonateConversations().then(() => {
                            restoreImpersonateState();
                        });
                    }, 500);
                } else {
                    // Normal tab
                    switchTab(hash, false);
                }
            }
        });

    </script>
    <!-- Ensure countries.js is loaded first -->
    <script src="/js/countries.js"></script>
    <script src="/js/emojis.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeFakeUserForm();
        });
    </script>
</body>
</html>
